# E2Eテストレポートガイド

このドキュメントでは、Allure Reportフレームワークで生成されるE2Eセキュリティテストレポートの読み方を説明します。

## 目次

1. [概要](#概要)
2. [レポートURL](#レポートurl)
3. [概要ページ](#概要ページ)
4. [ビヘイビアページ](#ビヘイビアページ)
5. [テストケース詳細](#テストケース詳細)
6. [ハイライト機能](#ハイライト機能)
7. [グラフページ](#グラフページ)
8. [テストカテゴリ](#テストカテゴリ)

---

## 概要

E2Eセキュリティテストレポートは、Falco nginxプラグインのセキュリティ検出能力を包括的に可視化します。各テスト実行では、12のカテゴリにわたる**300の攻撃パターン**を実行し、以下を示す詳細なレポートを生成します：

- 検出率（目標：100%）
- カテゴリ別の内訳
- 個別テストケースの詳細
- 実行回数ごとのトレンド分析

---

## レポートURL

E2Eテストレポートは以下のURLで確認できます：

| URL | 説明 |
|-----|------|
| **https://takaosgb3.github.io/falco-plugin-nginx/e2e-report/latest/** | 最新レポート（常に最新の実行結果を表示） |
| **https://takaosgb3.github.io/falco-plugin-nginx/e2e-report/{run_number}/** | 特定の実行（例：run #26） |

### 例

- **最新**: https://takaosgb3.github.io/falco-plugin-nginx/e2e-report/latest/
- **Run #26**: https://takaosgb3.github.io/falco-plugin-nginx/e2e-report/26/

---

## 概要ページ

![概要ページ](images/e2e-report-overview.png)

概要ページでは、テスト実行の高レベルなサマリーを提供します：

### 主要メトリクス

| セクション | 説明 |
|------------|------|
| **Test Cases** | 実行されたテストパターンの総数（300） |
| **Success Rate** | 検出されたパターンの割合（100% = すべて検出） |
| **Suites** | テストスイートの構成 |
| **Environment** | 実行環境の詳細 |

### 環境情報

| フィールド | 説明 |
|------------|------|
| Platform | オペレーティングシステム（ubuntu-24.04） |
| Falco.Version | 使用されたFalcoのバージョン（0.42.1） |
| Plugin | プラグイン名（falco-plugin-nginx） |
| nginx.Version | nginxのバージョン（1.24.0） |
| k6.Version | k6負荷テストツールのバージョン |

### トレンドグラフ

右パネルには、複数の実行回にわたるテスト結果を表示する**Trend**グラフが表示されます。これにより以下を追跡できます：
- 検出率の一貫性
- ルール変更の影響
- 過去のパフォーマンス

### 実行者（Executors）

テストを実行したCI/CDシステム（GitHub Actions）が、ワークフロー実行へのリンクとともに表示されます。

---

## ビヘイビアページ

![ビヘイビアページ](images/e2e-report-behaviors.png)

ビヘイビアページでは、テストを**Epic > Feature > Story**の階層で整理しています：

### カテゴリ別内訳

| カテゴリ | パターン数 | 説明 |
|----------|------------|------|
| **SQLI** | 79 | SQLインジェクション攻撃 |
| **XSS** | 56 | クロスサイトスクリプティング攻撃 |
| **PATH** | 50 | パストラバーサル攻撃 |
| **CMDINJ** | 55 | コマンドインジェクション攻撃 |
| **LDAP** | 10 | LDAPインジェクション攻撃 |
| **SSTI** | 10 | サーバーサイドテンプレートインジェクション |
| **NOSQL** | 7 | NoSQLインジェクション攻撃 |
| **XXE** | 8 | XML外部エンティティ攻撃 |
| **XPATH** | 5 | XPathインジェクション攻撃 |
| **GRAPHQL** | 5 | GraphQLインジェクション攻撃 |
| **API** | 5 | APIセキュリティ攻撃 |
| **OTHER** | 10 | その他の攻撃パターン |

### ステータス表示

- **緑色（300）**：成功したテスト
- **赤色（0）**：失敗したテスト
- **オレンジ色（0）**：壊れたテスト
- **灰色（0）**：スキップされたテスト

カテゴリをクリックすると、個別のテストパターンが展開表示されます。

---

## テストケース詳細

![テストケース詳細](images/e2e-report-test-detail.png)

各テストケースでは、攻撃パターンと検出結果に関する詳細情報を提供します：

### 攻撃パターン情報

| フィールド | 説明 | 例 |
|------------|------|-----|
| Pattern ID | 一意の識別子 | `SQLI_TIME_001` |
| Name | わかりやすい名前 | "Basic MySQL SLEEP function" |
| Category | 攻撃カテゴリ | SQLI |
| Subcategory | 具体的な攻撃タイプ | time_based_blind |
| Severity | リスクレベル | HIGH |

### 攻撃詳細

| フィールド | 説明 | 例 |
|------------|------|-----|
| Payload | 生の攻撃文字列 | `SLEEP(5)` |
| Encoded | URLエンコード版 | `SLEEP%285%29` |
| Expected Detection | 検出されるべきか | Yes |

### テスト実行結果

| フィールド | 説明 | 例 |
|------------|------|-----|
| Status | テスト結果 | PASSED |
| Detection Count | 検出数 / 期待数 | 1 / 1 |
| Latency | 検出までの時間 | 約22000ms |
| Timestamp | 検出時刻 | 13:45:55.000 UTC |

### 検出証跡

攻撃を検出した実際のFalcoログエントリ：

```
13:45:55.000000000: Critical [NGINX SQLi] Time-based Blind SQL Injection
test_id=SQLI_TIME_001-1765115155414-grzegk
pattern_id=SQLI_TIME_001
uri=/?q=SLEEP%285%29
client=127.0.0.1
method=GET
```

### 実行ステップ

各テストには、添付ファイル付きの実行ステップが含まれます：

1. **k6 Test Execution Result** - 生のテスト実行データ（JSON）
2. **Log Files** - nginxアクセスログとFalcoログのスニペット
3. **Detection Evidence (Highlighted)** - キーワードハイライト付きHTMLビュー
4. **Verification Result** - 成功/失敗の判定

---

## ハイライト機能

![ハイライト機能](images/e2e-report-highlight.png)

**Detection Evidence (Highlighted)** 添付ファイルでは、**蛍光イエローのハイライト**を使用して、ログエントリ内の攻撃ペイロードを見やすく表示します。

### 動作の仕組み

1. 攻撃パターンからキーワード（ペイロードとエンコード値）を抽出
2. これらのキーワードを`<mark>`タグでハイライト
3. 背景色：`#FFFF00`（蛍光イエロー）

### 例

上のスクリーンショットでは、`SLEEP%285%29`が黄色でハイライトされており、Falcoログエントリ内の攻撃ペイロードを簡単に見つけることができます。

### メリット

- **即座に識別**：検出をトリガーした内容を即座に確認
- **視覚的な確認**：正しいパターンがマッチしたことを確認
- **レビュー時間の短縮**：キーワードを手動で検索する必要なし

---

## グラフページ

![グラフページ](images/e2e-report-graphs.png)

グラフページでは、視覚的な分析を提供します：

### ステータス（円グラフ）

テスト結果の分布を表示：
- **緑色**：成功
- **赤色**：失敗
- **オレンジ色**：壊れた
- **灰色**：スキップ
- **紫色**：不明

### 重大度（棒グラフ）

重大度レベル別のテスト数を表示：
- blocker
- critical（ほとんどのE2Eテスト）
- normal
- minor
- trivial

### 所要時間（ヒストグラム）

テスト実行時間の分布を表示。ほとんどのテストは1〜2msで完了します。

### 所要時間トレンド

実行回数ごとの総テスト時間を示す折れ線グラフ。パフォーマンスの低下を特定するのに役立ちます。

### トレンド

実行回数ごとの成功/失敗件数を示す積み上げ棒グラフ。時間の経過に伴う安定性を示します。

### リトライトレンド

実行回数ごとのリトライパターンを表示（理想的には0で平坦）。

### カテゴリトレンド

実行回数ごとのカテゴリ別結果を表示。

---

## テストカテゴリ

### SQLインジェクション（SQLI）- 79パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| SQLI_TIME_001-025 | 時間ベースブラインド | SLEEP(), BENCHMARK(), WAITFOR DELAY, pg_sleep |
| SQLI_BOOL_001-025 | ブール値ベースブラインド | OR '1'='1, AND '1'='1, 各種バイパス手法 |
| SQLI_ERR_001-029 | エラーベース | EXTRACTVALUE, UPDATEXML, エラーメッセージ |

**検出ルール**：各種SQL Injectionルール

### クロスサイトスクリプティング（XSS）- 56パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| XSS_REFL_001-056 | 反射型/DOM/格納型XSS | script, img onerror, svg onload, iframe など |

**検出ルール**：XSS検出ルール

### パストラバーサル（PATH）- 50パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| PATH_001-050 | LFI/RFI/ディレクトリ | ../etc/passwd, ....//....// , 各種エンコーディング |

**検出ルール**：Path Traversalルール

### コマンドインジェクション（CMDINJ）- 55パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| CMDINJ_001-055 | シェル/OSコマンド | ;ls, |cat, \`whoami\`, 各種バイパス手法 |

**検出ルール**：Command Injectionルール

### LDAPインジェクション（LDAP）- 10パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| LDAP_001-010 | LDAPクエリ操作 | )(uid=*, |(cn=admin) |

**検出ルール**：LDAP Injectionルール

### サーバーサイドテンプレートインジェクション（SSTI）- 10パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| SSTI_001-010 | テンプレートインジェクション | {{7*7}}, ${7*7}, 各種テンプレート構文 |

**検出ルール**：SSTI検出ルール

### NoSQLインジェクション（NOSQL）- 7パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| NOSQL_001-007 | NoSQL/MongoDB | $where, $regex, $gt |

**検出ルール**：NoSQL Injectionルール

### XML外部エンティティ（XXE）- 8パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| XXE_001-008 | XXE | <!DOCTYPE, <!ENTITY, SYSTEM参照 |

**検出ルール**：XXE検出ルール

### XPathインジェクション（XPATH）- 5パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| XPATH_001-005 | XPathクエリ | ' or '1'='1, //*, ancestor::* |

**検出ルール**：XPath Injectionルール

### GraphQLインジェクション（GRAPHQL）- 5パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| GRAPHQL_001-005 | GraphQL攻撃 | __schema, イントロスペクションクエリ |

**検出ルール**：GraphQL Injectionルール

### APIセキュリティ（API）- 5パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| API_001-005 | BOLA/認証バイパス | オブジェクト参照操作、認証バイパス |

**検出ルール**：API Securityルール

### その他（OTHER）- 10パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| OTHER_001-010 | 追加パターン | 各種セキュリティパターン |

**検出ルール**：その他検出ルール

---

## クイックリファレンス

### 結果の解釈

| 指標 | 意味 | アクション |
|------|------|----------|
| 100%成功 | すべての攻撃が検出された | 良好 - ルールが正常に動作 |
| 100%未満 | 一部の攻撃が見逃された | 失敗したテストを確認し、ルールを更新 |
| カテゴリ別の失敗 | 特定カテゴリの問題 | そのカテゴリのルール改善に注力 |

### よくある問題

| 問題 | 原因 | 解決策 |
|------|------|--------|
| 低い検出率 | ルールがマッチしない | ルール条件とフィールド名を確認 |
| 高いレイテンシ | ログ処理が遅い | Falcoのパフォーマンスとログ量を確認 |
| 証跡がない | ログローテーション/切り詰め | ログ保持期間を延長 |

### ヘルプ

- **リポジトリ**：https://github.com/takaosgb3/falco-plugin-nginx
- **Issues**：https://github.com/takaosgb3/falco-plugin-nginx/issues
- **ワークフロー**：`.github/workflows/e2e-test.yml`

---

## バージョン履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0.0 | 2025-12-07 | 初版リリース |

---

*このドキュメントは[falco-plugin-nginx](https://github.com/takaosgb3/falco-plugin-nginx)プロジェクトの一部です。*
