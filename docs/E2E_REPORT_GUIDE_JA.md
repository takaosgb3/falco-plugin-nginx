# E2Eテストレポートガイド

このドキュメントでは、Allure Reportフレームワークで生成されるE2Eセキュリティテストレポートの読み方を説明します。

## 目次

1. [概要](#概要)
2. [レポートURL](#レポートurl)
3. [概要ページ](#概要ページ)
4. [ビヘイビアページ](#ビヘイビアページ)
5. [テストケース詳細](#テストケース詳細)
6. [ハイライト機能](#ハイライト機能)
7. [グラフページ](#グラフページ)
8. [テストカテゴリ](#テストカテゴリ)

---

## 概要

E2Eセキュリティテストレポートは、Falco nginxプラグインのセキュリティ検出能力を包括的に可視化します。各テスト実行では、5つのカテゴリにわたる**65の攻撃パターン**を実行し、以下を示す詳細なレポートを生成します：

- 検出率（目標：100%）
- カテゴリ別の内訳
- 個別テストケースの詳細
- 実行回数ごとのトレンド分析

---

## レポートURL

最新のE2Eテストレポートは以下のURLで確認できます：

**https://takaosgb3.github.io/falco-plugin-nginx/e2e-report/{run_number}/**

例：
- Run #26: https://takaosgb3.github.io/falco-plugin-nginx/e2e-report/26/

---

## 概要ページ

![概要ページ](images/e2e-report-overview.png)

概要ページでは、テスト実行の高レベルなサマリーを提供します：

### 主要メトリクス

| セクション | 説明 |
|------------|------|
| **Test Cases** | 実行されたテストパターンの総数（65） |
| **Success Rate** | 検出されたパターンの割合（100% = すべて検出） |
| **Suites** | テストスイートの構成 |
| **Environment** | 実行環境の詳細 |

### 環境情報

| フィールド | 説明 |
|------------|------|
| Platform | オペレーティングシステム（ubuntu-24.04） |
| Falco.Version | 使用されたFalcoのバージョン（0.42.1） |
| Plugin | プラグイン名（falco-plugin-nginx） |
| nginx.Version | nginxのバージョン（1.24.0） |
| k6.Version | k6負荷テストツールのバージョン |

### トレンドグラフ

右パネルには、複数の実行回にわたるテスト結果を表示する**Trend**グラフが表示されます。これにより以下を追跡できます：
- 検出率の一貫性
- ルール変更の影響
- 過去のパフォーマンス

### 実行者（Executors）

テストを実行したCI/CDシステム（GitHub Actions）が、ワークフロー実行へのリンクとともに表示されます。

---

## ビヘイビアページ

![ビヘイビアページ](images/e2e-report-behaviors.png)

ビヘイビアページでは、テストを**Epic > Feature > Story**の階層で整理しています：

### カテゴリ別内訳

| カテゴリ | パターン数 | 説明 |
|----------|------------|------|
| **SQLI** | 19 | SQLインジェクション攻撃 |
| **XSS** | 11 | クロスサイトスクリプティング攻撃 |
| **PATH** | 20 | パストラバーサル攻撃 |
| **CMDINJ** | 10 | コマンドインジェクション攻撃 |
| **OTHER** | 5 | NoSQL/MongoDBインジェクション攻撃 |

### ステータス表示

- **緑色（65）**：成功したテスト
- **赤色（0）**：失敗したテスト
- **オレンジ色（0）**：壊れたテスト
- **灰色（0）**：スキップされたテスト

カテゴリをクリックすると、個別のテストパターンが展開表示されます。

---

## テストケース詳細

![テストケース詳細](images/e2e-report-test-detail.png)

各テストケースでは、攻撃パターンと検出結果に関する詳細情報を提供します：

### 攻撃パターン情報

| フィールド | 説明 | 例 |
|------------|------|-----|
| Pattern ID | 一意の識別子 | `SQLI_TIME_001` |
| Name | わかりやすい名前 | "Basic MySQL SLEEP function" |
| Category | 攻撃カテゴリ | SQLI |
| Subcategory | 具体的な攻撃タイプ | time_based_blind |
| Severity | リスクレベル | HIGH |

### 攻撃詳細

| フィールド | 説明 | 例 |
|------------|------|-----|
| Payload | 生の攻撃文字列 | `SLEEP(5)` |
| Encoded | URLエンコード版 | `SLEEP%285%29` |
| Expected Detection | 検出されるべきか | Yes |

### テスト実行結果

| フィールド | 説明 | 例 |
|------------|------|-----|
| Status | テスト結果 | PASSED |
| Detection Count | 検出数 / 期待数 | 1 / 1 |
| Latency | 検出までの時間 | 約22000ms |
| Timestamp | 検出時刻 | 13:45:55.000 UTC |

### 検出証跡

攻撃を検出した実際のFalcoログエントリ：

```
13:45:55.000000000: Critical [NGINX SQLi] Time-based Blind SQL Injection
test_id=SQLI_TIME_001-1765115155414-grzegk
pattern_id=SQLI_TIME_001
uri=/?q=SLEEP%285%29
client=127.0.0.1
method=GET
```

### 実行ステップ

各テストには、添付ファイル付きの実行ステップが含まれます：

1. **k6 Test Execution Result** - 生のテスト実行データ（JSON）
2. **Log Files** - nginxアクセスログとFalcoログのスニペット
3. **Detection Evidence (Highlighted)** - キーワードハイライト付きHTMLビュー
4. **Verification Result** - 成功/失敗の判定

---

## ハイライト機能

![ハイライト機能](images/e2e-report-highlight.png)

**Detection Evidence (Highlighted)** 添付ファイルでは、**蛍光イエローのハイライト**を使用して、ログエントリ内の攻撃ペイロードを見やすく表示します。

### 動作の仕組み

1. 攻撃パターンからキーワード（ペイロードとエンコード値）を抽出
2. これらのキーワードを`<mark>`タグでハイライト
3. 背景色：`#FFFF00`（蛍光イエロー）

### 例

上のスクリーンショットでは、`SLEEP%285%29`が黄色でハイライトされており、Falcoログエントリ内の攻撃ペイロードを簡単に見つけることができます。

### メリット

- **即座に識別**：検出をトリガーした内容を即座に確認
- **視覚的な確認**：正しいパターンがマッチしたことを確認
- **レビュー時間の短縮**：キーワードを手動で検索する必要なし

---

## グラフページ

![グラフページ](images/e2e-report-graphs.png)

グラフページでは、視覚的な分析を提供します：

### ステータス（円グラフ）

テスト結果の分布を表示：
- **緑色**：成功
- **赤色**：失敗
- **オレンジ色**：壊れた
- **灰色**：スキップ
- **紫色**：不明

### 重大度（棒グラフ）

重大度レベル別のテスト数を表示：
- blocker
- critical（ほとんどのE2Eテスト）
- normal
- minor
- trivial

### 所要時間（ヒストグラム）

テスト実行時間の分布を表示。ほとんどのテストは1〜2msで完了します。

### 所要時間トレンド

実行回数ごとの総テスト時間を示す折れ線グラフ。パフォーマンスの低下を特定するのに役立ちます。

### トレンド

実行回数ごとの成功/失敗件数を示す積み上げ棒グラフ。時間の経過に伴う安定性を示します。

### リトライトレンド

実行回数ごとのリトライパターンを表示（理想的には0で平坦）。

### カテゴリトレンド

実行回数ごとのカテゴリ別結果を表示。

---

## テストカテゴリ

### SQLインジェクション（SQLI）- 19パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| SQLI_TIME_001-015 | 時間ベースブラインド | SLEEP(), BENCHMARK(), WAITFOR DELAY |
| SQLI_BOOL_001-004 | ブール値ベースブラインド | OR '1'='1, AND '1'='1 |

**検出ルール**：`[NGINX SQLi] Time-based Blind SQL Injection`

### クロスサイトスクリプティング（XSS）- 11パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| XSS_REFL_001-011 | 反射型XSS | script, img onerror, svg onload, iframe など |

**検出ルール**：`[NGINX XSS] Reflected Cross-Site Scripting`

### パストラバーサル（PATH）- 20パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| PATH_ABS_001-020 | 絶対/相対パス | ../etc/passwd, ....//....// |

**検出ルール**：`[NGINX Path] Path Traversal Attempt`

### コマンドインジェクション（CMDINJ）- 10パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| CMDINJ_SHELL_001-010 | シェルコマンド | ;ls, |cat, \`whoami\` |

**検出ルール**：`[NGINX CMDi] Command Injection Attempt`

### その他（OTHER）- 5パターン

| パターンID | タイプ | 説明 |
|------------|--------|------|
| OTHER_NOSQL_001-005 | NoSQLインジェクション | MongoDB $where, $regex |

**検出ルール**：`[NGINX NoSQL] MongoDB Injection Attempt`

---

## クイックリファレンス

### 結果の解釈

| 指標 | 意味 | アクション |
|------|------|----------|
| 100%成功 | すべての攻撃が検出された | 良好 - ルールが正常に動作 |
| 100%未満 | 一部の攻撃が見逃された | 失敗したテストを確認し、ルールを更新 |
| カテゴリ別の失敗 | 特定カテゴリの問題 | そのカテゴリのルール改善に注力 |

### よくある問題

| 問題 | 原因 | 解決策 |
|------|------|--------|
| 低い検出率 | ルールがマッチしない | ルール条件とフィールド名を確認 |
| 高いレイテンシ | ログ処理が遅い | Falcoのパフォーマンスとログ量を確認 |
| 証跡がない | ログローテーション/切り詰め | ログ保持期間を延長 |

### ヘルプ

- **リポジトリ**：https://github.com/takaosgb3/falco-plugin-nginx
- **Issues**：https://github.com/takaosgb3/falco-plugin-nginx/issues
- **ワークフロー**：`.github/workflows/e2e-test.yml`

---

## バージョン履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0.0 | 2025-12-07 | 初版リリース |

---

*このドキュメントは[falco-plugin-nginx](https://github.com/takaosgb3/falco-plugin-nginx)プロジェクトの一部です。*
