# =============================================================================
# nginx_rules.yaml - Falco Rules for NGINX Plugin
# =============================================================================
# Version: 1.4.2
# Generated: 2025-12-06
# Source: E2E tested rules (65/65 patterns, 100% detection rate)
#
# This file is auto-generated from:
#   - advanced_sqli_enhanced.yaml
#   - advanced_xss_enhanced.yaml
#   - advanced_traversal_enhanced.yaml
#   - advanced_cmdi_enhanced.yaml
#   - advanced_emerging_enhanced.yaml
#
# DO NOT EDIT MANUALLY - Changes will be overwritten
# To modify rules, edit source files in terraform/k6-e2e/rules/
# =============================================================================


# ==============================================================================
# SQL Injection Detection Rules (from advanced_sqli_enhanced.yaml)
# ==============================================================================

# rules/advanced_sqli_enhanced.yaml
# Advanced SQL Injection Detection Rules for Falco
# Refactored: 2025-10-22 - Pattern #A214 fix (Macro-Only Hierarchical Approach)
# Optimized: 2025-11-26 - Pattern #A300 fix (icontains optimization per falco-plugin-rules.md v1.1.0)
#
# CHANGES:
# - Removed all list definitions (pmatch operator does not support nginx.request_uri)
# - Replaced lists with hierarchical macro structure using contains operators
# - Reduced condition complexity through macro nesting
# - Expected to resolve Pattern #A214 detection failure
#
# OPTIMIZATION (Pattern #A300):
# - Replaced redundant contains with icontains for pure alphabetic keywords
# - Maintained contains for: Base64, URL-encoded hex, numeric patterns, DB symbols
# - Reference: docs/development/best-practices/falco-plugin-rules.md v1.1.0
#
# This ruleset detects sophisticated SQL injection attacks including:
# - Time-based blind SQL injection
# - Boolean-based blind SQL injection
# - Error-based SQL injection

# ====================================
# MACROS - Time-based SQL Injection (Level 1)
# ====================================

# Pattern #A300: Optimized - SLEEP/sleep/pg_sleep merged to icontains
# URL-encoded patterns (%28) remain as contains
- macro: contains_sleep_keywords
  condition: >
    (nginx.request_uri icontains "sleep" or
     nginx.request_uri icontains "pg_sleep" or
     nginx.request_uri contains "SLEEP%28" or
     nginx.request_uri contains "sleep%28" or
     nginx.request_uri contains "pg_sleep%28" or
     nginx.request_uri contains "PG_SLEEP%28")

# Pattern #A300: Optimized - WAITFOR/BENCHMARK merged to icontains
# URL-encoded patterns remain as contains
- macro: contains_waitfor_keywords
  condition: >
    (nginx.request_uri icontains "waitfor" or
     nginx.request_uri icontains "benchmark" or
     nginx.request_uri contains "WAITFOR%20DELAY" or
     nginx.request_uri contains "WAITFOR+DELAY" or
     nginx.request_uri contains "BENCHMARK%28")

# Pattern #A300: Optimized - dbms_pipe merged to icontains
- macro: contains_dbms_pipe_keywords
  condition: >
    (nginx.request_uri icontains "dbms_pipe")

# Time delay patterns - contains maintained (contains time strings and URL-encoded)
- macro: contains_time_delay_patterns
  condition: >
    (nginx.request_uri contains "'00:00:0" or
     nginx.request_uri contains "'0:0:" or
     nginx.request_uri contains "%2700:00:0" or
     nginx.request_uri contains "%270:0:" or
     nginx.request_uri contains "THEN%20SLEEP" or
     nginx.request_uri contains "THEN SLEEP" or
     nginx.request_uri contains "ELSE%20SLEEP" or
     nginx.request_uri contains "ELSE SLEEP")

# URL-encoded time keywords - contains maintained (hex patterns)
- macro: contains_encoded_time_keywords
  condition: (nginx.request_uri contains "%53%4C%45%45%50" or nginx.request_uri contains "%73%6C%65%65%70" or nginx.request_uri contains "%57%41%49%54%46%4F%52")

# Pattern #A299 fix: Base64-encoded time-based SQL injection patterns
# Base64 patterns - contains maintained (case-sensitive encoding)
- macro: contains_base64_time_keywords
  condition: (nginx.request_uri contains "cGdfc2xlZXAo" or nginx.request_uri contains "U0xFRVAo" or nginx.request_uri contains "c2xlZXAo" or nginx.request_uri contains "V0FJVEZPUg" or nginx.request_uri contains "QkVOQ0hNQVJL")

# Pattern #A300: Optimized - CASE/WHEN/SELECT merged to icontains
- macro: contains_time_conditional_patterns
  condition: >
    ((nginx.request_uri icontains "case" and nginx.request_uri icontains "when") or
     (nginx.request_uri contains "CASE%20WHEN") or
     (nginx.request_uri contains "CASE+WHEN") or
     (nginx.request_uri icontains "select" and nginx.request_uri icontains "delay"))

# ====================================
# MACROS - Time-based SQL Injection (Level 2: Combined)
# ====================================

# Pattern #A299 fix: Added contains_base64_time_keywords to detect Base64-encoded time-based SQLi
# Pattern #A304: REMOVED single "%28" (just opening paren) - causes false positives
# Opening parenthesis is covered by function patterns like SLEEP%28, BENCHMARK%28
- macro: sqli_time_based_pattern
  condition: (contains_sleep_keywords or contains_waitfor_keywords or contains_dbms_pipe_keywords or contains_time_delay_patterns or contains_encoded_time_keywords or contains_base64_time_keywords or contains_time_conditional_patterns)

# ====================================
# MACROS - Boolean-based SQL Injection (Level 1)
# ====================================

# Boolean comparisons - contains maintained (contains = and numeric patterns)
- macro: contains_boolean_comparisons
  condition: (nginx.request_uri contains "AND%201%3D1" or nginx.request_uri contains "AND 1=1" or nginx.request_uri contains "AND%201%3D2" or nginx.request_uri contains "AND 1=2" or nginx.request_uri contains "AND%20'a'%3D'a'" or nginx.request_uri contains "AND 'a'='a'" or nginx.request_uri contains "AND%20'a'%3D'b'" or nginx.request_uri contains "AND 'a'='b'" or nginx.request_uri contains "AND+1=1" or nginx.request_uri contains "AND+1=2" or nginx.request_uri contains "AND/**/1=1" or nginx.request_uri contains "AND/**/1=2")

# Pattern #A300: Optimized - SUBSTRING/ASCII/CHAR etc. merged to icontains
# URL-encoded patterns (%28) remain as contains
- macro: contains_boolean_functions
  condition: >
    (nginx.request_uri icontains "substring" or
     nginx.request_uri icontains "substr" or
     nginx.request_uri icontains "mid" or
     nginx.request_uri icontains "ascii" or
     nginx.request_uri icontains "ord" or
     nginx.request_uri icontains "char" or
     nginx.request_uri contains "SUBSTRING%28" or
     nginx.request_uri contains "substring%28" or
     nginx.request_uri contains "SUBSTR%28" or
     nginx.request_uri contains "MID%28" or
     nginx.request_uri contains "ASCII%28" or
     nginx.request_uri contains "ascii%28" or
     nginx.request_uri contains "ORD%28" or
     nginx.request_uri contains "CHAR%28")

# CASE WHEN patterns - contains maintained (URL-encoded and special chars)
- macro: contains_case_when_patterns
  condition: (nginx.request_uri contains "CASE%20WHEN" or nginx.request_uri contains "CASE WHEN" or nginx.request_uri contains "CASE+WHEN" or nginx.request_uri contains "CASE/**/WHEN")

# Pattern #A300: Optimized - EXISTS merged to icontains
# URL-encoded patterns remain as contains
- macro: contains_exists_patterns
  condition: >
    (nginx.request_uri icontains "exists" or
     nginx.request_uri contains "NOT%20EXISTS" or
     nginx.request_uri contains "NOT EXISTS" or
     nginx.request_uri contains "NOT+EXISTS" or
     nginx.request_uri contains "EXISTS%28" or
     nginx.request_uri contains "exists%28")

# IF patterns - Pattern #A304: REMOVED single "IF" - causes false positives (notify, identifier, etc.)
# Only match IF when followed by function syntax (parenthesis)
- macro: contains_if_patterns
  condition: >
    (nginx.request_uri contains "IF(" or
     nginx.request_uri contains "IIF(" or
     nginx.request_uri contains "IF%28" or
     nginx.request_uri contains "IIF%28")

# information_schema patterns - icontains for alphabetic part
- macro: contains_info_schema_patterns
  condition: >
    (nginx.request_uri icontains "information_schema" and
     (nginx.request_uri icontains "tables" or
      nginx.request_uri icontains "columns" or
      nginx.request_uri contains "%2Etables" or
      nginx.request_uri contains "%2Ecolumns"))

# Pattern #A300: Optimized - LENGTH/COUNT/database/user/version merged to icontains
# URL-encoded patterns remain as contains
# Pattern #A304: Changed standalone keywords to function syntax to reduce false positives
# "user", "database", "version" etc. are common in normal URLs
- macro: contains_boolean_metadata
  condition: >
    (nginx.request_uri contains "LENGTH(" or
     nginx.request_uri contains "length(" or
     nginx.request_uri contains "COUNT(" or
     nginx.request_uri contains "count(" or
     nginx.request_uri contains "DATABASE(" or
     nginx.request_uri contains "database(" or
     nginx.request_uri contains "USER(" or
     nginx.request_uri contains "user(" or
     nginx.request_uri contains "VERSION(" or
     nginx.request_uri contains "version(" or
     nginx.request_uri contains "LENGTH%28" or
     nginx.request_uri contains "COUNT%28" or
     nginx.request_uri contains "database%28" or
     nginx.request_uri contains "user%28" or
     nginx.request_uri contains "version%28")

# URL-encoded boolean operators - contains maintained (hex patterns)
- macro: contains_encoded_boolean_operators
  condition: (nginx.request_uri contains "%41%4E%44" or nginx.request_uri contains "%61%6E%64" or nginx.request_uri contains "%4F%52")

# Pattern #A213 & #A299 fix - Classic SQLi patterns
# contains maintained (contains quotes, equals, URL-encoded patterns)
- macro: contains_classic_sqli_patterns
  condition: (nginx.request_uri contains "' or '1'='1" or nginx.request_uri contains "' OR '1'='1" or nginx.request_uri contains "%27%20or%20%271%27%3D%271" or nginx.request_uri contains "%27%20OR%20%271%27%3D%271" or nginx.request_uri contains "' and '1'='1" or nginx.request_uri contains "' AND '1'='1" or nginx.request_uri contains "%27%20and%20%271%27%3D%271" or nginx.request_uri contains "%27%20AND%20%271%27%3D%271" or nginx.request_uri contains "' or 'a'='a" or nginx.request_uri contains "' OR 'a'='a" or nginx.request_uri contains "%27%20or%20%27a%27%3D%27a" or nginx.request_uri contains "%27%20OR%20%27a%27%3D%27a" or nginx.request_uri contains "' and 'a'='a" or nginx.request_uri contains "' AND 'a'='a" or nginx.request_uri contains "%27%20and%20%27a%27%3D%27a" or nginx.request_uri contains "%27%20AND%20%27a%27%3D%27a")

# Numeric prefix patterns - contains maintained (contains quotes, equals)
- macro: contains_numeric_prefix_sqli_patterns
  condition: (nginx.request_uri contains "1' or '1'='1" or nginx.request_uri contains "1' OR '1'='1" or nginx.request_uri contains "1%27%20or%20%271%27%3D%271" or nginx.request_uri contains "1%27%20OR%20%271%27%3D%271" or nginx.request_uri contains "0' or '0'='0" or nginx.request_uri contains "0' OR '0'='0" or nginx.request_uri contains "0%27%20or%20%270%27%3D%270" or nginx.request_uri contains "0%27%20OR%20%270%27%3D%270" or nginx.request_uri contains "2' or '2'='2" or nginx.request_uri contains "2' OR '2'='2" or nginx.request_uri contains "2%27%20or%20%272%27%3D%272" or nginx.request_uri contains "2%27%20OR%20%272%27%3D%272")

# Pattern #A298 fix: Common parameter names
# contains maintained (short patterns, = sign)
- macro: has_common_parameter
  condition: (nginx.request_uri contains "id=" or nginx.request_uri contains "user=" or nginx.request_uri contains "name=" or nginx.request_uri contains "page=" or nginx.request_uri contains "q=" or nginx.request_uri contains "query=" or nginx.request_uri contains "search=")

# Logical operators - contains maintained (short patterns, space handling)
- macro: has_logical_operator
  condition: (nginx.request_uri contains " AND " or nginx.request_uri contains " and " or nginx.request_uri contains "%20AND%20" or nginx.request_uri contains "%20and%20" or nginx.request_uri contains " OR " or nginx.request_uri contains " or " or nginx.request_uri contains "%20OR%20" or nginx.request_uri contains "%20or%20")

# Pattern #A299 fix: Boolean equality patterns
# contains maintained (contains = sign, numeric patterns)
- macro: has_boolean_equality
  condition: (nginx.request_uri contains "1=1" or nginx.request_uri contains "1=2" or nginx.request_uri contains "0=0" or nginx.request_uri contains "2=2" or nginx.request_uri contains "1%3D1" or nginx.request_uri contains "1%3D2" or nginx.request_uri contains "0%3D0" or nginx.request_uri contains "2%3D2" or nginx.request_uri contains "a=a" or nginx.request_uri contains "a%3Da" or nginx.request_uri contains "'a'='a'" or nginx.request_uri contains "%27a%27%3D%27a%27")

# ====================================
# MACROS - Boolean-based SQL Injection (Level 2: Combined)
# ====================================

# Pattern #A304: REMOVED single "%28" (just opening paren) - causes false positives
# Opening parenthesis is covered by function patterns
- macro: sqli_boolean_general_pattern
  condition: (contains_boolean_comparisons or contains_boolean_functions or contains_case_when_patterns or contains_exists_patterns or contains_if_patterns or contains_info_schema_patterns or contains_boolean_metadata or contains_encoded_boolean_operators or (nginx.request_uri icontains "limit" and nginx.request_uri contains ",1"))

- macro: sqli_boolean_injection_pattern
  condition: (has_common_parameter and has_logical_operator and (has_boolean_equality or contains_classic_sqli_patterns or contains_numeric_prefix_sqli_patterns))

- macro: sqli_boolean_pattern
  condition: (sqli_boolean_general_pattern or sqli_boolean_injection_pattern)

# ====================================
# MACROS - Error-based SQL Injection (Level 1)
# ====================================

# Pattern #A300: Optimized - extractvalue/updatexml/xmltype merged to icontains
# URL-encoded patterns remain as contains
- macro: contains_extractvalue_updatexml
  condition: >
    (nginx.request_uri icontains "extractvalue" or
     nginx.request_uri icontains "updatexml" or
     nginx.request_uri icontains "xmltype" or
     nginx.request_uri contains "extractvalue%28" or
     nginx.request_uri contains "EXTRACTVALUE%28" or
     nginx.request_uri contains "updatexml%28" or
     nginx.request_uri contains "UPDATEXML%28" or
     nginx.request_uri contains "xmltype%28")

# Pattern #A300: Optimized - floor/rand merged to icontains
# GROUP BY patterns and combined conditions remain as contains
- macro: contains_floor_rand_patterns
  condition: >
    (nginx.request_uri icontains "floor" or
     nginx.request_uri icontains "rand" or
     nginx.request_uri contains "floor%28" or
     nginx.request_uri contains "FLOOR%28" or
     nginx.request_uri contains "rand%28" or
     nginx.request_uri contains "RAND%28" or
     nginx.request_uri contains "GROUP%20BY" or
     nginx.request_uri contains "GROUP+BY" or
     (nginx.request_uri contains "GROUP BY" and nginx.request_uri icontains "floor" and nginx.request_uri icontains "rand"))

# Pattern #A300: Optimized - concat/group_concat merged to icontains
# Hex patterns (0x7e, 0x3a) remain as contains
- macro: contains_concat_hex_patterns
  condition: >
    (nginx.request_uri icontains "concat" or
     nginx.request_uri icontains "group_concat" or
     nginx.request_uri contains "0x7e" or
     nginx.request_uri contains "0x3a" or
     nginx.request_uri contains "concat%28" or
     nginx.request_uri contains "CONCAT%28" or
     nginx.request_uri contains "group_concat%28" or
     nginx.request_uri contains "GROUP_CONCAT%28")

# Pattern #A300: Optimized - convert/cast merged to icontains for alphabetic parts
# ::int and %3A%3A patterns remain as contains (DB-specific symbols)
- macro: contains_cast_convert_patterns
  condition: >
    ((nginx.request_uri icontains "convert" and nginx.request_uri icontains "int") or
     (nginx.request_uri icontains "cast" and nginx.request_uri icontains "int") or
     nginx.request_uri contains "::int" or
     nginx.request_uri contains "%3A%3Aint" or
     nginx.request_uri contains "'::int" or
     nginx.request_uri contains "'::integer" or
     nginx.request_uri contains "'::text" or
     nginx.request_uri contains "convert%28" or
     nginx.request_uri contains "CONVERT%28" or
     nginx.request_uri contains "CAST%28")

# Version/metadata patterns
# @@version patterns remain as contains (DB-specific symbols)
# Pattern #A300: Optimized - database/schema merged to icontains
- macro: contains_version_metadata
  condition: >
    (nginx.request_uri contains "@@version" or
     nginx.request_uri contains "@@VERSION" or
     nginx.request_uri contains "%40%40version" or
     nginx.request_uri icontains "db_name" or
     nginx.request_uri icontains "database" or
     nginx.request_uri icontains "schema" or
     nginx.request_uri contains "@@servername" or
     nginx.request_uri contains "@@SERVERNAME" or
     nginx.request_uri contains "DB_NAME%28" or
     nginx.request_uri contains "database%28" or
     nginx.request_uri contains "DATABASE%28" or
     nginx.request_uri contains "schema%28")

# Pattern #A300: Optimized - Oracle-specific functions merged to icontains
# URL-encoded patterns remain as contains
- macro: contains_oracle_specific
  condition: >
    (nginx.request_uri icontains "utl_inaddr.get_host_name" or
     nginx.request_uri icontains "ctxsys.drithsx.sn" or
     nginx.request_uri contains "XMLType" or
     nginx.request_uri icontains "dbms_utility" or
     nginx.request_uri contains "utl_inaddr%2Eget_host_name" or
     nginx.request_uri contains "UTL_INADDR%2EGET_HOST_NAME" or
     nginx.request_uri contains "ctxsys%2Edrithsx%2Esn" or
     nginx.request_uri contains "CTXSYS%2EDRITHSX%2ESN" or
     nginx.request_uri contains "XMLType%28" or
     nginx.request_uri contains "dbms_utility%2E")

# System tables - icontains for alphabetic patterns
- macro: contains_system_tables
  condition: >
    (nginx.request_uri icontains "sys.databases" or
     nginx.request_uri icontains "master..sysdatabases" or
     nginx.request_uri contains "sys%2Edatabases" or
     nginx.request_uri contains "master%2E%2Esysdatabases")

# Division error patterns - contains maintained (contains numeric and special chars)
- macro: contains_division_error_patterns
  condition: >
    ((nginx.request_uri icontains "select" and nginx.request_uri contains "1/0") or
     nginx.request_uri contains "1/SELECT" or
     nginx.request_uri contains "SELECT%200" or
     nginx.request_uri contains "1/0--" or
     nginx.request_uri contains "SELECT%201/0" or
     nginx.request_uri contains "SELECT%201%2F0" or
     nginx.request_uri contains "1%2F0")

# URL-encoded error functions - contains maintained (hex patterns)
- macro: contains_encoded_error_functions
  condition: (nginx.request_uri contains "%65%78%74%72%61%63%74%76%61%6C%75%65" or nginx.request_uri contains "%75%70%64%61%74%65%78%6D%6C")

# information_schema with concat - icontains for alphabetic patterns
- macro: contains_info_schema_concat
  condition: >
    (nginx.request_uri icontains "information_schema" and
     (nginx.request_uri icontains "concat" or
      nginx.request_uri icontains "group_concat" or
      nginx.request_uri contains "concat%28" or
      nginx.request_uri contains "group_concat%28"))

# ====================================
# MACROS - Error-based SQL Injection (Level 2: Combined)
# ====================================

- macro: sqli_error_based_pattern
  condition: (contains_extractvalue_updatexml or contains_floor_rand_patterns or contains_concat_hex_patterns or contains_cast_convert_patterns or contains_version_metadata or contains_oracle_specific or contains_system_tables or contains_division_error_patterns or contains_encoded_error_functions or contains_info_schema_concat)

# ====================================
# MACROS - Advanced SQL Injection (Level 1)
# ====================================

# Pattern #A300: Optimized - system objects merged to icontains
- macro: contains_system_objects
  condition: (nginx.request_uri icontains "information_schema" or nginx.request_uri icontains "sysobjects" or nginx.request_uri icontains "syscolumns" or nginx.request_uri icontains "sys.tables" or nginx.request_uri icontains "sys.columns")

# Pattern #A300: Optimized - UNION/GROUP/HAVING/ORDER merged to icontains
# URL-encoded patterns remain as contains
- macro: contains_union_group_patterns
  condition: (nginx.request_uri contains "UNION%20SELECT" or nginx.request_uri icontains "union select" or nginx.request_uri contains "GROUP%20BY" or nginx.request_uri icontains "group by" or nginx.request_uri icontains "having" or nginx.request_uri contains "ORDER%20BY")

# Hex and char patterns - contains maintained (0x prefix, special chars)
- macro: contains_hex_char_patterns
  condition: (nginx.request_uri contains "0x" or nginx.request_uri contains "\\x" or (nginx.request_uri icontains "concat" and nginx.request_uri contains "0x") or (nginx.request_uri icontains "char" and nginx.request_uri contains ","))

# File operations - icontains for alphabetic parts
- macro: contains_file_operations
  condition: (nginx.request_uri icontains "load_file" or nginx.request_uri contains "into%20outfile" or nginx.request_uri contains "into%20dumpfile")

# ====================================
# MACROS - Advanced SQL Injection (Level 2: Combined)
# ====================================

- macro: sqli_advanced_pattern
  condition: (contains_system_objects or contains_union_group_patterns or contains_hex_char_patterns or contains_file_operations)

# ====================================
# MACROS - Encoded SQL Injection (Level 1)
# ====================================

# Double-encoded patterns - contains maintained (URL-encoded hex)
- macro: contains_double_encoded_patterns
  condition: (nginx.request_uri contains "%2527" or nginx.request_uri contains "%252F" or nginx.request_uri contains "%u0027" or nginx.request_uri contains "%u002f")

# Pattern #A300: Removed - Mixed case keywords are now redundant
# icontains "select" and icontains "union" already cover all case variations
# Keeping minimal patterns that might be evasion indicators
- macro: contains_mixed_case_keywords
  condition: (nginx.request_uri contains "SeLeCt" or nginx.request_uri contains "sElEcT" or nginx.request_uri contains "UnIoN" or nginx.request_uri contains "uNiOn")

# Comment and special chars - contains maintained (URL-encoded special chars)
- macro: contains_comment_special_chars
  condition: (nginx.request_uri contains "/*" or nginx.request_uri contains "*/" or nginx.request_uri contains "--+" or nginx.request_uri contains "%23" or nginx.request_uri contains "%60" or nginx.request_uri contains "%00" or nginx.request_uri contains "%0a" or nginx.request_uri contains "%0d")

# ====================================
# MACROS - Encoded SQL Injection (Level 2: Combined)
# ====================================

- macro: sqli_encoded_pattern
  condition: (contains_double_encoded_patterns or contains_mixed_case_keywords or contains_comment_special_chars)

# ====================================
# ADV_SQLI_001: Time-based Blind SQLi
# ====================================
- rule: Time-based Blind SQL Injection
  desc: Detects time-based blind SQL injection attempts using SLEEP, WAITFOR DELAY, pg_sleep, BENCHMARK, and other time-based functions
  condition: sqli_time_based_pattern
  output: "[NGINX SQLi] Time-based Blind SQL Injection test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id (query=%nginx.query_string) (uri=%nginx.request_uri) (remote_addr=%nginx.remote_addr method=%nginx.method status=%nginx.status)"
  priority: CRITICAL
  tags: [security, sql_injection, advanced_sqli, time_based, phase3]
  source: nginx

# ====================================
# ADV_SQLI_002: Boolean-based Blind SQLi
# Pattern #A214 fix - Reduced from 152 `or` to hierarchical macros
# ====================================
- rule: Boolean-based Blind SQL Injection
  desc: Detects boolean-based blind SQL injection using conditional statements and boolean logic. Pattern #A213 fix - includes numeric-prefix patterns (e.g., id=1' OR '1'='1'). Pattern #A214 fix - refactored to use macro-only hierarchical structure.
  condition: sqli_boolean_pattern
  output: "[NGINX SQLi] Boolean-based Blind SQL Injection test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id (query=%nginx.query_string) (uri=%nginx.request_uri) (remote_addr=%nginx.remote_addr method=%nginx.method status=%nginx.status)"
  priority: CRITICAL
  tags: [security, sql_injection, advanced_sqli, boolean_based, phase3]
  source: nginx

# ====================================
# ADV_SQLI_003: Error-based SQLi
# ====================================
- rule: Error-based SQL Injection
  desc: Detects error-based SQL injection attempts to extract data through database errors
  condition: sqli_error_based_pattern
  output: "[NGINX SQLi] Error-based SQL Injection test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id (query=%nginx.query_string) (uri=%nginx.request_uri) (remote_addr=%nginx.remote_addr method=%nginx.method status=%nginx.status)"
  priority: CRITICAL
  tags: [security, sql_injection, advanced_sqli, error_based, phase3]
  source: nginx

# ====================================
# ADV_SQLI_004: Combined Advanced SQLi Detection
# ====================================
- rule: Advanced SQL Injection Attempt
  desc: Comprehensive detection of advanced SQL injection techniques
  condition: sqli_advanced_pattern
  output: "[NGINX SQLi] Advanced SQL Injection Attempt test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id (query=%nginx.query_string) (uri=%nginx.request_uri) (remote_addr=%nginx.remote_addr method=%nginx.method status=%nginx.status)"
  priority: WARNING
  tags: [security, sql_injection, advanced_sqli, enumeration, phase3]
  source: nginx

# ====================================
# ADV_SQLI_005: Encoded SQLi Pattern Detection
# ====================================
- rule: Encoded SQL Injection Pattern
  desc: Detects SQL injection attempts using various encoding techniques
  condition: sqli_encoded_pattern
  output: "[NGINX SQLi] Encoded SQL Injection Pattern test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id (query=%nginx.query_string) (uri=%nginx.request_uri) (remote_addr=%nginx.remote_addr method=%nginx.method status=%nginx.status)"
  priority: WARNING
  tags: [security, sql_injection, advanced_sqli, encoding_evasion, phase3]
  source: nginx

# ==============================================================================
# XSS Detection Rules (from advanced_xss_enhanced.yaml)
# ==============================================================================

# rules/advanced_xss_enhanced.yaml
# Advanced XSS Detection Rules for Falco
# Created: 2025-09-02
# Optimized: 2025-11-26 - Pattern #A303 fix (icontains optimization per falco-plugin-rules.md v1.1.0)
#
# This ruleset detects sophisticated XSS attacks including:
# - DOM-based XSS
# - Stored XSS
# - Polyglot XSS
#
# OPTIMIZATION (Pattern #A303):
# - Replaced redundant contains with icontains for event handlers (onclick, onerror, etc.)
# - Consolidated case variants (onclick + ONCLICK) into single icontains
# - Maintained contains for: URL-encoded patterns, HTML entities, Unicode escapes
# - Reference: docs/development/best-practices/falco-plugin-rules.md v1.1.0
#
# FIX (Pattern #A313 - Issue #755):
# - Removed overly broad "%28" pattern from Advanced XSS Attack Attempt rule
# - %28 (URL-encoded parenthesis) matches any function call, not just XSS
# - Caused EMRG_MONGO_005 (MongoDB injection) to be misclassified as XSS
# - XSS patterns remain covered by event handlers, script tags, etc.

# ====================================
# ADV_XSS_001: DOM-based XSS
# ====================================
# Pattern #A303: Event handlers use icontains, URL-encoded patterns use contains
- rule: DOM-based XSS Attack
  desc: Detects DOM-based XSS attempts through URL manipulation and JavaScript execution
  condition: >-
    (
      nginx.request_uri icontains "javascript:" or
      nginx.request_uri contains "javascript%3A" or
      nginx.request_uri icontains "data:text/html" or
      nginx.request_uri contains "data%3Atext%2Fhtml" or
      (nginx.request_uri icontains "<script" and nginx.request_uri icontains "</script>") or
      (nginx.request_uri contains "%3Cscript" and nginx.request_uri contains "%3C%2Fscript") or
      nginx.request_uri icontains "onerror=" or
      nginx.request_uri contains "onerror%3D" or
      nginx.request_uri icontains "onload=" or
      nginx.request_uri contains "onload%3D" or
      nginx.request_uri icontains "onmouseover=" or
      nginx.request_uri contains "onmouseover%3D" or
      nginx.request_uri icontains "document.write" or
      nginx.request_uri icontains "document.cookie" or
      nginx.request_uri icontains "window.location" or
      (nginx.request_uri icontains "<iframe" and nginx.request_uri icontains "src=") or
      (nginx.request_uri contains "%3Ciframe" and nginx.request_uri contains "src%3D") or
      (nginx.request_uri icontains "<object" and nginx.request_uri icontains "data=") or
      (nginx.request_uri contains "%3Cobject" and nginx.request_uri contains "data%3D")
    )
  output: "[NGINX XSS] DOM-based XSS Attack detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, xss, dom_based, advanced_xss, phase3]
  source: nginx

# ====================================
# ADV_XSS_002: Stored XSS
# ====================================
# Pattern #A303: HTML tags and event handlers use icontains, URL-encoded patterns use contains
- rule: Stored XSS Attack
  desc: Detects stored XSS attempts in POST requests and form submissions
  condition: >-
    (
      nginx.method = "POST" and (
        nginx.request_uri icontains "<script" or
        nginx.request_uri contains "%3Cscript" or
        nginx.request_uri icontains "<img" or
        nginx.request_uri contains "%3Cimg" or
        nginx.request_uri icontains "<svg" or
        nginx.request_uri contains "%3Csvg" or
        nginx.request_uri icontains "<iframe" or
        nginx.request_uri contains "%3Ciframe" or
        nginx.request_uri icontains "<body" or
        nginx.request_uri contains "%3Cbody" or
        nginx.request_uri icontains "<object" or
        nginx.request_uri contains "%3Cobject" or
        nginx.request_uri icontains "<embed" or
        nginx.request_uri contains "%3Cembed" or
        nginx.request_uri icontains "<meta" or
        nginx.request_uri contains "%3Cmeta" or
        nginx.request_uri icontains "<link" or
        nginx.request_uri contains "%3Clink" or
        nginx.request_uri icontains "javascript:" or
        nginx.request_uri contains "javascript%3A" or
        nginx.request_uri icontains "onerror" or
        nginx.request_uri icontains "onload" or
        nginx.request_uri icontains "onfocus" or
        nginx.request_uri icontains "autofocus"
      )
    )
  output: "[NGINX XSS] Stored XSS Attack detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, xss, stored_xss, advanced_xss, phase3]
  source: nginx

# ====================================
# ADV_XSS_003: Polyglot XSS
# ====================================
# Pattern #A303: Event handlers use icontains, special characters/encoding use contains
- rule: Polyglot XSS Attack
  desc: Detects polyglot XSS patterns that work across multiple contexts
  condition: >-
    (
      nginx.request_uri contains "javascript:/*--></title></style></textarea></script></xmp><svg/onload='+/\"/+/onmouseover=1/+/[*/[]/+alert(1)//'>" or
      nginx.request_uri contains "javascript:/*--></title></style></textarea></script>" or
      (nginx.request_uri icontains "</title>" and nginx.request_uri icontains "<script>") or
      (nginx.request_uri icontains "</style>" and nginx.request_uri icontains "<script>") or
      (nginx.request_uri icontains "</textarea>" and nginx.request_uri icontains "<script>") or
      (nginx.request_uri icontains "</script>" and nginx.request_uri icontains "<svg") or
      nginx.request_uri icontains "</xmp>" or
      nginx.request_uri icontains "</noscript>" or
      nginx.request_uri icontains "</template>" or
      nginx.request_uri contains "'><script>" or
      nginx.request_uri contains "\"><script>" or
      nginx.request_uri contains "' onmouseover='" or
      nginx.request_uri contains "\" autofocus onfocus=" or
      nginx.request_uri contains "' autofocus onfocus='" or
      nginx.request_uri contains "\" onclick=" or
      nginx.request_uri contains "' onclick='" or
      nginx.request_uri contains "';alert" or
      nginx.request_uri contains "\";alert" or
      nginx.request_uri contains "';alert(String.fromCharCode(88,83,83))//';alert(String.fromCharCode(88,83,83))//" or
      nginx.request_uri contains "\";alert(String.fromCharCode(88,83,83))//\";alert(String.fromCharCode(88,83,83))//" or
      nginx.request_uri contains "--></SCRIPT>\">'><SCRIPT>alert(String.fromCharCode(88,83,83))</SCRIPT>" or
      nginx.request_uri icontains "String.fromCharCode" or
      nginx.request_uri contains "String%2EfromCharCode" or
      nginx.request_uri icontains "fromCharCode(88,83,83)" or
      (nginx.request_uri icontains "autofocus" and nginx.request_uri icontains "onfocus") or
      (nginx.request_uri icontains "onmouseover=" and nginx.request_uri icontains "alert") or
      (nginx.request_uri contains "<!--" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "-->" and nginx.request_uri icontains "<script") or
      nginx.request_uri contains "//\";alert" or
      nginx.request_uri contains "//';alert" or
      nginx.request_uri contains "/**/" or
      nginx.request_uri contains "\\u0061\\u006c\\u0065\\u0072\\u0074" or
      nginx.request_uri contains "\\u003c\\u0073\\u0063\\u0072\\u0069\\u0070\\u0074" or
      nginx.request_uri contains "%5Cu0061%5Cu006c%5Cu0065%5Cu0072%5Cu0074" or
      nginx.request_uri contains "&#60;script" or
      nginx.request_uri contains "&#x3c;script" or
      nginx.request_uri contains "&#40;" or
      nginx.request_uri contains "&#41;" or
      nginx.request_uri contains "&#x28;" or
      nginx.request_uri contains "&#x29;" or
      (nginx.request_uri contains "'>" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "'%20>" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "\">" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "\"%20>" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "%27>" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "%27%20>" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "' on" or nginx.request_uri contains "\" on" or
       nginx.request_uri contains "'%20on" or nginx.request_uri contains "\"%20on" or
       nginx.request_uri contains "%27%20on" or
       nginx.request_uri icontains "onclick" or
       nginx.request_uri icontains "onload" or
       nginx.request_uri icontains "onerror" or
       nginx.request_uri icontains "onmouseover" or
       nginx.request_uri icontains "onfocus") or
      nginx.request_uri icontains "</script><script>" or
      nginx.request_uri icontains "</style><script>" or
      nginx.request_uri icontains "</textarea><script>"
    )
  output: "[NGINX XSS] Polyglot XSS Attack detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, xss, polyglot, advanced_xss, phase3]
  source: nginx

# ====================================
# Combined Advanced XSS Detection
# ====================================
# Pattern #A303: Event handlers and JS keywords use icontains, URL-encoded and HTML entities use contains
# Pattern #A313: REMOVED %28 pattern (Issue #755)
#   - %28 is too broad (matches any URL-encoded parenthesis)
#   - XSS patterns are covered by other rules (event handlers, script tags, etc.)
#   - Caused EMRG_MONGO_005 to be misclassified as XSS
- rule: Advanced XSS Attack Attempt
  desc: Comprehensive detection of advanced XSS techniques
  condition: >-
    (
      nginx.request_uri icontains "onclick=" or
      nginx.request_uri icontains "ondblclick=" or
      nginx.request_uri icontains "onmousedown=" or
      nginx.request_uri icontains "onmouseenter=" or
      nginx.request_uri icontains "onmouseleave=" or
      nginx.request_uri icontains "onmousemove=" or
      nginx.request_uri icontains "onmouseout=" or
      nginx.request_uri icontains "onmouseup=" or
      nginx.request_uri icontains "onkeydown=" or
      nginx.request_uri icontains "onkeypress=" or
      nginx.request_uri icontains "onkeyup=" or
      nginx.request_uri icontains "onchange=" or
      nginx.request_uri icontains "onsubmit=" or
      nginx.request_uri icontains "onreset=" or
      nginx.request_uri icontains "onselect=" or
      nginx.request_uri icontains "onblur=" or
      nginx.request_uri icontains "ondrag=" or
      nginx.request_uri icontains "ondrop=" or
      nginx.request_uri icontains "oncanplay=" or
      nginx.request_uri icontains "oncanplaythrough=" or
      nginx.request_uri icontains "ondurationchange=" or
      nginx.request_uri icontains "onemptied=" or
      nginx.request_uri icontains "onended=" or
      nginx.request_uri icontains "onloadeddata=" or
      nginx.request_uri icontains "onloadedmetadata=" or
      nginx.request_uri icontains "onloadstart=" or
      nginx.request_uri icontains "onpause=" or
      nginx.request_uri icontains "onplay=" or
      nginx.request_uri icontains "onplaying=" or
      nginx.request_uri icontains "eval" or
      nginx.request_uri icontains "setTimeout" or
      nginx.request_uri icontains "setInterval" or
      nginx.request_uri icontains "Function" or
      nginx.request_uri icontains "constructor" or
      nginx.request_uri contains "&#x3C;" or
      nginx.request_uri contains "&#60;" or
      nginx.request_uri contains "&lt;script" or
      nginx.request_uri contains "&gt;"
    )
  output: "[NGINX XSS] Advanced XSS Attack Attempt detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: WARNING
  tags: [security, xss, advanced_xss, event_handlers, phase3]
  source: nginx

# ====================================
# XSS Filter Bypass Detection
# ====================================
# Pattern #A303: Case variants consolidated to icontains, URL-encoded patterns use contains
- rule: XSS Filter Bypass Attempt
  desc: Detects attempts to bypass XSS filters using various encoding and obfuscation techniques
  condition: >-
    (
      nginx.request_uri icontains "script" or
      nginx.request_uri contains "%00" or
      nginx.request_uri contains "\\x00" or
      nginx.request_uri contains "%09" or
      nginx.request_uri contains "%0a" or
      nginx.request_uri contains "%0d" or
      nginx.request_uri contains "%253C" or
      nginx.request_uri contains "%253E" or
      nginx.request_uri contains "%2527" or
      nginx.request_uri contains "%2522" or
      nginx.request_uri contains "%c0%bc" or
      nginx.request_uri contains "%e0%80%bc" or
      nginx.request_uri contains "%f0%80%80%bc" or
      nginx.request_uri icontains "<scr" or
      nginx.request_uri icontains "<ifr" or
      nginx.request_uri icontains "<fra" or
      nginx.request_uri icontains "expression" or
      nginx.request_uri icontains "style=" or
      nginx.request_uri icontains "behavior:" or
      nginx.request_uri icontains "-moz-binding:" or
      nginx.request_uri icontains "data:application" or
      nginx.request_uri icontains "data:image/svg" or
      nginx.request_uri icontains "vbscript:" or
      nginx.request_uri icontains "livescript:"
    )
  output: "[NGINX XSS] XSS Filter Bypass Attempt detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: WARNING
  tags: [security, xss, filter_bypass, advanced_xss, phase3]
  source: nginx

# ==============================================================================
# Path Traversal Detection Rules (from advanced_traversal_enhanced.yaml)
# ==============================================================================

# rules/advanced_traversal_enhanced.yaml
# Advanced Path Traversal Detection Rules for Falco
# Created: 2025-09-14
# Optimized: 2025-11-26 - Pattern #A302 fix (icontains optimization per falco-plugin-rules.md v1.1.0)
#
# This ruleset detects path traversal attacks including:
# - Basic traversal patterns
# - Encoded traversal patterns
# - Windows-specific traversal
# - Double encoding
#
# OPTIMIZATION (Pattern #A302):
# - Replaced redundant contains with icontains for file/path names without URL encoding
# - Maintained contains for: URL-encoded patterns, traversal sequences (..), special characters
# - Reference: docs/development/best-practices/falco-plugin-rules.md v1.1.0

# ====================================
# ADV_TRAV_001: Basic Path Traversal
# ====================================
# Pattern #A302: Traversal sequences (..) must use contains (special characters)
- rule: Basic Path Traversal Attack
  desc: Detects basic path traversal attempts using ../ patterns
  condition: >-
    (
      nginx.request_uri contains "../" or
      nginx.request_uri contains "..%2f" or
      nginx.request_uri contains "..%2F" or
      nginx.request_uri contains ".." or
      nginx.request_uri contains "..%5c" or
      nginx.request_uri contains "..%5C" or
      nginx.request_uri contains "..../" or
      nginx.request_uri contains "../../../" or
      nginx.request_uri contains "../../../../" or
      nginx.request_uri contains "../../../../../" or
      nginx.request_uri contains "../../../../../../" or
      nginx.request_uri contains "../.ssh" or
      nginx.request_uri contains "../root" or
      nginx.request_uri contains "../home"
    )
  output: "[NGINX Traversal] Basic path traversal attack detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, path_traversal, advanced_traversal, basic, phase3]
  source: nginx

# ====================================
# ADV_TRAV_002: Encoded Path Traversal
# ====================================
# Pattern #A302: All URL-encoded patterns, maintain contains
- rule: Encoded Path Traversal Attack
  desc: Detects encoded path traversal attempts
  condition: >-
    (
      nginx.request_uri contains "%2e%2e%2f" or
      nginx.request_uri contains "%2e%2e%5c" or
      nginx.request_uri contains "%252e%252e%252f" or
      nginx.request_uri contains "%252e%252e%255c" or
      nginx.request_uri contains "%c0%ae%c0%ae" or
      nginx.request_uri contains "%c1%9c" or
      nginx.request_uri contains "..%252f" or
      nginx.request_uri contains "..%255c" or
      nginx.request_uri contains "%2e%2e/" or
      nginx.request_uri contains "%2e%2e%5c" or
      nginx.request_uri contains "..;/" or
      nginx.request_uri contains "..%3b/" or
      nginx.request_uri contains "..%00/" or
      nginx.request_uri contains "%2e%2e%00/"
    )
  output: "[NGINX Traversal] Encoded path traversal attack detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, path_traversal, advanced_traversal, encoded, phase3]
  source: nginx

# ====================================
# ADV_TRAV_003: Windows Path Traversal
# ====================================
# Pattern #A302: Windows paths and URL-encoded patterns, maintain contains
- rule: Windows Path Traversal Attack
  desc: Detects Windows-specific path traversal attempts
  condition: >-
    (
      nginx.request_uri contains "C:%5c" or
      nginx.request_uri contains "C:/" or
      nginx.request_uri contains "..%5cwindows" or
      nginx.request_uri contains "..%5cwinnt" or
      nginx.request_uri contains "..%5cboot.ini" or
      nginx.request_uri contains "..%5csystem32" or
      nginx.request_uri contains "%5cwindows" or
      nginx.request_uri contains "%5cwinnt" or
      nginx.request_uri contains "%5csystem32" or
      nginx.request_uri contains "%5c%5clocalhost" or
      nginx.request_uri contains "%5c%5clocalhost" or
      nginx.request_uri contains "file:///" or
      nginx.request_uri contains "file:%2f%2f%2f" or
      nginx.request_uri contains "%5c%5c.%5c" or
      nginx.request_uri contains "%5c%5c%2e%5c"
    )
  output: "[NGINX Traversal] Windows path traversal attack detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, path_traversal, advanced_traversal, windows, phase3]
  source: nginx

# ====================================
# ADV_TRAV_004: File Inclusion Patterns
# ====================================
# Pattern #A302: File paths use icontains for case variations, URL-encoded patterns use contains
# Pattern #A315 Fix (Issue #760): Exclude CMDi patterns to prevent misclassification
#   - CMD_BASIC_005 payload "; cat /etc/passwd" was matching "/etc/passwd" before CMDi rule
# Pattern #A316 Fix (Issue #762): Use 'in' operator for single-field exception
#   - 'startswith' and 'contains' are invalid for single-field exceptions in Falco 0.42.1
#   - Valid comps for single field: in, pmatch, intersects
#   - pmatch is for filesystem paths only (Pattern #A214) - NOT usable with nginx fields
#   - Reference: PROBLEM_PATTERNS.md Pattern #A316, Pattern #A214
- rule: File Inclusion Attack
  desc: Detects attempts to include sensitive files
  condition: >-
    (
      nginx.request_uri icontains "/etc/passwd" or
      nginx.request_uri icontains "/etc/shadow" or
      nginx.request_uri icontains "/etc/hosts" or
      nginx.request_uri icontains "/proc/self" or
      nginx.request_uri icontains "/var/log" or
      nginx.request_uri icontains "/.ssh/id_rsa" or
      nginx.request_uri icontains "/.ssh/authorized_keys" or
      nginx.request_uri icontains "/.bashrc" or
      nginx.request_uri icontains "/.bash_history" or
      nginx.request_uri icontains "/root/.ssh" or
      nginx.request_uri contains "%2Fetc%2Fpasswd" or
      nginx.request_uri contains "%2Fetc%2Fshadow" or
      nginx.request_uri contains "%2Fproc%2Fself" or
      nginx.request_uri contains "%2Fvar%2Flog" or
      nginx.request_uri icontains "win.ini" or
      nginx.request_uri icontains "system.ini" or
      nginx.request_uri icontains "php.ini" or
      nginx.request_uri icontains "httpd.conf" or
      nginx.request_uri icontains ".htaccess" or
      nginx.request_uri icontains "web.config"
    )
  exceptions:
    # Pattern #A316 Fix: E2E test - Exclude CMDi patterns by exact pattern_id match
    # Using 'in' operator with full list of CMD_ pattern IDs
    - name: cmdi_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CMD_BASIC_SEMICOLON_001
        - CMD_BASIC_002
        - CMD_BASIC_003
        - CMD_BASIC_004
        - CMD_BASIC_005
        - CMD_BASIC_006
        - CMD_BASIC_007
        - CMD_BASIC_008
        - CMD_BASIC_009
        - CMD_BASIC_010
  output: "[NGINX Traversal] File inclusion attack detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, path_traversal, file_inclusion, advanced_traversal, phase3]
  source: nginx

# ====================================
# Combined Path Traversal Detection
# ====================================
# Pattern #A302: Plain text uses icontains, URL-encoded and special chars use contains
- rule: Advanced Path Traversal Attempt
  desc: Comprehensive detection of path traversal techniques
  condition: >-
    (
      nginx.request_uri contains "..%5c.." or
      nginx.request_uri icontains "directory traversal" or
      nginx.request_uri contains "%00" or
      nginx.request_uri contains "%0a" or
      nginx.request_uri contains "%0d" or
      nginx.request_uri contains "::$DATA" or
      nginx.request_uri contains "::$INDEX_ALLOCATION"
    )
  output: "[NGINX Traversal] Advanced path traversal attempt detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: WARNING
  tags: [security, path_traversal, advanced_traversal, phase3]
  source: nginx

# ==============================================================================
# Command Injection Detection Rules (from advanced_cmdi_enhanced.yaml)
# ==============================================================================

# rules/advanced_cmdi_enhanced.yaml
# Advanced Command Injection Detection Rules for Falco
# Created: 2025-09-14
# Optimized: 2025-11-26 - Pattern #A301 fix (icontains optimization per falco-plugin-rules.md v1.1.0)
#
# This ruleset detects command injection attacks including:
# - Semicolon-based injection
# - Pipe-based injection
# - Command substitution
# - Encoded variants
#
# OPTIMIZATION (Pattern #A301):
# - Replaced redundant contains with icontains for pure command names
# - Maintained contains for: URL-encoded patterns, special characters
# - Reference: docs/development/best-practices/falco-plugin-rules.md v1.1.0

# ====================================
# ADV_CMDI_001: Command Injection via Semicolon
# ====================================
# Pattern #A301: Command names use icontains, URL-encoded patterns use contains
# Pattern #A306: Added space-prefixed patterns for E2E test coverage
#   - CMD_BASIC_SEMICOLON_001: ; ls -la
#   - CMD_BASIC_006: ; uname -a
#   - CMD_BASIC_009: ; ifconfig
# Pattern #A317 Fix (Issue #764): Added "; cat" pattern for CMD_BASIC_005
#   - CMD_BASIC_005: ; cat /etc/passwd
#   - Previously only ";cat" (no space) was covered, but payload has space
- rule: Command Injection via Semicolon
  desc: Detects command injection attempts using semicolon separators
  condition: >-
    (
      nginx.request_uri icontains ";cat" or
      nginx.request_uri icontains ";rm" or
      nginx.request_uri icontains ";wget" or
      nginx.request_uri icontains ";curl" or
      nginx.request_uri icontains ";id" or
      nginx.request_uri icontains ";whoami" or
      nginx.request_uri icontains ";uname" or
      nginx.request_uri icontains ";ls" or
      nginx.request_uri icontains ";nc" or
      nginx.request_uri icontains "; ls" or
      nginx.request_uri icontains "; uname" or
      nginx.request_uri icontains "; ifconfig" or
      nginx.request_uri icontains "; cat" or
      nginx.request_uri contains "%3Bcat" or
      nginx.request_uri contains "%3Brm" or
      nginx.request_uri contains "%3Bwget" or
      nginx.request_uri contains "%3Bid" or
      nginx.request_uri contains "%3Bwhoami" or
      nginx.request_uri contains "%3Buname" or
      nginx.request_uri contains "%3Bls" or
      nginx.request_uri contains "%3Bnc" or
      nginx.request_uri contains "%3B%20ls" or
      nginx.request_uri contains "%3B%20uname" or
      nginx.request_uri contains "%3B%20ifconfig" or
      nginx.request_uri contains "%3B%20cat"
    )
  output: "[NGINX CMDi] Command injection via semicolon detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, command_injection, advanced_cmdi, semicolon, phase3]
  source: nginx

# ====================================
# ADV_CMDI_002: Command Injection via Pipe
# ====================================
# Pattern #A301: Command names use icontains, URL-encoded patterns use contains
# Pattern #A306: Added space-prefixed patterns for E2E test coverage
#   - CMD_BASIC_003: || id
#   - CMD_BASIC_008: || cat /proc/version
- rule: Command Injection via Pipe
  desc: Detects command injection attempts using pipe operators
  condition: >-
    (
      nginx.request_uri icontains "|whoami" or
      nginx.request_uri icontains "|cat" or
      nginx.request_uri icontains "||nc" or
      nginx.request_uri icontains "|curl" or
      nginx.request_uri icontains "|wget" or
      nginx.request_uri icontains "|bash" or
      nginx.request_uri icontains "|sh" or
      nginx.request_uri icontains "|python" or
      nginx.request_uri icontains "|perl" or
      nginx.request_uri icontains "|| id" or
      nginx.request_uri icontains "|| cat" or
      nginx.request_uri contains "%7Cwhoami" or
      nginx.request_uri contains "%7Ccat" or
      nginx.request_uri contains "%7C%7Cnc" or
      nginx.request_uri contains "%7Ccurl" or
      nginx.request_uri contains "%7Cwget" or
      nginx.request_uri contains "%7Cbash" or
      nginx.request_uri contains "%7Csh" or
      nginx.request_uri contains "%7C%7C%20id" or
      nginx.request_uri contains "%7C%7C%20cat"
    )
  output: "[NGINX CMDi] Command injection via pipe detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, command_injection, advanced_cmdi, pipe, phase3]
  source: nginx

# ====================================
# ADV_CMDI_003: Command Substitution
# ====================================
# Pattern #A301: Pure command names use icontains
# URL-encoded and special patterns ($, `, ${}) use contains
# Pattern #A304: Removed single "$" - causes false positives (e.g., /products?price=$100)
# Pattern #A304: Removed standalone "whoami", "curl", "wget" - covered by backtick/substitution patterns
- rule: Command Substitution Attack
  desc: Detects command injection attempts using command substitution
  condition: >-
    (
      nginx.request_uri contains "$(whoami" or
      nginx.request_uri contains "$(cat" or
      nginx.request_uri contains "$(curl" or
      nginx.request_uri contains "$(wget" or
      nginx.request_uri contains "$(id" or
      nginx.request_uri contains "`whoami" or
      nginx.request_uri contains "`cat" or
      nginx.request_uri contains "`curl" or
      nginx.request_uri contains "`wget" or
      nginx.request_uri contains "`id" or
      nginx.request_uri contains "%24%28whoami" or
      nginx.request_uri contains "%24%28cat" or
      nginx.request_uri contains "%24%28curl" or
      nginx.request_uri contains "%60whoami" or
      nginx.request_uri contains "%60cat" or
      nginx.request_uri contains "${IFS}" or
      nginx.request_uri contains "%24%7BIFS%7D"
    )
  output: "[NGINX CMDi] Command substitution attack detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, command_injection, advanced_cmdi, substitution, phase3]
  source: nginx

# ====================================
# Combined Command Injection Detection
# ====================================
# Pattern #A301: System paths and commands use icontains where appropriate
# Special characters and URL-encoded patterns use contains
# Pattern #A304: REMOVED single special characters (;, |, `, &, $) - causes massive false positives
# These characters are used in normal URLs: & (query params), ; (cookies), $ (prices), | (filters)
# Attack detection is handled by ADV_CMDI_001-003 with command name combinations
# Pattern #A306: Added "& ps" pattern for E2E test coverage
#   - CMD_BASIC_004: & ps aux
#   Note: "& ps" with space distinguishes from "&ps=" query parameter
# Pattern #A312: REMOVED /etc/passwd and /etc/shadow patterns (Issue #754)
#   - These are file access (Traversal), not command execution (CMDi)
#   - Covered by advanced_traversal_enhanced.yaml (File Inclusion Attack rule)
#   - See: Issue #754, E2E Run #124 analysis
- rule: Advanced Command Injection Attempt
  desc: Comprehensive detection of command injection techniques
  condition: >-
    (
      nginx.request_uri icontains "/bin/sh" or
      nginx.request_uri icontains "/bin/bash" or
      nginx.request_uri icontains "cmd.exe" or
      nginx.request_uri icontains "powershell" or
      nginx.request_uri icontains "nc -e" or
      nginx.request_uri icontains "bash -i" or
      nginx.request_uri icontains "& ps" or
      nginx.request_uri contains "%2Fbin%2Fsh" or
      nginx.request_uri contains "%2Fbin%2Fbash" or
      nginx.request_uri contains "&&" or
      nginx.request_uri contains "%26%26" or
      nginx.request_uri contains "%26%20ps" or
      nginx.request_uri contains "%0a" or
      nginx.request_uri contains "%0d"
    )
  output: "[NGINX CMDi] Advanced command injection attempt detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: WARNING
  tags: [security, command_injection, advanced_cmdi, phase3]
  source: nginx

# ==============================================================================
# Emerging Threats Detection Rules (from advanced_emerging_enhanced.yaml)
# ==============================================================================

# rules/advanced_emerging_enhanced.yaml
# Advanced Emerging Threats Detection Rules for Falco
# Created: 2025-09-14
# Optimized: 2025-11-26 - Pattern #A302 fix (icontains optimization per falco-plugin-rules.md v1.1.0)
#
# This ruleset detects emerging threats including:
# - Log4Shell (CVE-2021-44228)
# - Spring4Shell (CVE-2022-22965)
# - Other zero-day patterns
#
# OPTIMIZATION (Pattern #A302):
# - Replaced redundant contains with icontains for pure alphabetic class/method names
# - Maintained contains for: URL-encoded patterns, Base64, special characters ($, {, @, !)
# - Reference: docs/development/best-practices/falco-plugin-rules.md v1.1.0

# ====================================
# ADV_EMRG_001: Log4Shell Detection
# ====================================
# Pattern #A302: All patterns contain special characters (${), maintain contains
- rule: Log4Shell Attack Detection
  desc: Detects Log4Shell (CVE-2021-44228) exploitation attempts
  condition: >-
    (
      nginx.request_uri contains "${jndi:" or
      nginx.request_uri contains "${jndi:ldap" or
      nginx.request_uri contains "${jndi:rmi" or
      nginx.request_uri contains "${jndi:dns" or
      nginx.request_uri contains "${jndi:iiop" or
      nginx.request_uri contains "${jndi:http" or
      nginx.request_uri contains "${jndi:nis" or
      nginx.request_uri contains "${jndi:nds" or
      nginx.request_uri contains "${jndi:corba" or
      nginx.request_uri contains "%24%7Bjndi%3A" or
      nginx.request_uri contains "%24%7Bjndi%3Aldap" or
      nginx.request_uri contains "%24%7Bjndi%3Armi" or
      nginx.request_uri contains "%2524%257Bjndi" or
      nginx.request_uri contains "${${::-j}" or
      nginx.request_uri contains "${${lower:j}" or
      nginx.request_uri contains "${${upper:j}" or
      nginx.request_uri contains "${${env:ENV_NAME:-j}" or
      nginx.request_uri contains "${${sys:SYS_NAME:-j}" or
      nginx.request_uri contains "${${::-j}${::-n}${::-d}${::-i}" or
      nginx.request_uri contains "${${lower:jndi}" or
      nginx.request_uri contains "${${upper:jndi}" or
      nginx.request_uri contains "${${::-j}ndi"
    )
  output: "[NGINX Emerging Threat] Log4Shell attack detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, emerging_threats, log4shell, cve_2021_44228, phase3]
  source: nginx

# ====================================
# ADV_EMRG_002: Spring4Shell Detection
# ====================================
# Pattern #A302: Java class names use icontains, URL-encoded patterns use contains
- rule: Spring4Shell Attack Detection
  desc: Detects Spring4Shell (CVE-2022-22965) exploitation attempts
  condition: >-
    (
      nginx.request_uri icontains "class.module.classLoader" or
      nginx.request_uri contains "class%2Emodule%2EclassLoader" or
      nginx.request_uri contains "class%252Emodule%252EclassLoader" or
      nginx.request_uri contains "%63%6c%61%73%73%2e%6d%6f%64%75%6c%65" or
      nginx.request_uri contains "class[module][classLoader]" or
      nginx.request_uri contains "class%5Bmodule%5D%5BclassLoader%5D" or
      nginx.request_uri contains ".resources.context.parent.pipeline" or
      nginx.request_uri contains ".getRuntime" or
      nginx.request_uri contains "getRuntime()" or
      nginx.request_uri icontains "ProcessBuilder" or
      nginx.request_uri icontains "java.lang.Runtime" or
      nginx.request_uri icontains "DefaultAssertionStatus" or
      nginx.request_uri icontains "module.classLoader.resources" or
      nginx.request_uri icontains "module.classLoader.DefaultAssertionStatus" or
      nginx.request_uri icontains "module.classLoader.URLs" or
      nginx.request_uri icontains "class.classLoader" or
      nginx.request_uri icontains "class.protectionDomain"
    )
  output: "[NGINX Emerging Threat] Spring4Shell attack detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, emerging_threats, spring4shell, cve_2022_22965, phase3]
  source: nginx

# ====================================
# ADV_EMRG_003: Apache Struts Exploitation
# ====================================
# Pattern #A302: OGNL class names use icontains, special characters (@, #, %) use contains
- rule: Apache Struts Exploitation
  desc: Detects Apache Struts vulnerability exploitation attempts
  condition: >-
    (
      nginx.request_uri contains "%{#context" or
      nginx.request_uri contains "%{#_memberAccess" or
      nginx.request_uri icontains "ognl.OgnlContext" or
      nginx.request_uri icontains "ognl.ClassResolver" or
      nginx.request_uri contains "#_memberAccess" or
      nginx.request_uri icontains "denyMethodExecution" or
      nginx.request_uri icontains "allowStaticMethodAccess" or
      nginx.request_uri contains "@java.lang.Runtime" or
      nginx.request_uri contains "@java.lang.ProcessBuilder" or
      nginx.request_uri contains ".getRuntime().exec" or
      nginx.request_uri contains "new java.lang.ProcessBuilder" or
      nginx.request_uri contains "%25%7B%23context" or
      nginx.request_uri contains "%25%7B%23_memberAccess" or
      nginx.request_uri contains "redirect:${" or
      nginx.request_uri contains "redirectAction:${" or
      nginx.request_uri contains "action:${" or
      nginx.request_uri contains "method:${}"
    )
  output: "[NGINX Emerging Threat] Apache Struts exploitation detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, emerging_threats, struts, phase3]
  source: nginx

# ====================================
# ADV_EMRG_004: Deserialization Attacks
# ====================================
# Pattern #A302: Java class/method names use icontains, Base64/URL-encoded patterns use contains
- rule: Deserialization Attack Detection
  desc: Detects attempts to exploit deserialization vulnerabilities
  condition: >-
    (
      nginx.request_uri contains "rO0ABX" or
      nginx.request_uri contains "rO0ABXNy" or
      nginx.request_uri contains "H4sIAAAAAAAA" or
      nginx.request_uri icontains "ObjectInputStream" or
      nginx.request_uri icontains "java.io.ObjectInputStream" or
      nginx.request_uri icontains "readObject" or
      nginx.request_uri icontains "writeObject" or
      nginx.request_uri icontains "ysoserial" or
      nginx.request_uri icontains "CommonsCollections" or
      nginx.request_uri icontains "InvokerTransformer" or
      nginx.request_uri icontains "ChainedTransformer" or
      nginx.request_uri icontains "ConstantTransformer" or
      nginx.request_uri icontains "InstantiateTransformer" or
      nginx.request_uri contains "%72%4F%30%41%42%58" or
      nginx.request_uri icontains "pickle.loads" or
      nginx.request_uri contains "__reduce__" or
      nginx.request_uri icontains "yaml.load" or
      nginx.request_uri contains "!!python"
    )
  output: "[NGINX Emerging Threat] Deserialization attack detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, emerging_threats, deserialization, phase3]
  source: nginx

# ====================================
# Combined Emerging Threats Detection
# ====================================
# Pattern #A302: CVE- consolidated to icontains, class names use icontains
- rule: Advanced Emerging Threat Attempt
  desc: Comprehensive detection of emerging threat patterns
  condition: >-
    (
      nginx.request_uri icontains "CVE-" or
      nginx.request_uri contains "${env:" or
      nginx.request_uri contains "${sys:" or
      nginx.request_uri contains "${java:" or
      nginx.request_uri contains "${file:" or
      nginx.request_uri contains "${dns:" or
      nginx.request_uri contains "${url:" or
      nginx.request_uri contains "Runtime.getRuntime" or
      nginx.request_uri icontains "ProcessBuilder" or
      nginx.request_uri icontains "ScriptEngineManager" or
      nginx.request_uri contains "%00" or
      nginx.request_uri contains "null byte"
    )
  output: "[NGINX Emerging Threat] Advanced emerging threat attempt detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: WARNING
  tags: [security, emerging_threats, phase3]
  source: nginx

# ====================================
# ADV_EMRG_005: MongoDB NoSQL Injection
# ====================================
# Pattern #A306: Dedicated MongoDB detection rule
# Previously detected accidentally by CMDi "$" pattern (removed in PR #741)
# This rule provides explicit detection for MongoDB operators
# Test patterns: EMRG_MONGO_001, 002, 003, 004
- rule: MongoDB NoSQL Injection Detection
  desc: Detects MongoDB NoSQL injection attempts via operators
  condition: >-
    (
      nginx.request_uri contains "$where" or
      nginx.request_uri contains "$ne" or
      nginx.request_uri contains "$gt" or
      nginx.request_uri contains "$lt" or
      nginx.request_uri contains "$gte" or
      nginx.request_uri contains "$lte" or
      nginx.request_uri contains "$regex" or
      nginx.request_uri contains "$exists" or
      nginx.request_uri contains "$or" or
      nginx.request_uri contains "$and" or
      nginx.request_uri contains "%24where" or
      nginx.request_uri contains "%24ne" or
      nginx.request_uri contains "%24gt" or
      nginx.request_uri contains "%24lt" or
      nginx.request_uri contains "%24regex" or
      nginx.request_uri contains "%24exists" or
      nginx.request_uri contains "%24or" or
      nginx.request_uri contains "%24and" or
      nginx.request_uri icontains "db.users.find" or
      nginx.request_uri icontains "db.collection.find" or
      nginx.request_uri icontains "this.password" or
      nginx.request_uri icontains "this.username"
    )
  output: "[NGINX Emerging Threat] MongoDB NoSQL injection detected (uri=%nginx.request_uri) (src=%nginx.remote_addr method=%nginx.method status=%nginx.status) test_id=%nginx.test_id category=%nginx.category pattern_id=%nginx.pattern_id"
  priority: CRITICAL
  tags: [security, emerging_threats, mongodb, nosql, phase3]
  source: nginx
