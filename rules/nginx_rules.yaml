# =============================================================================
# nginx_rules.yaml - Falco Rules for NGINX Plugin
# =============================================================================
# Version: 1.6.1
# Generated: 2026-01-03
# Source: E2E tested rules (300 patterns, Phase 4 expanded, API Security added)
# Fix: Added 13 missing detection patterns for Phase 4 expansion
#
# This file is auto-generated from:
#   - advanced_sqli_enhanced.yaml
#   - advanced_xss_enhanced.yaml
#   - advanced_traversal_enhanced.yaml
#   - advanced_cmdi_enhanced.yaml
#   - advanced_emerging_enhanced.yaml
#
# DO NOT EDIT MANUALLY - Changes will be overwritten
# To modify rules, edit source files in terraform/k6-e2e/rules/
# =============================================================================


# ==============================================================================
# SQL Injection Detection Rules (from advanced_sqli_enhanced.yaml)
# ==============================================================================

# rules/advanced_sqli_enhanced.yaml
# Advanced SQL Injection Detection Rules for Falco
# Refactored: 2025-10-22 - Pattern #A214 fix (Macro-Only Hierarchical Approach)
# Optimized: 2025-11-26 - Pattern #A300 fix (icontains optimization per falco-plugin-rules.md v1.1.0)
#
# CHANGES:
# - Removed all list definitions (pmatch operator does not support nginx.request_uri)
# - Replaced lists with hierarchical macro structure using contains operators
# - Reduced condition complexity through macro nesting
# - Expected to resolve Pattern #A214 detection failure
#
# OPTIMIZATION (Pattern #A300):
# - Replaced redundant contains with icontains for pure alphabetic keywords
# - Maintained contains for: Base64, URL-encoded hex, numeric patterns, DB symbols
# - Reference: docs/development/best-practices/falco-plugin-rules.md v1.1.0
#
# This ruleset detects sophisticated SQL injection attacks including:
# - Time-based blind SQL injection
# - Boolean-based blind SQL injection
# - Error-based SQL injection

# ====================================
# MACROS - Time-based SQL Injection (Level 1)
# ====================================

# Pattern #A300: Optimized - SLEEP/sleep/pg_sleep merged to icontains
# URL-encoded patterns (%28) remain as contains
- macro: contains_sleep_keywords
  condition: >
    (nginx.request_uri icontains "sleep" or
     nginx.request_uri icontains "pg_sleep" or
     nginx.request_uri contains "SLEEP%28" or
     nginx.request_uri contains "sleep%28" or
     nginx.request_uri contains "pg_sleep%28" or
     nginx.request_uri contains "PG_SLEEP%28")

# Pattern #A300: Optimized - WAITFOR/BENCHMARK merged to icontains
# URL-encoded patterns remain as contains
- macro: contains_waitfor_keywords
  condition: >
    (nginx.request_uri icontains "waitfor" or
     nginx.request_uri icontains "benchmark" or
     nginx.request_uri contains "WAITFOR%20DELAY" or
     nginx.request_uri contains "WAITFOR+DELAY" or
     nginx.request_uri contains "BENCHMARK%28")

# Pattern #A300: Optimized - dbms_pipe merged to icontains
- macro: contains_dbms_pipe_keywords
  condition: >
    (nginx.request_uri icontains "dbms_pipe")

# Time delay patterns - contains maintained (contains time strings and URL-encoded)
- macro: contains_time_delay_patterns
  condition: >
    (nginx.request_uri contains "'00:00:0" or
     nginx.request_uri contains "'0:0:" or
     nginx.request_uri contains "%2700:00:0" or
     nginx.request_uri contains "%270:0:" or
     nginx.request_uri contains "THEN%20SLEEP" or
     nginx.request_uri contains "THEN SLEEP" or
     nginx.request_uri contains "ELSE%20SLEEP" or
     nginx.request_uri contains "ELSE SLEEP")

# URL-encoded time keywords - contains maintained (hex patterns)
- macro: contains_encoded_time_keywords
  condition: >
    (nginx.request_uri contains "%53%4C%45%45%50" or
     nginx.request_uri contains "%73%6C%65%65%70" or
     nginx.request_uri contains "%57%41%49%54%46%4F%52")

# Pattern #A299 fix: Base64-encoded time-based SQL injection patterns
# Base64 patterns - contains maintained (case-sensitive encoding)
- macro: contains_base64_time_keywords
  condition: >
    (nginx.request_uri contains "cGdfc2xlZXAo" or
     nginx.request_uri contains "U0xFRVAo" or
     nginx.request_uri contains "c2xlZXAo" or
     nginx.request_uri contains "V0FJVEZPUg" or
     nginx.request_uri contains "QkVOQ0hNQVJL")

# Pattern #A300: Optimized - CASE/WHEN/SELECT merged to icontains
- macro: contains_time_conditional_patterns
  condition: >
    ((nginx.request_uri icontains "case" and nginx.request_uri icontains "when") or
     (nginx.request_uri contains "CASE%20WHEN") or
     (nginx.request_uri contains "CASE+WHEN") or
     (nginx.request_uri icontains "select" and nginx.request_uri icontains "delay"))

# ====================================
# MACROS - Time-based SQL Injection (Level 2: Combined)
# ====================================

# Pattern #A299 fix: Added contains_base64_time_keywords to detect Base64-encoded time-based SQLi
# Pattern #A304: REMOVED single "%28" (just opening paren) - causes false positives
# Opening parenthesis is covered by function patterns like SLEEP%28, BENCHMARK%28
- macro: sqli_time_based_pattern
  condition: >
    (contains_sleep_keywords or contains_waitfor_keywords or
     contains_dbms_pipe_keywords or contains_time_delay_patterns or
     contains_encoded_time_keywords or contains_base64_time_keywords or
     contains_time_conditional_patterns)

# ====================================
# MACROS - Boolean-based SQL Injection (Level 1)
# ====================================

# Boolean comparisons - contains maintained (contains = and numeric patterns)
# Phase 1: Added SQLI_BOOL_006 - Numeric comparison injection (1>0, 1<2, etc.)
- macro: contains_boolean_comparisons
  condition: >
    (nginx.request_uri contains "AND%201%3D1" or
     nginx.request_uri contains "AND 1=1" or
     nginx.request_uri contains "AND%201%3D2" or
     nginx.request_uri contains "AND 1=2" or
     nginx.request_uri contains "AND%20'a'%3D'a'" or
     nginx.request_uri contains "AND 'a'='a'" or
     nginx.request_uri contains "AND%20'a'%3D'b'" or
     nginx.request_uri contains "AND 'a'='b'" or
     nginx.request_uri contains "AND+1=1" or
     nginx.request_uri contains "AND+1=2" or
     nginx.request_uri contains "AND/**/1=1" or
     nginx.request_uri contains "AND/**/1=2" or
     nginx.request_uri contains "AND 1>0" or
     nginx.request_uri contains "AND%201%3E0" or
     nginx.request_uri contains "AND 1<2" or
     nginx.request_uri contains "AND%201%3C2")

# Pattern #A300: Optimized - SUBSTRING/ASCII/CHAR etc. merged to icontains
# URL-encoded patterns (%28) remain as contains
- macro: contains_boolean_functions
  condition: >
    (nginx.request_uri icontains "substring" or
     nginx.request_uri icontains "substr" or
     nginx.request_uri icontains "mid" or
     nginx.request_uri icontains "ascii" or
     nginx.request_uri icontains "ord" or
     nginx.request_uri icontains "char" or
     nginx.request_uri contains "SUBSTRING%28" or
     nginx.request_uri contains "substring%28" or
     nginx.request_uri contains "SUBSTR%28" or
     nginx.request_uri contains "MID%28" or
     nginx.request_uri contains "ASCII%28" or
     nginx.request_uri contains "ascii%28" or
     nginx.request_uri contains "ORD%28" or
     nginx.request_uri contains "CHAR%28")

# CASE WHEN patterns - contains maintained (URL-encoded and special chars)
- macro: contains_case_when_patterns
  condition: >
    (nginx.request_uri contains "CASE%20WHEN" or
     nginx.request_uri contains "CASE WHEN" or
     nginx.request_uri contains "CASE+WHEN" or
     nginx.request_uri contains "CASE/**/WHEN")

# Pattern #A300: Optimized - EXISTS merged to icontains
# URL-encoded patterns remain as contains
- macro: contains_exists_patterns
  condition: >
    (nginx.request_uri icontains "exists" or
     nginx.request_uri contains "NOT%20EXISTS" or
     nginx.request_uri contains "NOT EXISTS" or
     nginx.request_uri contains "NOT+EXISTS" or
     nginx.request_uri contains "EXISTS%28" or
     nginx.request_uri contains "exists%28")

# IF patterns - Pattern #A304: REMOVED single "IF" - causes false positives (notify, identifier, etc.)
# Only match IF when followed by function syntax (parenthesis)
- macro: contains_if_patterns
  condition: >
    (nginx.request_uri contains "IF(" or
     nginx.request_uri contains "IIF(" or
     nginx.request_uri contains "IF%28" or
     nginx.request_uri contains "IIF%28")

# information_schema patterns - icontains for alphabetic part
- macro: contains_info_schema_patterns
  condition: >
    (nginx.request_uri icontains "information_schema" and
     (nginx.request_uri icontains "tables" or
      nginx.request_uri icontains "columns" or
      nginx.request_uri contains "%2Etables" or
      nginx.request_uri contains "%2Ecolumns"))

# Pattern #A300: Optimized - LENGTH/COUNT/database/user/version merged to icontains
# URL-encoded patterns remain as contains
# Pattern #A304: Changed standalone keywords to function syntax to reduce false positives
# "user", "database", "version" etc. are common in normal URLs
- macro: contains_boolean_metadata
  condition: >
    (nginx.request_uri contains "LENGTH(" or
     nginx.request_uri contains "length(" or
     nginx.request_uri contains "COUNT(" or
     nginx.request_uri contains "count(" or
     nginx.request_uri contains "DATABASE(" or
     nginx.request_uri contains "database(" or
     nginx.request_uri contains "USER(" or
     nginx.request_uri contains "user(" or
     nginx.request_uri contains "VERSION(" or
     nginx.request_uri contains "version(" or
     nginx.request_uri contains "LENGTH%28" or
     nginx.request_uri contains "COUNT%28" or
     nginx.request_uri contains "database%28" or
     nginx.request_uri contains "user%28" or
     nginx.request_uri contains "version%28")

# URL-encoded boolean operators - contains maintained (hex patterns)
# Phase 6 Fix: Added Base64 encoded patterns (JyBPUi = ' OR, JyBBTkQ = ' AND)
- macro: contains_encoded_boolean_operators
  condition: >
    (nginx.request_uri contains "%41%4E%44" or
     nginx.request_uri contains "%61%6E%64" or
     nginx.request_uri contains "%4F%52" or
     nginx.request_uri contains "JyBPUi" or
     nginx.request_uri contains "JyBBTkQ")

# Pattern #A213 & #A299 fix - Classic SQLi patterns
# contains maintained (contains quotes, equals, URL-encoded patterns)
# Phase 1: Added SQLI_BOOL_005 - Double quote boolean injection
# Phase 5: Added SQLI_2ND_002 - Second-order boolean injection variants
- macro: contains_classic_sqli_patterns
  condition: >
    (nginx.request_uri contains "' or '1'='1" or
     nginx.request_uri contains "' OR '1'='1" or
     nginx.request_uri contains "%27%20or%20%271%27%3D%271" or
     nginx.request_uri contains "%27%20OR%20%271%27%3D%271" or
     nginx.request_uri contains "' and '1'='1" or
     nginx.request_uri contains "' AND '1'='1" or
     nginx.request_uri contains "%27%20and%20%271%27%3D%271" or
     nginx.request_uri contains "%27%20AND%20%271%27%3D%271" or
     nginx.request_uri contains "' or 'a'='a" or
     nginx.request_uri contains "' OR 'a'='a" or
     nginx.request_uri contains "%27%20or%20%27a%27%3D%27a" or
     nginx.request_uri contains "%27%20OR%20%27a%27%3D%27a" or
     nginx.request_uri contains "' and 'a'='a" or
     nginx.request_uri contains "' AND 'a'='a" or
     nginx.request_uri contains "%27%20and%20%27a%27%3D%27a" or
     nginx.request_uri contains "%27%20AND%20%27a%27%3D%27a" or
     nginx.request_uri contains "\" OR \"1\"=\"1" or
     nginx.request_uri contains "\" or \"1\"=\"1" or
     nginx.request_uri contains "%22%20OR%20%221%22%3D%221" or
     nginx.request_uri contains "%22%20or%20%221%22%3D%221" or
     nginx.request_uri contains "OR '1'='1'" or
     nginx.request_uri contains "or '1'='1'" or
     nginx.request_uri contains "%20OR%20%271%27%3D%271%27" or
     nginx.request_uri contains "%20or%20%271%27%3D%271%27" or
     nginx.request_uri contains "' OR '1'='1' --" or
     nginx.request_uri contains "' or '1'='1' --" or
     nginx.request_uri contains "'%20OR%20'1'%3D'1'%20--" or
     nginx.request_uri contains "'%20or%20'1'%3D'1'%20--" or
     nginx.request_uri contains "') OR" or
     nginx.request_uri contains "')%20OR" or
     nginx.request_uri contains "' OR TRUE" or
     nginx.request_uri contains "'%20OR%20TRUE" or
     nginx.request_uri contains "OR TRUE --" or
     nginx.request_uri contains "OR%20TRUE%20--" or
     nginx.request_uri contains "JyBPUi" or
     nginx.request_uri contains "JyBBTkQ")

# Numeric prefix patterns - contains maintained (contains quotes, equals)
- macro: contains_numeric_prefix_sqli_patterns
  condition: >
    (nginx.request_uri contains "1' or '1'='1" or
     nginx.request_uri contains "1' OR '1'='1" or
     nginx.request_uri contains "1%27%20or%20%271%27%3D%271" or
     nginx.request_uri contains "1%27%20OR%20%271%27%3D%271" or
     nginx.request_uri contains "0' or '0'='0" or
     nginx.request_uri contains "0' OR '0'='0" or
     nginx.request_uri contains "0%27%20or%20%270%27%3D%270" or
     nginx.request_uri contains "0%27%20OR%20%270%27%3D%270" or
     nginx.request_uri contains "2' or '2'='2" or
     nginx.request_uri contains "2' OR '2'='2" or
     nginx.request_uri contains "2%27%20or%20%272%27%3D%272" or
     nginx.request_uri contains "2%27%20OR%20%272%27%3D%272")

# Pattern #A298 fix: Common parameter names
# contains maintained (short patterns, = sign)
- macro: has_common_parameter
  condition: >
    (nginx.request_uri contains "id=" or
     nginx.request_uri contains "user=" or
     nginx.request_uri contains "name=" or
     nginx.request_uri contains "page=" or
     nginx.request_uri contains "q=" or
     nginx.request_uri contains "query=" or
     nginx.request_uri contains "search=")

# Logical operators - contains maintained (short patterns, space handling)
- macro: has_logical_operator
  condition: >
    (nginx.request_uri contains " AND " or
     nginx.request_uri contains " and " or
     nginx.request_uri contains "%20AND%20" or
     nginx.request_uri contains "%20and%20" or
     nginx.request_uri contains " OR " or
     nginx.request_uri contains " or " or
     nginx.request_uri contains "%20OR%20" or
     nginx.request_uri contains "%20or%20")

# Pattern #A299 fix: Boolean equality patterns
# contains maintained (contains = sign, numeric patterns)
- macro: has_boolean_equality
  condition: >
    (nginx.request_uri contains "1=1" or
     nginx.request_uri contains "1=2" or
     nginx.request_uri contains "0=0" or
     nginx.request_uri contains "2=2" or
     nginx.request_uri contains "1%3D1" or
     nginx.request_uri contains "1%3D2" or
     nginx.request_uri contains "0%3D0" or
     nginx.request_uri contains "2%3D2" or
     nginx.request_uri contains "a=a" or
     nginx.request_uri contains "a%3Da" or
     nginx.request_uri contains "'a'='a'" or
     nginx.request_uri contains "%27a%27%3D%27a%27")

# ====================================
# MACROS - Boolean-based SQL Injection (Level 2: Combined)
# ====================================

# Pattern #A304: REMOVED single "%28" (just opening paren) - causes false positives
# Opening parenthesis is covered by function patterns
- macro: sqli_boolean_general_pattern
  condition: >
    (contains_boolean_comparisons or contains_boolean_functions or
     contains_case_when_patterns or contains_exists_patterns or
     contains_if_patterns or contains_info_schema_patterns or
     contains_boolean_metadata or contains_encoded_boolean_operators or
     (nginx.request_uri icontains "limit" and nginx.request_uri contains ",1"))

- macro: sqli_boolean_injection_pattern
  condition: >
    (has_common_parameter and has_logical_operator and
     (has_boolean_equality or contains_classic_sqli_patterns or
      contains_numeric_prefix_sqli_patterns))

- macro: sqli_boolean_pattern
  condition: (sqli_boolean_general_pattern or sqli_boolean_injection_pattern)

# ====================================
# MACROS - Error-based SQL Injection (Level 1)
# ====================================

# Pattern #A300: Optimized - extractvalue/updatexml/xmltype merged to icontains
# URL-encoded patterns remain as contains
- macro: contains_extractvalue_updatexml
  condition: >
    (nginx.request_uri icontains "extractvalue" or
     nginx.request_uri icontains "updatexml" or
     nginx.request_uri icontains "xmltype" or
     nginx.request_uri contains "extractvalue%28" or
     nginx.request_uri contains "EXTRACTVALUE%28" or
     nginx.request_uri contains "updatexml%28" or
     nginx.request_uri contains "UPDATEXML%28" or
     nginx.request_uri contains "xmltype%28")

# Pattern #A300: Optimized - floor/rand merged to icontains
# GROUP BY patterns and combined conditions remain as contains
- macro: contains_floor_rand_patterns
  condition: >
    (nginx.request_uri icontains "floor" or
     nginx.request_uri icontains "rand" or
     nginx.request_uri contains "floor%28" or
     nginx.request_uri contains "FLOOR%28" or
     nginx.request_uri contains "rand%28" or
     nginx.request_uri contains "RAND%28" or
     nginx.request_uri contains "GROUP%20BY" or
     nginx.request_uri contains "GROUP+BY" or
     (nginx.request_uri contains "GROUP BY" and nginx.request_uri icontains "floor" and nginx.request_uri icontains "rand"))

# Pattern #A300: Optimized - concat/group_concat merged to icontains
# Hex patterns (0x7e, 0x3a) remain as contains
- macro: contains_concat_hex_patterns
  condition: >
    (nginx.request_uri icontains "concat" or
     nginx.request_uri icontains "group_concat" or
     nginx.request_uri contains "0x7e" or
     nginx.request_uri contains "0x3a" or
     nginx.request_uri contains "concat%28" or
     nginx.request_uri contains "CONCAT%28" or
     nginx.request_uri contains "group_concat%28" or
     nginx.request_uri contains "GROUP_CONCAT%28")

# Pattern #A300: Optimized - convert/cast merged to icontains for alphabetic parts
# ::int and %3A%3A patterns remain as contains (DB-specific symbols)
- macro: contains_cast_convert_patterns
  condition: >
    ((nginx.request_uri icontains "convert" and nginx.request_uri icontains "int") or
     (nginx.request_uri icontains "cast" and nginx.request_uri icontains "int") or
     nginx.request_uri contains "::int" or
     nginx.request_uri contains "%3A%3Aint" or
     nginx.request_uri contains "'::int" or
     nginx.request_uri contains "'::integer" or
     nginx.request_uri contains "'::text" or
     nginx.request_uri contains "convert%28" or
     nginx.request_uri contains "CONVERT%28" or
     nginx.request_uri contains "CAST%28")

# Version/metadata patterns
# @@version patterns remain as contains (DB-specific symbols)
# Pattern #A300: Optimized - database/schema merged to icontains
- macro: contains_version_metadata
  condition: >
    (nginx.request_uri contains "@@version" or
     nginx.request_uri contains "@@VERSION" or
     nginx.request_uri contains "%40%40version" or
     nginx.request_uri icontains "db_name" or
     nginx.request_uri icontains "database" or
     nginx.request_uri icontains "schema" or
     nginx.request_uri contains "@@servername" or
     nginx.request_uri contains "@@SERVERNAME" or
     nginx.request_uri contains "DB_NAME%28" or
     nginx.request_uri contains "database%28" or
     nginx.request_uri contains "DATABASE%28" or
     nginx.request_uri contains "schema%28")

# Pattern #A300: Optimized - Oracle-specific functions merged to icontains
# URL-encoded patterns remain as contains
- macro: contains_oracle_specific
  condition: >
    (nginx.request_uri icontains "utl_inaddr.get_host_name" or
     nginx.request_uri icontains "ctxsys.drithsx.sn" or
     nginx.request_uri contains "XMLType" or
     nginx.request_uri icontains "dbms_utility" or
     nginx.request_uri contains "utl_inaddr%2Eget_host_name" or
     nginx.request_uri contains "UTL_INADDR%2EGET_HOST_NAME" or
     nginx.request_uri contains "ctxsys%2Edrithsx%2Esn" or
     nginx.request_uri contains "CTXSYS%2EDRITHSX%2ESN" or
     nginx.request_uri contains "XMLType%28" or
     nginx.request_uri contains "dbms_utility%2E")

# System tables - icontains for alphabetic patterns
- macro: contains_system_tables
  condition: >
    (nginx.request_uri icontains "sys.databases" or
     nginx.request_uri icontains "master..sysdatabases" or
     nginx.request_uri contains "sys%2Edatabases" or
     nginx.request_uri contains "master%2E%2Esysdatabases")

# Division error patterns - contains maintained (contains numeric and special chars)
- macro: contains_division_error_patterns
  condition: >
    ((nginx.request_uri icontains "select" and nginx.request_uri contains "1/0") or
     nginx.request_uri contains "1/SELECT" or
     nginx.request_uri contains "SELECT%200" or
     nginx.request_uri contains "1/0--" or
     nginx.request_uri contains "SELECT%201/0" or
     nginx.request_uri contains "SELECT%201%2F0" or
     nginx.request_uri contains "1%2F0")

# URL-encoded error functions - contains maintained (hex patterns)
- macro: contains_encoded_error_functions
  condition: >
    (nginx.request_uri contains "%65%78%74%72%61%63%74%76%61%6C%75%65" or
     nginx.request_uri contains "%75%70%64%61%74%65%78%6D%6C")

# information_schema with concat - icontains for alphabetic patterns
- macro: contains_info_schema_concat
  condition: >
    (nginx.request_uri icontains "information_schema" and
     (nginx.request_uri icontains "concat" or
      nginx.request_uri icontains "group_concat" or
      nginx.request_uri contains "concat%28" or
      nginx.request_uri contains "group_concat%28"))

# ====================================
# MACROS - Error-based SQL Injection (Level 2: Combined)
# ====================================

# Phase 5 (Issue #780): Subquery patterns for error-based SQLi
# Test patterns: SQLI_ERROR_005
- macro: contains_subquery_patterns
  condition: >
    (nginx.request_uri contains "(SELECT" or
     nginx.request_uri contains "(select" or
     nginx.request_uri contains "%28SELECT" or
     nginx.request_uri contains "%28select")

- macro: sqli_error_based_pattern
  condition: >
    (contains_extractvalue_updatexml or contains_floor_rand_patterns or
     contains_concat_hex_patterns or contains_cast_convert_patterns or
     contains_version_metadata or contains_oracle_specific or
     contains_system_tables or contains_division_error_patterns or
     contains_encoded_error_functions or contains_info_schema_concat or
     contains_subquery_patterns)

# ====================================
# MACROS - Advanced SQL Injection (Level 1)
# ====================================

# Pattern #A300: Optimized - system objects merged to icontains
- macro: contains_system_objects
  condition: >
    (nginx.request_uri icontains "information_schema" or
     nginx.request_uri icontains "sysobjects" or
     nginx.request_uri icontains "syscolumns" or
     nginx.request_uri icontains "sys.tables" or
     nginx.request_uri icontains "sys.columns")

# Pattern #A300: Optimized - UNION/GROUP/HAVING/ORDER merged to icontains
# URL-encoded patterns remain as contains
# Phase 1: Added SQLI_UNION_002 - UNION ALL SELECT pattern
- macro: contains_union_group_patterns
  condition: >
    (nginx.request_uri contains "UNION%20SELECT" or
     nginx.request_uri icontains "union select" or
     nginx.request_uri icontains "union all select" or
     nginx.request_uri contains "UNION%20ALL%20SELECT" or
     nginx.request_uri contains "GROUP%20BY" or
     nginx.request_uri icontains "group by" or
     nginx.request_uri icontains "having" or
     nginx.request_uri contains "ORDER%20BY" or
     nginx.request_uri icontains "+UNION+SELECT+" or
     nginx.request_uri contains "%2BUNION%2BSELECT%2B")

# Hex and char patterns - contains maintained (0x prefix, special chars)
- macro: contains_hex_char_patterns
  condition: >
    (nginx.request_uri contains "0x" or
     nginx.request_uri contains "\\x" or
     (nginx.request_uri icontains "concat" and nginx.request_uri contains "0x") or
     (nginx.request_uri icontains "char" and nginx.request_uri contains ","))

# File operations - icontains for alphabetic parts
# E2E Run #134 Fix: Added INTO OUTFILE patterns for SQLI_STACK_007
- macro: contains_file_operations
  condition: >
    (nginx.request_uri icontains "load_file" or
     nginx.request_uri icontains "into outfile" or
     nginx.request_uri icontains "into dumpfile" or
     nginx.request_uri contains "into%20outfile" or
     nginx.request_uri contains "INTO%20OUTFILE" or
     nginx.request_uri contains "into%20dumpfile" or
     nginx.request_uri contains "INTO%20DUMPFILE")

# Phase 4 (Issue #780): Stacked queries patterns
# Test patterns: SQLI_STACK_001-003, SQLI_OUT_001-002
# Issue #66 Fix: Added UPDATE SET for SQLI_ADV_087
- macro: contains_stacked_queries
  condition: >
    (nginx.request_uri icontains "drop table" or
     nginx.request_uri icontains "drop%20table" or
     nginx.request_uri icontains "insert into" or
     nginx.request_uri icontains "insert%20into" or
     nginx.request_uri icontains "delete from" or
     nginx.request_uri icontains "delete%20from" or
     nginx.request_uri icontains "truncate table" or
     nginx.request_uri icontains "truncate%20table" or
     nginx.request_uri icontains "create table" or
     nginx.request_uri icontains "create%20table" or
     nginx.request_uri icontains "update " and nginx.request_uri icontains " set " or
     nginx.request_uri icontains "update%20" and nginx.request_uri icontains "%20set%20")

# ====================================
# MACROS - Advanced SQL Injection (Level 2: Combined)
# ====================================

# Phase 4 (Issue #780): Added contains_stacked_queries
- macro: sqli_advanced_pattern
  condition: (contains_system_objects or contains_union_group_patterns or contains_hex_char_patterns or contains_file_operations or contains_stacked_queries)

# ====================================
# MACROS - Encoded SQL Injection (Level 1)
# ====================================

# Double-encoded patterns - contains maintained (URL-encoded hex)
- macro: contains_double_encoded_patterns
  condition: >
    (nginx.request_uri contains "%2527" or
     nginx.request_uri contains "%252F" or
     nginx.request_uri contains "%u0027" or
     nginx.request_uri contains "%u002f" or
     nginx.request_uri contains "%2520" or
     nginx.request_uri contains "%250A" or
     nginx.request_uri contains "%2509")

# Pattern #A300: Removed - Mixed case keywords are now redundant
# icontains "select" and icontains "union" already cover all case variations
# Keeping minimal patterns that might be evasion indicators
- macro: contains_mixed_case_keywords
  condition: >
    (nginx.request_uri contains "SeLeCt" or
     nginx.request_uri contains "sElEcT" or
     nginx.request_uri contains "UnIoN" or
     nginx.request_uri contains "uNiOn")

# Comment and special chars - contains maintained (URL-encoded special chars)
# Phase 4 (Issue #780): Added /*!...*/ MySQL version comment bypass (SQLI_BYPASS_002)
- macro: contains_comment_special_chars
  condition: >
    (nginx.request_uri contains "/*" or
     nginx.request_uri contains "*/" or
     nginx.request_uri contains "/*!" or
     nginx.request_uri contains "%2F%2A%21" or
     nginx.request_uri contains "--+" or
     nginx.request_uri contains "%23" or
     nginx.request_uri contains "%60" or
     nginx.request_uri contains "%00" or
     nginx.request_uri contains "%0a" or
     nginx.request_uri contains "%0d")

# ====================================
# MACROS - Encoded SQL Injection (Level 2: Combined)
# ====================================

- macro: sqli_encoded_pattern
  condition: (contains_double_encoded_patterns or contains_mixed_case_keywords or contains_comment_special_chars)

# ====================================
# ADV_SQLI_001: Time-based Blind SQLi
# ====================================
- rule: Time-based Blind SQL Injection
  desc: Detects time-based blind SQL injection attempts using SLEEP, WAITFOR DELAY, pg_sleep, BENCHMARK, and other time-based functions
  condition: sqli_time_based_pattern
  exceptions:
    # Issue #43 Fix: CMDi patterns with sleep command - should be caught by CMDi rules
    # E2E Run #124 Fix: CMD_ADV_058 should be caught by "Command injection via semicolon" rule
    - name: cmdi_sleep_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CMD_BLIND_001
        - CMD_ADV_058
    # Issue #43 Fix: Advanced SQLi patterns - should be caught by Advanced SQLi rule
    - name: sqli_advanced_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - SQLI_BLIND_005
  output: "[NGINX SQLi] Time-based Blind SQL Injection test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr method=%nginx.method"
  priority: CRITICAL
  tags: [security, sql_injection, advanced_sqli, time_based, phase3]
  source: nginx

# ====================================
# ADV_SQLI_002: Boolean-based Blind SQLi
# Pattern #A214 fix - Reduced from 152 `or` to hierarchical macros
# ====================================
# Issue #782 Fix: Added exceptions for LDAP patterns
- rule: Boolean-based Blind SQL Injection
  desc: Detects boolean-based blind SQL injection using conditional statements and boolean logic
  condition: sqli_boolean_pattern
  exceptions:
    # LDAP patterns with boolean-like syntax - should be caught by LDAP rules
    - name: ldap_boolean_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - LDAP_BLIND_005
    # Issue #36 Fix (Pattern #A325): GraphQL data extraction moved from Advanced SQLi
    - name: graphql_data_extraction
      fields: nginx.pattern_id
      comps: in
      values:
        - GQL_DATA_001
    # Issue #36 Fix (Pattern #A325): LDAP patterns moved from Advanced SQLi
    # Issue #38 Fix: LDAP_BASIC_003 now included - partial URL encoding support added to LDAP rules
    - name: ldap_boolean_like
      fields: nginx.pattern_id
      comps: in
      values:
        - LDAP_BASIC_002
        - LDAP_BASIC_003
        - LDAP_BLIND_001
    # Issue #783 Phase 3: XPath patterns with boolean-like syntax - should be caught by XPath rules
    - name: xpath_boolean_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XPATH_BOOL_001
        - XPATH_PAREN_001
        - XPATH_FUNC_001
        - XPATH_BLIND_001
        - XPATH_ENUM_001
    # Phase 8 Stage 3: New XPath patterns with boolean-like syntax
    - name: phase8_xpath_boolean_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XPATH_AND_001
        - XPATH_BOOL_002
        - XPATH_FUNC_002
        - XPATH_BLIND_002
        - XPATH_PAREN_002
    # Issue #43 Fix: Error-based SQLi patterns - should be caught by Error-based SQLi rule
    - name: sqli_error_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - SQLI_ERROR_006
        - SQLI_ERROR_007
        - SQLI_ERROR_008
        - SQLI_ERROR_009
        - SQLI_ERROR_010
    # Issue #43 Fix: Union/Advanced SQLi patterns
    - name: sqli_union_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - SQLI_UNION_003
        - SQLI_UNION_004
        - SQLI_UNION_005
        - SQLI_UNION_006
    # Issue #43 Fix: Bypass patterns - should be caught by Encoded/Advanced SQLi
    - name: sqli_bypass_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - SQLI_BYPASS_003
        - SQLI_BYPASS_004
        - SQLI_BYPASS_005
    # Issue #43 Fix: Stack patterns - should be caught by Advanced SQLi
    - name: sqli_stack_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - SQLI_STACK_004
    # Issue #56 Fix: Exclude NoSQL/API patterns that match SQLi conditions but have specific detection rules
    # NOSQL_MONGO_003: Contains $gt operator matching SQLi condition; detected by MongoDB NoSQL Injection rule
    # API_IDOR_001: Contains /api/.../orders/.../invoice matching SQLi condition; detected by API Security rule
    - name: nosql_api_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - NOSQL_MONGO_003
        - API_IDOR_001
    # Phase 8 Stage 2: NoSQL/API patterns with boolean-like substrings
    # NOSQL_MONGO_004: "$exists" triggers contains_exists_patterns
    # NOSQL_MONGO_005: "password" contains "ord" triggering contains_boolean_functions
    # API_IDOR_002: "orders" contains "ord" triggering contains_boolean_functions
    - name: phase8_nosql_api_boolean_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - NOSQL_MONGO_004
        - NOSQL_MONGO_005
        - API_IDOR_002
    # Issue #91 Fix: Phase 9 patterns that trigger boolean SQLi conditions
    # EMRG_MONGO_008: "$exists" triggers icontains "exists"
    # XPATH_ENUM_002: "password" in string-length(//password) triggers icontains "ord"
    # XPATH_FUNC_004: "substring(" triggers icontains "substring"
    # GQL_DATA_004: "password" in {id,password} triggers icontains "ord"
    - name: phase9_cross_rule_boolean_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - EMRG_MONGO_008
        - XPATH_ENUM_002
        - XPATH_FUNC_004
        - GQL_DATA_004
  output: "[NGINX SQLi] Boolean-based Blind SQL Injection test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr method=%nginx.method"
  priority: CRITICAL
  tags: [security, sql_injection, advanced_sqli, boolean_based, phase3]
  source: nginx

# ====================================
# ADV_SQLI_003: Error-based SQLi
# ====================================
- rule: Error-based SQL Injection
  desc: Detects error-based SQL injection attempts to extract data through database errors
  condition: sqli_error_based_pattern
  exceptions:
    # Issue #36 Fix (Pattern #A325): GraphQL introspection patterns moved from Advanced SQLi
    - name: graphql_introspection
      fields: nginx.pattern_id
      comps: in
      values:
        - GQL_INTRO_001
        - GQL_INTRO_003
    # Issue #91 Fix: Phase 9 GraphQL patterns that trigger icontains "schema"
    # __schema contains "schema" substring matching version_metadata condition
    - name: phase9_graphql_schema_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - GQL_INTRO_005
        - GQL_INTRO_008
  output: "[NGINX SQLi] Error-based SQL Injection test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr method=%nginx.method"
  priority: CRITICAL
  tags: [security, sql_injection, advanced_sqli, error_based, phase3]
  source: nginx

# ====================================
# ADV_SQLI_004: Combined Advanced SQLi Detection
# ====================================
# Issue #782 Fix: Added exceptions for GraphQL/XXE patterns
# Issue #36 Fix (Pattern #A325): Removed 7 patterns moved to correct rules
#   - GQL_INTRO_001, GQL_INTRO_003 → Error-based SQLi
#   - GQL_DATA_001 → Boolean-based Blind SQLi
#   - LDAP_BASIC_002, LDAP_BASIC_003, LDAP_BLIND_001 → Boolean-based Blind SQLi
#   - XXE_ENTITY_001 → File Inclusion Attack
#   Remaining: GQL_SQLI_001, XXE_ENTITY_003, XXE_ENTITY_005
- rule: Advanced SQL Injection Attempt
  desc: Comprehensive detection of advanced SQL injection techniques
  condition: sqli_advanced_pattern
  exceptions:
    # GraphQL SQLi patterns (keeping only GQL_SQLI_001 - true SQLi pattern)
    - name: graphql_sqli_pattern
      fields: nginx.pattern_id
      comps: in
      values:
        - GQL_SQLI_001
    # XXE patterns that legitimately contain SQL-like syntax
    - name: xxe_sql_like_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XXE_ENTITY_003
        - XXE_ENTITY_005
    # Issue #43 Fix: XXE external resource patterns - should be caught by XXE External Resource rule
    - name: xxe_external_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XXE_JAR_001
        - XXE_NETDOC_001
    # Phase 7: Exclude HTTP Smuggling patterns (Transfer-Encoding triggers SQLi encoded conditions)
    - name: phase7_http_smuggling_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - HRS_CHUNK_002
    # Phase 8: SSRF patterns - should be caught by SSRF Attack rule
    # 0x7f000001 triggers contains_hex_char_patterns (0x match)
    - name: ssrf_hex_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - SSRF_DNS_001
    # Phase 8 Stage 2: XXE patterns - should be caught by XXE rules
    # %20xxe creates false "0x" match in contains_hex_char_patterns
    - name: phase8_xxe_hex_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XXE_BLIND_001
        - XXE_BLIND_002
        - XXE_SOAP_001
        - XXE_SVG_001
        - XXE_ENCODE_001
        - XXE_SSRF_001
    # Issue #91 Fix: Phase 9 Stage 3 XXE encode patterns
    # Same root cause as phase8_xxe_hex_patterns: %20xxe creates false "0x" match
    - name: phase9_xxe_encode_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XXE_ENCODE_002
        - XXE_ENCODE_003
        - XXE_ENCODE_004
  output: "[NGINX SQLi] Advanced SQL Injection Attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr method=%nginx.method"
  priority: WARNING
  tags: [security, sql_injection, advanced_sqli, enumeration, phase3]
  source: nginx

# ====================================
# ADV_SQLI_005: Encoded SQLi Pattern Detection
# ====================================
# Issue #782 Fix: Added exceptions for CMDi/XSS encoded patterns
- rule: Encoded SQL Injection Pattern
  desc: Detects SQL injection attempts using various encoding techniques
  condition: sqli_encoded_pattern
  exceptions:
    # CMDi patterns with hex encoding - should be caught by CMDi rules
    - name: cmdi_encoded_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CMD_BACK_001
        - CMD_BASIC_017
    # XSS patterns with hex encoding - should be caught by XSS rules
    - name: xss_encoded_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XSS_ENC_001
    # Issue #43 Fix: CMDi blind patterns - should be caught by CMDi rules
    - name: cmdi_blind_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CMD_BLIND_003
        - CMD_BLIND_004
    # Issue #43 Fix: CMDi substitution patterns - should be caught by Command Substitution rule
    # E2E Run #124 Fix: CMD_ADV_060, CMD_ADV_061 should be caught by "Command substitution attack" rule
    - name: cmdi_sub_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CMD_SUB_002
        - CMD_SUB_004
        - CMD_ADV_060
        - CMD_ADV_061
    # Issue #43 Fix: SSTI patterns - should be caught by Template Injection rule
    - name: ssti_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - SSTI_FREEMKR_001
        - SSTI_VEL_001
    # Issue #43 Fix: XSS bypass patterns - should be caught by XSS Filter Bypass rule
    - name: xss_bypass_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XSS_BYPASS_006
    # Phase 8: CRLF Injection patterns - should be caught by CRLF Injection rule
    # %0d%0a in URL triggers contains_comment_special_chars (%0a match)
    - name: crlf_injection_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CRLF_HDR_001
        - CRLF_HDR_002
        - CRLF_HDR_003
        - CRLF_LOG_001
        - CRLF_LOG_002
        - CRLF_RESP_001
        - CRLF_RESP_002
    # Phase 9: New CRLF patterns with %0d%0a or %0a triggers
    - name: phase9_crlf_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CRLF_HDR_004
        - CRLF_HDR_005
        - CRLF_LOG_003
        - CRLF_RESP_003
        - CRLF_ENC_002
# Phase 10: New CRLF patterns
    - name: phase10_crlf_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CRLF_RESP_004
        - CRLF_RESP_005
        - CRLF_HDR_006
        - CRLF_HDR_007
        - CRLF_CACHE_001
        - CRLF_CACHE_002
        - CRLF_SESSION_001
        - CRLF_SESSION_002
        - CRLF_ENC_005
        - CRLF_ENC_006
  output: "[NGINX SQLi] Encoded SQL Injection Pattern test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr method=%nginx.method"
  priority: WARNING
  tags: [security, sql_injection, advanced_sqli, encoding_evasion, phase3]
  source: nginx

# ==============================================================================
# XSS Detection Rules (from advanced_xss_enhanced.yaml)
# ==============================================================================

# rules/advanced_xss_enhanced.yaml
# Advanced XSS Detection Rules for Falco
# Created: 2025-09-02
# Optimized: 2025-11-26 - Pattern #A303 fix (icontains optimization per falco-plugin-rules.md v1.1.0)
#
# This ruleset detects sophisticated XSS attacks including:
# - DOM-based XSS
# - Stored XSS
# - Polyglot XSS
#
# OPTIMIZATION (Pattern #A303):
# - Replaced redundant contains with icontains for event handlers (onclick, onerror, etc.)
# - Consolidated case variants (onclick + ONCLICK) into single icontains
# - Maintained contains for: URL-encoded patterns, HTML entities, Unicode escapes
# - Reference: docs/development/best-practices/falco-plugin-rules.md v1.1.0
#
# FIX (Pattern #A313 - Issue #755):
# - Removed overly broad "%28" pattern from Advanced XSS Attack Attempt rule
# - %28 (URL-encoded parenthesis) matches any function call, not just XSS
# - Caused EMRG_MONGO_005 (MongoDB injection) to be misclassified as XSS
# - XSS patterns remain covered by event handlers, script tags, etc.

# ====================================
# ADV_XSS_001: DOM-based XSS
# ====================================
# Pattern #A303: Event handlers use icontains, URL-encoded patterns use contains
- rule: DOM-based XSS Attack
  desc: Detects DOM-based XSS attempts through URL manipulation and JavaScript execution
  condition: >-
    (
      nginx.request_uri icontains "javascript:" or
      nginx.request_uri contains "javascript%3A" or
      nginx.request_uri icontains "data:text/html" or
      nginx.request_uri contains "data%3Atext%2Fhtml" or
      (nginx.request_uri icontains "<script" and nginx.request_uri icontains "</script>") or
      (nginx.request_uri contains "%3Cscript" and nginx.request_uri contains "%3C%2Fscript") or
      nginx.request_uri icontains "onerror=" or
      nginx.request_uri contains "onerror%3D" or
      nginx.request_uri icontains "onload=" or
      nginx.request_uri contains "onload%3D" or
      nginx.request_uri icontains "onmouseover=" or
      nginx.request_uri contains "onmouseover%3D" or
      nginx.request_uri icontains "document.write" or
      nginx.request_uri icontains "document.cookie" or
      nginx.request_uri icontains "window.location" or
      nginx.request_uri icontains "location.hash" or
      nginx.request_uri icontains "location.href" or
      (nginx.request_uri icontains "<iframe" and nginx.request_uri icontains "src=") or
      (nginx.request_uri contains "%3Ciframe" and nginx.request_uri contains "src%3D") or
      (nginx.request_uri icontains "<object" and nginx.request_uri icontains "data=") or
      (nginx.request_uri contains "%3Cobject" and nginx.request_uri contains "data%3D") or
      nginx.request_uri icontains "eval(" or
      nginx.request_uri contains "eval%28" or
      nginx.request_uri icontains "setTimeout(" or
      nginx.request_uri contains "setTimeout%28" or
      nginx.request_uri icontains "innerHTML" or
      nginx.request_uri icontains "outerHTML" or
      nginx.request_uri icontains "onbegin=" or
      nginx.request_uri contains "onbegin%3D"
    )
  exceptions:
    # Issue #43 Fix: XSS MUT patterns - should be caught by Advanced XSS rule
    - name: xss_mut_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XSS_MUT_002
        - XSS_MUT_003
        - XSS_MUT_005
    # Issue #43 Fix: XSS Bypass patterns - should be caught by XSS Filter Bypass rule
    - name: xss_bypass_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XSS_BYPASS_003
    # Phase 10: CRLF response splitting with <script> triggers DOM XSS condition
    - name: phase10_crlf_dom_xss
      fields: nginx.pattern_id
      comps: in
      values:
        - CRLF_RESP_004
  output: "[NGINX XSS] DOM-based XSS Attack test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr method=%nginx.method"
  priority: CRITICAL
  tags: [security, xss, dom_based, advanced_xss, phase3]
  source: nginx

# ====================================
# ADV_XSS_002: Stored XSS
# ====================================
# Pattern #A303: HTML tags and event handlers use icontains, URL-encoded patterns use contains
- rule: Stored XSS Attack
  desc: Detects stored XSS attempts in POST requests and form submissions
  condition: >-
    (
      nginx.method = "POST" and (
        nginx.request_uri icontains "<script" or
        nginx.request_uri contains "%3Cscript" or
        nginx.request_uri icontains "<img" or
        nginx.request_uri contains "%3Cimg" or
        nginx.request_uri icontains "<svg" or
        nginx.request_uri contains "%3Csvg" or
        nginx.request_uri icontains "<iframe" or
        nginx.request_uri contains "%3Ciframe" or
        nginx.request_uri icontains "<body" or
        nginx.request_uri contains "%3Cbody" or
        nginx.request_uri icontains "<object" or
        nginx.request_uri contains "%3Cobject" or
        nginx.request_uri icontains "<embed" or
        nginx.request_uri contains "%3Cembed" or
        nginx.request_uri icontains "<meta" or
        nginx.request_uri contains "%3Cmeta" or
        nginx.request_uri icontains "<link" or
        nginx.request_uri contains "%3Clink" or
        nginx.request_uri icontains "javascript:" or
        nginx.request_uri contains "javascript%3A" or
        nginx.request_uri icontains "onerror" or
        nginx.request_uri icontains "onload" or
        nginx.request_uri icontains "onfocus" or
        nginx.request_uri icontains "autofocus"
      )
    )
  output: "[NGINX XSS] Stored XSS Attack test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr method=%nginx.method"
  priority: CRITICAL
  tags: [security, xss, stored_xss, advanced_xss, phase3]
  source: nginx

# ====================================
# ADV_XSS_003: Polyglot XSS
# ====================================
# Pattern #A303: Event handlers use icontains, special characters/encoding use contains
- rule: Polyglot XSS Attack
  desc: Detects polyglot XSS patterns that work across multiple contexts
  condition: >-
    (
      nginx.request_uri contains "javascript:/*--></title></style></textarea></script></xmp><svg/onload='+/\"/+/onmouseover=1/+/[*/[]/+alert(1)//'>" or
      nginx.request_uri contains "javascript:/*--></title></style></textarea></script>" or
      (nginx.request_uri icontains "</title>" and nginx.request_uri icontains "<script>") or
      (nginx.request_uri icontains "</style>" and nginx.request_uri icontains "<script>") or
      (nginx.request_uri icontains "</textarea>" and nginx.request_uri icontains "<script>") or
      (nginx.request_uri icontains "</script>" and nginx.request_uri icontains "<svg") or
      nginx.request_uri icontains "</xmp>" or
      nginx.request_uri icontains "</noscript>" or
      nginx.request_uri icontains "</template>" or
      nginx.request_uri contains "'><script>" or
      nginx.request_uri contains "\"><script>" or
      nginx.request_uri contains "' onmouseover='" or
      nginx.request_uri contains "\" autofocus onfocus=" or
      nginx.request_uri contains "' autofocus onfocus='" or
      nginx.request_uri contains "\" onclick=" or
      nginx.request_uri contains "' onclick='" or
      nginx.request_uri contains "';alert" or
      nginx.request_uri contains "\";alert" or
      nginx.request_uri contains "';alert(String.fromCharCode(88,83,83))//';alert(String.fromCharCode(88,83,83))//" or
      nginx.request_uri contains "\";alert(String.fromCharCode(88,83,83))//\";alert(String.fromCharCode(88,83,83))//" or
      nginx.request_uri contains "--></SCRIPT>\">'><SCRIPT>alert(String.fromCharCode(88,83,83))</SCRIPT>" or
      nginx.request_uri icontains "String.fromCharCode" or
      nginx.request_uri contains "String%2EfromCharCode" or
      nginx.request_uri icontains "fromCharCode(88,83,83)" or
      (nginx.request_uri icontains "autofocus" and nginx.request_uri icontains "onfocus") or
      (nginx.request_uri icontains "onmouseover=" and nginx.request_uri icontains "alert") or
      (nginx.request_uri contains "<!--" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "-->" and nginx.request_uri icontains "<script") or
      nginx.request_uri contains "//\";alert" or
      nginx.request_uri contains "//';alert" or
      nginx.request_uri contains "/**/" or
      nginx.request_uri contains "\\u0061\\u006c\\u0065\\u0072\\u0074" or
      nginx.request_uri contains "\\u003c\\u0073\\u0063\\u0072\\u0069\\u0070\\u0074" or
      nginx.request_uri contains "%5Cu0061%5Cu006c%5Cu0065%5Cu0072%5Cu0074" or
      nginx.request_uri contains "&#60;script" or
      nginx.request_uri contains "&#x3c;script" or
      nginx.request_uri contains "&#40;" or
      nginx.request_uri contains "&#41;" or
      nginx.request_uri contains "&#x28;" or
      nginx.request_uri contains "&#x29;" or
      (nginx.request_uri contains "'>" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "'%20>" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "\">" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "\"%20>" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "%27>" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "%27%20>" and nginx.request_uri icontains "<script") or
      (nginx.request_uri contains "' on" or nginx.request_uri contains "\" on" or
       nginx.request_uri contains "'%20on" or nginx.request_uri contains "\"%20on" or
       nginx.request_uri contains "%27%20on" or
       nginx.request_uri icontains "onclick" or
       nginx.request_uri icontains "onload" or
       nginx.request_uri icontains "onerror" or
       nginx.request_uri icontains "onmouseover" or
       nginx.request_uri icontains "onfocus") or
      nginx.request_uri icontains "</script><script>" or
      nginx.request_uri icontains "</style><script>" or
      nginx.request_uri icontains "</textarea><script>"
    )
  exceptions:
    # Issue #43 Fix: XSS MUT patterns - should be caught by Advanced XSS rule
    - name: xss_mut_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XSS_MUT_004
  output: "[NGINX XSS] Polyglot XSS Attack test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr method=%nginx.method"
  priority: CRITICAL
  tags: [security, xss, polyglot, advanced_xss, phase3]
  source: nginx

# ====================================
# Combined Advanced XSS Detection
# ====================================
# Pattern #A303: Event handlers and JS keywords use icontains, URL-encoded and HTML entities use contains
# Pattern #A313: REMOVED %28 pattern (Issue #755)
#   - %28 is too broad (matches any URL-encoded parenthesis)
#   - XSS patterns are covered by other rules (event handlers, script tags, etc.)
#   - Caused EMRG_MONGO_005 to be misclassified as XSS
# Phase 1: Added XSS_DOM_002 - innerHTML manipulation
- rule: Advanced XSS Attack Attempt
  desc: Comprehensive detection of advanced XSS techniques
  condition: >-
    (
      nginx.request_uri icontains "onclick=" or
      nginx.request_uri icontains "ondblclick=" or
      nginx.request_uri icontains "onmousedown=" or
      nginx.request_uri icontains "onmouseenter=" or
      nginx.request_uri icontains "onmouseleave=" or
      nginx.request_uri icontains "onmousemove=" or
      nginx.request_uri icontains "onmouseout=" or
      nginx.request_uri icontains "onmouseup=" or
      nginx.request_uri icontains "onkeydown=" or
      nginx.request_uri icontains "onkeypress=" or
      nginx.request_uri icontains "onkeyup=" or
      nginx.request_uri icontains "onchange=" or
      nginx.request_uri icontains "onsubmit=" or
      nginx.request_uri icontains "onreset=" or
      nginx.request_uri icontains "onselect=" or
      nginx.request_uri icontains "onblur=" or
      nginx.request_uri icontains "ondrag=" or
      nginx.request_uri icontains "ondrop=" or
      nginx.request_uri icontains "oncanplay=" or
      nginx.request_uri icontains "oncanplaythrough=" or
      nginx.request_uri icontains "ondurationchange=" or
      nginx.request_uri icontains "onemptied=" or
      nginx.request_uri icontains "onended=" or
      nginx.request_uri icontains "onloadeddata=" or
      nginx.request_uri icontains "onloadedmetadata=" or
      nginx.request_uri icontains "onloadstart=" or
      nginx.request_uri icontains "onpause=" or
      nginx.request_uri icontains "onplay=" or
      nginx.request_uri icontains "onplaying=" or
      nginx.request_uri icontains "eval" or
      nginx.request_uri icontains "setTimeout" or
      nginx.request_uri icontains "setInterval" or
      nginx.request_uri icontains "Function" or
      nginx.request_uri icontains "constructor" or
      nginx.request_uri icontains "innerHTML" or
      nginx.request_uri icontains "outerHTML" or
      nginx.request_uri icontains "onbegin=" or
      nginx.request_uri contains "onbegin%3D" or
      nginx.request_uri contains "&#x3C;" or
      nginx.request_uri contains "&#60;" or
      nginx.request_uri contains "&lt;script" or
      nginx.request_uri contains "&gt;" or
      nginx.request_uri contains "onclick%3D" or
      nginx.request_uri contains "ondblclick%3D" or
      nginx.request_uri contains "onmousedown%3D" or
      nginx.request_uri contains "onkeydown%3D"
    )
  exceptions:
    # Issue #43 Fix: XSS DOM patterns - should be caught by DOM-based XSS rule
    - name: xss_dom_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XSS_DOM_006
        - XSS_DOM_010
    # Issue #56 Fix: Exclude Redis patterns that match XSS conditions
    # NOSQL_REDIS_001: Contains "EVAL" matching XSS event handler pattern; detected by Redis Command Injection rule
    - name: redis_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - NOSQL_REDIS_001
    # Phase 7: Exclude Prototype Pollution patterns (constructor.prototype triggers XSS condition)
    - name: phase7_prototype_pollution_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - PP_CONSTR_001
        - PP_CONSTR_002
    # Phase 9: PP patterns with "constructor" triggering icontains "constructor" XSS condition
    - name: phase9_pp_constructor_xss
      fields: nginx.pattern_id
      comps: in
      values:
        - PP_DOT_001
    # Phase 10: SSTI Handlebars patterns with "constructor" triggering XSS condition
    - name: phase10_ssti_constructor_xss
      fields: nginx.pattern_id
      comps: in
      values:
        - SSTI_HANDLE_001
        - SSTI_HANDLE_002
    # Phase 8 Stage 2: XXE/NoSQL/API patterns with XSS-like substrings
    # XXE_PARAM_001: "eval" in entity name triggers icontains "eval"
    # NOSQL_MONGO_007: "$where=function()" triggers icontains "Function"
    # API_PROTO_002: "constructor.prototype" triggers icontains "constructor"
    - name: phase8_xxe_nosql_api_xss_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XXE_PARAM_001
        - NOSQL_MONGO_007
        - API_PROTO_002
  output: "[NGINX XSS] Advanced XSS Attack Attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr method=%nginx.method"
  priority: WARNING
  tags: [security, xss, advanced_xss, event_handlers, phase3]
  source: nginx

# ====================================
# XSS Filter Bypass Detection
# ====================================
# Pattern #A303: Case variants consolidated to icontains, URL-encoded patterns use contains
# Issue #782 Fix: Added exceptions for LDAP patterns
- rule: XSS Filter Bypass Attempt
  desc: Detects attempts to bypass XSS filters using various encoding and obfuscation techniques
  condition: >-
    (
      nginx.request_uri icontains "script" or
      nginx.request_uri contains "PHNjcmlwd" or
      nginx.request_uri contains "{alert(" or
      nginx.request_uri contains "%7Balert%28" or
      nginx.request_uri contains "%00" or
      nginx.request_uri contains "\\x00" or
      nginx.request_uri contains "%09" or
      nginx.request_uri contains "%0a" or
      nginx.request_uri contains "%0d" or
      nginx.request_uri contains "%253C" or
      nginx.request_uri contains "%253E" or
      nginx.request_uri contains "%2527" or
      nginx.request_uri contains "%2522" or
      nginx.request_uri contains "%c0%bc" or
      nginx.request_uri contains "%e0%80%bc" or
      nginx.request_uri contains "%f0%80%80%bc" or
      nginx.request_uri icontains "<scr" or
      nginx.request_uri icontains "<ifr" or
      nginx.request_uri icontains "<fra" or
      nginx.request_uri icontains "expression" or
      nginx.request_uri icontains "style=" or
      nginx.request_uri icontains "behavior:" or
      nginx.request_uri icontains "-moz-binding:" or
      nginx.request_uri icontains "data:application" or
      nginx.request_uri icontains "data:image/svg" or
      nginx.request_uri icontains "vbscript:" or
      nginx.request_uri icontains "livescript:"
    )
  exceptions:
    # LDAP patterns with wildcard syntax - should be caught by LDAP rules
    - name: ldap_xss_like_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - LDAP_BLIND_005
    # Phase 7: Exclude HTTP Smuggling patterns (tab character triggers XSS bypass conditions)
    - name: phase7_http_smuggling_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - HRS_OBFUSC_001
    # Phase 8: CRLF Injection patterns - should be caught by CRLF Injection rule
    # %0d%0a in URL triggers %0a and %0d conditions
    - name: crlf_injection_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CRLF_HDR_001
        - CRLF_HDR_002
        - CRLF_HDR_003
        - CRLF_LOG_001
        - CRLF_LOG_002
        - CRLF_RESP_001
        - CRLF_RESP_002
    # Phase 9: New CRLF patterns with %0d%0a or %0a triggers
    - name: phase9_crlf_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CRLF_HDR_004
        - CRLF_HDR_005
        - CRLF_LOG_003
        - CRLF_RESP_003
        - CRLF_ENC_002
# Phase 10: New CRLF patterns
    - name: phase10_crlf_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CRLF_RESP_004
        - CRLF_RESP_005
        - CRLF_HDR_006
        - CRLF_HDR_007
        - CRLF_CACHE_001
        - CRLF_CACHE_002
        - CRLF_SESSION_001
        - CRLF_SESSION_002
        - CRLF_ENC_005
        - CRLF_ENC_006
  output: "[NGINX XSS] XSS Filter Bypass Attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr method=%nginx.method"
  priority: WARNING
  tags: [security, xss, filter_bypass, advanced_xss, phase3]
  source: nginx

# ==============================================================================
# Path Traversal Detection Rules (from advanced_traversal_enhanced.yaml)
# ==============================================================================

# rules/advanced_traversal_enhanced.yaml
# Advanced Path Traversal Detection Rules for Falco
# Created: 2025-09-14
# Optimized: 2025-11-26 - Pattern #A302 fix (icontains optimization per falco-plugin-rules.md v1.1.0)
#
# This ruleset detects path traversal attacks including:
# - Basic traversal patterns
# - Encoded traversal patterns
# - Windows-specific traversal
# - Double encoding
#
# OPTIMIZATION (Pattern #A302):
# - Replaced redundant contains with icontains for file/path names without URL encoding
# - Maintained contains for: URL-encoded patterns, traversal sequences (..), special characters
# - Reference: docs/development/best-practices/falco-plugin-rules.md v1.1.0

# ====================================
# ADV_TRAV_001: Basic Path Traversal
# ====================================
# Pattern #A302: Traversal sequences (..) must use contains (special characters)
- rule: Basic Path Traversal Attack
  desc: Detects basic path traversal attempts using ../ patterns
  condition: >-
    (
      nginx.request_uri contains "../" or
      nginx.request_uri contains "..%2f" or
      nginx.request_uri contains "..%2F" or
      nginx.request_uri contains ".." or
      nginx.request_uri contains "..%5c" or
      nginx.request_uri contains "..%5C" or
      nginx.request_uri contains "..../" or
      nginx.request_uri contains "../../../" or
      nginx.request_uri contains "../../../../" or
      nginx.request_uri contains "../../../../../" or
      nginx.request_uri contains "../../../../../../" or
      nginx.request_uri contains "../.ssh" or
      nginx.request_uri contains "../root" or
      nginx.request_uri contains "../home"
    )
  exceptions:
    # Issue #782 Fix: E2E test pattern in 'other/api_abuse' category - excluded to prevent duplicate detection counting
    - name: api_abuse_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - OTHER_API_001
    # Issue #43 Fix: Advanced Path Traversal patterns - should be caught by Advanced Path Traversal rule
    - name: path_adv_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - PATH_ADV_002
        - PATH_ADV_003
        - PATH_ADV_004
        - PATH_ADV_005
        - PATH_ADV_006
    # Issue #43 Fix: Windows Path Traversal patterns - should be caught by Windows Path Traversal rule
    - name: path_win_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - PATH_WIN_001
        - PATH_WIN_002
        - PATH_WIN_003
        - PATH_WIN_004
        - PATH_WIN_005
  output: "[NGINX Traversal] Basic path traversal attack detected test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, path_traversal, advanced_traversal, basic, phase3]
  source: nginx

# ====================================
# ADV_TRAV_002: Encoded Path Traversal
# ====================================
# Pattern #A302: All URL-encoded patterns, maintain contains
# Phase 1: Added PATH_UNICODE_002 - UTF-8 overlong encoding
- rule: Encoded Path Traversal Attack
  desc: Detects encoded path traversal attempts
  condition: >-
    (
      nginx.request_uri contains "%2e%2e%2f" or
      nginx.request_uri contains "%2e%2e%5c" or
      nginx.request_uri contains "%252e%252e%252f" or
      nginx.request_uri contains "%252E%252E%252F" or
      nginx.request_uri contains "%25252e%25252e%25252f" or
      nginx.request_uri contains "%25252E%25252E%25252F" or
      nginx.request_uri contains "%252e%252e%255c" or
      nginx.request_uri contains "%252E%252E%255C" or
      nginx.request_uri contains "%25252e%25252e%25255c" or
      nginx.request_uri contains "%25252E%25252E%25255C" or
      nginx.request_uri contains "%c0%ae%c0%ae" or
      nginx.request_uri contains "%c1%9c" or
      nginx.request_uri contains "%e0%80%ae" or
      nginx.request_uri contains "..%252f" or
      nginx.request_uri contains "..%255c" or
      nginx.request_uri contains "%2e%2e/" or
      nginx.request_uri contains "%2e%2e%5c" or
      nginx.request_uri contains "..;/" or
      nginx.request_uri contains "..%3b/" or
      nginx.request_uri contains "..%00/" or
      nginx.request_uri contains "%2e%2e%00/"
    )
  output: "[NGINX Traversal] Encoded path traversal attack detected test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, path_traversal, advanced_traversal, encoded, phase3]
  source: nginx

# ====================================
# ADV_TRAV_003: Windows Path Traversal
# ====================================
# Pattern #A302: Windows paths and URL-encoded patterns, maintain contains
- rule: Windows Path Traversal Attack
  desc: Detects Windows-specific path traversal attempts
  condition: >-
    (
      nginx.request_uri icontains "C:%5c" or
      nginx.request_uri contains "C:/" or
      nginx.request_uri icontains "..%5cwindows" or
      nginx.request_uri icontains "..%5cwinnt" or
      nginx.request_uri icontains "..%5cboot.ini" or
      nginx.request_uri icontains "..%5csystem32" or
      nginx.request_uri icontains "%5cwindows" or
      nginx.request_uri icontains "%5cwinnt" or
      nginx.request_uri icontains "%5csystem32" or
      nginx.request_uri icontains "%5c%5clocalhost" or
      nginx.request_uri contains "file:///" or
      nginx.request_uri icontains "..%5C..%5C" or
      nginx.request_uri icontains "Windows%5CSystem32" or
      nginx.request_uri icontains "drivers%5Cetc%5Chosts" or
      nginx.request_uri contains "file:%2f%2f%2f" or
      nginx.request_uri contains "%5c%5c.%5c" or
      nginx.request_uri contains "%5c%5c%2e%5c" or
      nginx.request_uri contains "..%5C" or
      nginx.request_uri contains "..%5c"
    )
  output: "[NGINX Traversal] Windows path traversal attack detected test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, path_traversal, advanced_traversal, windows, phase3]
  source: nginx

# ====================================
# ADV_TRAV_004: File Inclusion Patterns
# ====================================
# Pattern #A302: File paths use icontains for case variations, URL-encoded patterns use contains
# Pattern #A315 Fix (Issue #760): Exclude CMDi patterns to prevent misclassification
#   - CMD_BASIC_005 payload "; cat /etc/passwd" was matching "/etc/passwd" before CMDi rule
# Pattern #A316 Fix (Issue #762): Use 'in' operator for single-field exception
#   - 'startswith' and 'contains' are invalid for single-field exceptions in Falco 0.42.1
#   - Valid comps for single field: in, pmatch, intersects
#   - pmatch is for filesystem paths only (Pattern #A214) - NOT usable with nginx fields
#   - Reference: PROBLEM_PATTERNS.md Pattern #A316, Pattern #A214
- rule: File Inclusion Attack
  desc: Detects attempts to include sensitive files
  condition: >-
    (
      nginx.request_uri icontains "/etc/passwd" or
      nginx.request_uri icontains "/etc/shadow" or
      nginx.request_uri icontains "/etc/sudoers" or
      nginx.request_uri icontains "/etc/hosts" or
      nginx.request_uri icontains "/proc/self" or
      nginx.request_uri icontains "/var/log" or
      nginx.request_uri icontains "/.ssh/id_rsa" or
      nginx.request_uri icontains "/.ssh/authorized_keys" or
      nginx.request_uri icontains "/.bashrc" or
      nginx.request_uri icontains "/.bash_history" or
      nginx.request_uri icontains "/root/.ssh" or
      nginx.request_uri contains "%2Fetc%2Fpasswd" or
      nginx.request_uri contains "%2Fetc%2Fshadow" or
      nginx.request_uri contains "%2Fetc%2Fsudoers" or
      nginx.request_uri contains "%2Fproc%2Fself" or
      nginx.request_uri contains "%2Fvar%2Flog" or
      nginx.request_uri icontains "win.ini" or
      nginx.request_uri icontains "system.ini" or
      nginx.request_uri icontains "php.ini" or
      nginx.request_uri icontains "httpd.conf" or
      nginx.request_uri icontains ".htaccess" or
      nginx.request_uri icontains "web.config" or
      nginx.request_uri icontains "php://filter" or
      nginx.request_uri contains "php%3A%2F%2Ffilter" or
      nginx.request_uri icontains "php://input" or
      nginx.request_uri contains "php%3A%2F%2Finput" or
      nginx.request_uri icontains "data://text" or
      nginx.request_uri contains "data%3A%2F%2Ftext" or
      nginx.request_uri icontains "/etc/apache2/sites-available" or
      nginx.request_uri contains "%2Fetc%2Fapache2%2Fsites-available" or
      nginx.request_uri icontains "/etc/crontab" or
      nginx.request_uri contains "%2Fetc%2Fcrontab"
    )
  exceptions:
    # Pattern #A316 Fix: E2E test - Exclude CMDi patterns by exact pattern_id match
    # Using 'in' operator with full list of CMD_ pattern IDs
    # Phase 1: Added CMD_BASIC_011-020 to exceptions (all CMD_BASIC patterns)
    # Issue #782 Fix: Added CMD_PIPE_001 and XXE_ENTITY_004
    - name: cmdi_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CMD_BASIC_SEMICOLON_001
        - CMD_BASIC_002
        - CMD_BASIC_003
        - CMD_BASIC_004
        - CMD_BASIC_005
        - CMD_BASIC_006
        - CMD_BASIC_007
        - CMD_BASIC_008
        - CMD_BASIC_009
        - CMD_BASIC_010
        - CMD_BASIC_011
        - CMD_BASIC_012
        - CMD_BASIC_013
        - CMD_BASIC_014
        - CMD_BASIC_015
        - CMD_BASIC_016
        - CMD_BASIC_017
        - CMD_BASIC_018
        - CMD_BASIC_019
        - CMD_BASIC_020
        - CMD_PIPE_001
    # Issue #782 Fix: XXE patterns with file:// - should be caught by XXE rules
    # Issue #36 Fix (Pattern #A325): Added XXE_ENTITY_001 moved from Advanced SQLi
    - name: xxe_file_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - XXE_ENTITY_001
        - XXE_ENTITY_004
    # Issue #43 Fix: CMDi substitution patterns - should be caught by Command Substitution rule
    # E2E Run #127 Fix: CMD_ADV_066 should be caught by "Command substitution attack" rule
    # E2E Run #124 Fix: CMD_ADV_063 should be caught by "Command injection via pipe" rule
    - name: cmdi_sub_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CMD_SUB_003
        - CMD_ADV_063
        - CMD_ADV_066
    # Phase 8: SSRF patterns with file:// scheme - should be caught by SSRF Attack rule
    # file:///etc/passwd triggers icontains "/etc/passwd" match
    - name: ssrf_file_scheme_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - SSRF_SCHEME_001
  output: "[NGINX Traversal] File inclusion attack detected test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, path_traversal, file_inclusion, advanced_traversal, phase3]
  source: nginx

# ====================================
# Combined Path Traversal Detection
# ====================================
# Pattern #A302: Plain text uses icontains, URL-encoded and special chars use contains
- rule: Advanced Path Traversal Attempt
  desc: Comprehensive detection of path traversal techniques
  condition: >-
    (
      nginx.request_uri icontains "..%5c.." or
      nginx.request_uri icontains "directory traversal" or
      nginx.request_uri contains "%00" or
      nginx.request_uri contains "%0a" or
      nginx.request_uri contains "%0d" or
      nginx.request_uri contains "::$DATA" or
      nginx.request_uri contains "::$INDEX_ALLOCATION" or
      nginx.request_uri icontains "..%3B%2F" or
      nginx.request_uri icontains "..%5C..%2F" or
      nginx.request_uri contains "%2500" or
      nginx.request_uri icontains "..%5Cx2f"
    )
  exceptions:
    # Phase 8: CRLF Injection patterns - should be caught by CRLF Injection rule
    # %0d%0a in URL triggers %0a and %0d conditions
    - name: crlf_injection_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CRLF_HDR_001
        - CRLF_HDR_002
        - CRLF_HDR_003
        - CRLF_LOG_001
        - CRLF_LOG_002
        - CRLF_RESP_001
        - CRLF_RESP_002
    # Phase 9: New CRLF patterns with %0d%0a or %0a triggers
    - name: phase9_crlf_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CRLF_HDR_004
        - CRLF_HDR_005
        - CRLF_LOG_003
        - CRLF_RESP_003
        - CRLF_ENC_002
# Phase 10: New CRLF patterns
    - name: phase10_crlf_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CRLF_RESP_004
        - CRLF_RESP_005
        - CRLF_HDR_006
        - CRLF_HDR_007
        - CRLF_CACHE_001
        - CRLF_CACHE_002
        - CRLF_SESSION_001
        - CRLF_SESSION_002
        - CRLF_ENC_005
        - CRLF_ENC_006
  output: "[NGINX Traversal] Advanced path traversal attempt detected test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: WARNING
  tags: [security, path_traversal, advanced_traversal, phase3]
  source: nginx

# ==============================================================================
# Command Injection Detection Rules (from advanced_cmdi_enhanced.yaml)
# ==============================================================================

# rules/advanced_cmdi_enhanced.yaml
# Advanced Command Injection Detection Rules for Falco
# Created: 2025-09-14
# Optimized: 2025-11-26 - Pattern #A301 fix (icontains optimization per falco-plugin-rules.md v1.1.0)
#
# This ruleset detects command injection attacks including:
# - Semicolon-based injection
# - Pipe-based injection
# - Command substitution
# - Encoded variants
#
# OPTIMIZATION (Pattern #A301):
# - Replaced redundant contains with icontains for pure command names
# - Maintained contains for: URL-encoded patterns, special characters
# - Reference: docs/development/best-practices/falco-plugin-rules.md v1.1.0

# ====================================
# ADV_CMDI_001: Command Injection via Semicolon
# ====================================
# Pattern #A301: Command names use icontains, URL-encoded patterns use contains
# Pattern #A306: Added space-prefixed patterns for E2E test coverage
#   - CMD_BASIC_SEMICOLON_001: ; ls -la
#   - CMD_BASIC_006: ; uname -a
#   - CMD_BASIC_009: ; ifconfig
# Pattern #A317 Fix (Issue #764): Added "; cat" pattern for CMD_BASIC_005
#   - CMD_BASIC_005: ; cat /etc/passwd
#   - Previously only ";cat" (no space) was covered, but payload has space
# Phase 1: Added CMD_BASIC_013 (;pwd) and CMD_BASIC_014 (;;ls)
- rule: Command Injection via Semicolon
  desc: Detects command injection attempts using semicolon separators
  condition: >-
    (
      nginx.request_uri icontains ";cat" or
      nginx.request_uri icontains ";rm" or
      nginx.request_uri icontains ";wget" or
      nginx.request_uri icontains ";curl" or
      nginx.request_uri icontains ";id" or
      nginx.request_uri icontains ";whoami" or
      nginx.request_uri icontains ";uname" or
      nginx.request_uri icontains ";ls" or
      nginx.request_uri icontains ";nc" or
      nginx.request_uri icontains ";pwd" or
      nginx.request_uri icontains ";sleep" or
      nginx.request_uri icontains "; ls" or
      nginx.request_uri icontains "; uname" or
      nginx.request_uri icontains "; ifconfig" or
      nginx.request_uri icontains "; cat" or
      nginx.request_uri icontains "; sleep" or
      nginx.request_uri contains ";;" or
      nginx.request_uri contains "%3Bcat" or
      nginx.request_uri contains "%3Brm" or
      nginx.request_uri contains "%3Bwget" or
      nginx.request_uri contains "%3Bid" or
      nginx.request_uri contains "%3Bwhoami" or
      nginx.request_uri contains "%3Buname" or
      nginx.request_uri contains "%3Bls" or
      nginx.request_uri contains "%3Bnc" or
      nginx.request_uri contains "%3Bpwd" or
      nginx.request_uri contains "%3Bsleep" or
      nginx.request_uri contains "%3B%3B" or
      nginx.request_uri contains "%3B%20ls" or
      nginx.request_uri contains "%3B%20uname" or
      nginx.request_uri contains "%3B%20ifconfig" or
      nginx.request_uri contains "%3B%20cat" or
      nginx.request_uri contains "%3B%20sleep"
    )
  output: "[NGINX CMDi] Command injection via semicolon test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, command_injection, advanced_cmdi, semicolon, phase3]
  source: nginx

# ====================================
# ADV_CMDI_002: Command Injection via Pipe
# ====================================
# Pattern #A301: Command names use icontains, URL-encoded patterns use contains
# Pattern #A306: Added space-prefixed patterns for E2E test coverage
#   - CMD_BASIC_003: || id
#   - CMD_BASIC_008: || cat /proc/version
# Phase 1: Added CMD_BASIC_011 (|id) and CMD_BASIC_012 (||ls)
# Pattern #A324: Added |grep and %7Cgrep/%7C%20grep for CMD_PIPE_001
#   - CMD_PIPE_001: cat /etc/passwd | grep root
#   - Fixed PR #33 exception without corresponding detection pattern
# E2E Run #124 Fix: Added "| cat" (single pipe with space) for CMD_ADV_063
#   - CMD_ADV_063: | cat /etc/passwd
- rule: Command Injection via Pipe
  desc: Detects command injection attempts using pipe operators
  condition: >-
    (
      nginx.request_uri icontains "|whoami" or
      nginx.request_uri icontains "|cat" or
      nginx.request_uri icontains "| cat" or
      nginx.request_uri icontains "|id" or
      nginx.request_uri icontains "||nc" or
      nginx.request_uri icontains "||ls" or
      nginx.request_uri icontains "|curl" or
      nginx.request_uri icontains "|wget" or
      nginx.request_uri icontains "|bash" or
      nginx.request_uri icontains "|sh" or
      nginx.request_uri icontains "|python" or
      nginx.request_uri icontains "|perl" or
      nginx.request_uri icontains "|grep" or
      nginx.request_uri icontains "| head" or
      nginx.request_uri icontains "|head" or
      nginx.request_uri icontains "| xargs" or
      nginx.request_uri icontains "|xargs" or
      nginx.request_uri icontains "|| id" or
      nginx.request_uri icontains "|| cat" or
      nginx.request_uri contains "%7Cwhoami" or
      nginx.request_uri contains "%7Ccat" or
      nginx.request_uri contains "%7Cid" or
      nginx.request_uri contains "%7C%7Cnc" or
      nginx.request_uri contains "%7C%7Cls" or
      nginx.request_uri contains "%7Ccurl" or
      nginx.request_uri contains "%7Cwget" or
      nginx.request_uri contains "%7Cbash" or
      nginx.request_uri contains "%7Csh" or
      nginx.request_uri contains "%7C%7C%20id" or
      nginx.request_uri contains "%7C%7C%20cat" or
      nginx.request_uri contains "%7C%20cat" or
      nginx.request_uri contains "%7Cgrep" or
      nginx.request_uri contains "%7C%20grep" or
      nginx.request_uri contains "%7C%20head" or
      nginx.request_uri contains "%7Chead"
    )
  output: "[NGINX CMDi] Command injection via pipe test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, command_injection, advanced_cmdi, pipe, phase3]
  source: nginx

# ====================================
# ADV_CMDI_003: Command Substitution
# ====================================
# Pattern #A301: Pure command names use icontains
# URL-encoded and special patterns ($, `, ${}) use contains
# Pattern #A304: Removed single "$" - causes false positives (e.g., /products?price=$100)
# Pattern #A304: Removed standalone "whoami", "curl", "wget" - covered by backtick/substitution patterns
# Phase 1: Added CMD_BASIC_018 - $(uname -a) command substitution
# Pattern #A324: Added `rm, %60rm, %60id for CMD_BACK_001, CMD_BASIC_017
#   - CMD_BACK_001: `rm -rf /tmp/*`
#   - CMD_BASIC_017: `id`
#   - Fixed PR #33 exception without corresponding detection pattern
- rule: Command Substitution Attack
  desc: Detects command injection attempts using command substitution
  condition: >-
    (
      nginx.request_uri contains "$(whoami" or
      nginx.request_uri contains "$(cat" or
      nginx.request_uri contains "$(curl" or
      nginx.request_uri contains "$(wget" or
      nginx.request_uri contains "$(id" or
      nginx.request_uri contains "$(uname" or
      nginx.request_uri contains "`whoami" or
      nginx.request_uri contains "`cat" or
      nginx.request_uri contains "`curl" or
      nginx.request_uri contains "`wget" or
      nginx.request_uri contains "`id" or
      nginx.request_uri contains "`uname" or
      nginx.request_uri contains "`rm" or
      nginx.request_uri contains "%24%28whoami" or
      nginx.request_uri contains "%24%28cat" or
      nginx.request_uri contains "%24%28curl" or
      nginx.request_uri contains "%24%28uname" or
      nginx.request_uri contains "%24(uname" or
      nginx.request_uri contains "$(ls" or
      nginx.request_uri contains "%24%28ls" or
      nginx.request_uri contains "%60whoami" or
      nginx.request_uri contains "%60cat" or
      nginx.request_uri contains "%60uname" or
      nginx.request_uri contains "%60rm" or
      nginx.request_uri contains "%60id" or
      nginx.request_uri contains "${IFS}" or
      nginx.request_uri contains "%24%7BIFS%7D" or
      nginx.request_uri contains "${PATH}" or
      nginx.request_uri contains "%24%7BPATH%7D" or
      nginx.request_uri contains "${HOME}" or
      nginx.request_uri contains "%24%7BHOME%7D" or
      nginx.request_uri contains "${USER}" or
      nginx.request_uri contains "%24%7BUSER%7D" or
      nginx.request_uri contains "${SHELL}" or
      nginx.request_uri contains "%24%7BSHELL%7D"
    )
  output: "[NGINX CMDi] Command substitution attack test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, command_injection, advanced_cmdi, substitution, phase3, phase4]
  source: nginx

# ====================================
# Combined Command Injection Detection
# ====================================
# Pattern #A301: System paths and commands use icontains where appropriate
# Special characters and URL-encoded patterns use contains
# Pattern #A304: REMOVED single special characters (;, |, `, &, $) - causes massive false positives
# These characters are used in normal URLs: & (query params), ; (cookies), $ (prices), | (filters)
# Attack detection is handled by ADV_CMDI_001-003 with command name combinations
# Pattern #A306: Added "& ps" pattern for E2E test coverage
#   - CMD_BASIC_004: & ps aux
#   Note: "& ps" with space distinguishes from "&ps=" query parameter
# Pattern #A312: REMOVED /etc/passwd and /etc/shadow patterns (Issue #754)
#   - These are file access (Traversal), not command execution (CMDi)
#   - Covered by advanced_traversal_enhanced.yaml (File Inclusion Attack rule)
#   - See: Issue #754, E2E Run #124 analysis
- rule: Advanced Command Injection Attempt
  desc: Comprehensive detection of command injection techniques
  condition: >-
    (
      nginx.request_uri icontains "/bin/sh" or
      nginx.request_uri icontains "/bin/bash" or
      nginx.request_uri icontains "cmd.exe" or
      nginx.request_uri icontains "powershell" or
      nginx.request_uri icontains "nc -e" or
      nginx.request_uri icontains "bash -i" or
      nginx.request_uri icontains "& ps" or
      nginx.request_uri icontains "& dir" or
      nginx.request_uri contains "%2Fbin%2Fsh" or
      nginx.request_uri contains "%2Fbin%2Fbash" or
      nginx.request_uri contains "&&" or
      nginx.request_uri contains "%26%26" or
      nginx.request_uri contains "%26%20ps" or
      nginx.request_uri contains "%26%20dir" or
      nginx.request_uri contains "%0a" or
      nginx.request_uri contains "%0A" or
      nginx.request_uri contains "%0d" or
      nginx.request_uri contains "%0D" or
      nginx.request_uri contains "%250a" or
      nginx.request_uri contains "%250A" or
      nginx.request_uri contains "%250d" or
      nginx.request_uri contains "%250D" or
      nginx.request_uri contains "%253B" or
      nginx.request_uri contains "%253Bwhoami" or
      nginx.request_uri contains "%253Bcat" or
      nginx.request_uri contains "%253Bls" or
      nginx.request_uri contains "%253Bid" or
      nginx.request_uri contains "%2526%2526" or
      nginx.request_uri contains "%2524%2528" or
      nginx.request_uri contains "%2560" or
      nginx.request_uri icontains "/dev/tcp" or
      nginx.request_uri contains "%2Fdev%2Ftcp" or
      nginx.request_uri icontains "LD_PRELOAD" or
      nginx.request_uri contains "LD_PRELOAD%3D" or
      nginx.request_uri icontains "nohup" or
      nginx.request_uri icontains "disown" or
      nginx.request_uri contains ":|:" or
      nginx.request_uri contains "%3A%7C%3A" or
      nginx.request_uri icontains "crontab" or
      nginx.request_uri contains "spool/cron" or
      nginx.request_uri contains "%2Fspool%2Fcron" or
      nginx.request_uri contains "$($" or
      nginx.request_uri contains "%24(%24" or
      nginx.request_uri icontains "$PATH" or
      nginx.request_uri contains "%24PATH"
    )
  output: "[NGINX CMDi] Advanced command injection attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: WARNING
  tags: [security, command_injection, advanced_cmdi, phase3]
  source: nginx
  exceptions:
    # Phase 7: Exclude HTTP Smuggling patterns (CRLF injection triggers CMDi conditions)
    - name: phase7_http_smuggling_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - HRS_CL_TE_002
        - HRS_TE_CL_001
        - HRS_TE_CL_002
        - HRS_HEADER_002
    # Phase 8: CRLF Injection patterns - should be caught by CRLF Injection rule
    # %0d%0a in URL triggers %0a/%0A and %0d/%0D conditions
    - name: crlf_injection_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CRLF_HDR_001
        - CRLF_HDR_002
        - CRLF_HDR_003
        - CRLF_LOG_001
        - CRLF_LOG_002
        - CRLF_RESP_001
        - CRLF_RESP_002
    # Phase 9: New CRLF patterns with %0d%0a or %0a triggers
    - name: phase9_crlf_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CRLF_HDR_004
        - CRLF_HDR_005
        - CRLF_LOG_003
        - CRLF_RESP_003
        - CRLF_ENC_002
        - CRLF_ENC_003
    # Phase 10: New CRLF patterns with %0d%0a or %0a or %250d%250a triggers
    - name: phase10_crlf_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - CRLF_RESP_004
        - CRLF_RESP_005
        - CRLF_HDR_006
        - CRLF_HDR_007
        - CRLF_CACHE_001
        - CRLF_CACHE_002
        - CRLF_SESSION_001
        - CRLF_SESSION_002
        - CRLF_ENC_005
        - CRLF_ENC_006

# ==============================================================================
# Emerging Threats Detection Rules (from advanced_emerging_enhanced.yaml)
# ==============================================================================

# rules/advanced_emerging_enhanced.yaml
# Advanced Emerging Threats Detection Rules for Falco
# Created: 2025-09-14
# Optimized: 2025-11-26 - Pattern #A302 fix (icontains optimization per falco-plugin-rules.md v1.1.0)
#
# This ruleset detects emerging threats including:
# - Log4Shell (CVE-2021-44228)
# - Spring4Shell (CVE-2022-22965)
# - Other zero-day patterns
#
# OPTIMIZATION (Pattern #A302):
# - Replaced redundant contains with icontains for pure alphabetic class/method names
# - Maintained contains for: URL-encoded patterns, Base64, special characters ($, {, @, !)
# - Reference: docs/development/best-practices/falco-plugin-rules.md v1.1.0

# ====================================
# ADV_EMRG_001: Log4Shell Detection
# ====================================
# Pattern #A302: All patterns contain special characters (${), maintain contains
- rule: Log4Shell Attack Detection
  desc: Detects Log4Shell (CVE-2021-44228) exploitation attempts
  condition: >-
    (
      nginx.request_uri contains "${jndi:" or
      nginx.request_uri contains "${jndi:ldap" or
      nginx.request_uri contains "${jndi:rmi" or
      nginx.request_uri contains "${jndi:dns" or
      nginx.request_uri contains "${jndi:iiop" or
      nginx.request_uri contains "${jndi:http" or
      nginx.request_uri contains "${jndi:nis" or
      nginx.request_uri contains "${jndi:nds" or
      nginx.request_uri contains "${jndi:corba" or
      nginx.request_uri contains "%24%7Bjndi%3A" or
      nginx.request_uri contains "%24%7Bjndi%3Aldap" or
      nginx.request_uri contains "%24%7Bjndi%3Armi" or
      nginx.request_uri contains "%2524%257Bjndi" or
      nginx.request_uri contains "${${::-j}" or
      nginx.request_uri contains "${${lower:j}" or
      nginx.request_uri contains "${${upper:j}" or
      nginx.request_uri contains "${${env:ENV_NAME:-j}" or
      nginx.request_uri contains "${${sys:SYS_NAME:-j}" or
      nginx.request_uri contains "${${::-j}${::-n}${::-d}${::-i}" or
      nginx.request_uri contains "${${lower:jndi}" or
      nginx.request_uri contains "${${upper:jndi}" or
      nginx.request_uri contains "${${::-j}ndi"
    )
  output: "[NGINX Emerging Threat] Log4Shell attack test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, emerging_threats, log4shell, cve_2021_44228, phase3]
  source: nginx

# ====================================
# ADV_EMRG_002: Spring4Shell Detection
# ====================================
# Pattern #A302: Java class names use icontains, URL-encoded patterns use contains
- rule: Spring4Shell Attack Detection
  desc: Detects Spring4Shell (CVE-2022-22965) exploitation attempts
  condition: >-
    (
      nginx.request_uri icontains "class.module.classLoader" or
      nginx.request_uri contains "class%2Emodule%2EclassLoader" or
      nginx.request_uri contains "class%252Emodule%252EclassLoader" or
      nginx.request_uri contains "%63%6c%61%73%73%2e%6d%6f%64%75%6c%65" or
      nginx.request_uri contains "class[module][classLoader]" or
      nginx.request_uri contains "class%5Bmodule%5D%5BclassLoader%5D" or
      nginx.request_uri contains ".resources.context.parent.pipeline" or
      nginx.request_uri contains ".getRuntime" or
      nginx.request_uri contains "getRuntime()" or
      nginx.request_uri icontains "ProcessBuilder" or
      nginx.request_uri icontains "java.lang.Runtime" or
      nginx.request_uri icontains "DefaultAssertionStatus" or
      nginx.request_uri icontains "module.classLoader.resources" or
      nginx.request_uri icontains "module.classLoader.DefaultAssertionStatus" or
      nginx.request_uri icontains "module.classLoader.URLs" or
      nginx.request_uri icontains "class.classLoader" or
      nginx.request_uri icontains "class.protectionDomain"
    )
  output: "[NGINX Emerging Threat] Spring4Shell attack test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, emerging_threats, spring4shell, cve_2022_22965, phase3]
  source: nginx

# ====================================
# ADV_EMRG_003: Apache Struts Exploitation
# ====================================
# Pattern #A302: OGNL class names use icontains, special characters (@, #, %) use contains
- rule: Apache Struts Exploitation
  desc: Detects Apache Struts vulnerability exploitation attempts
  condition: >-
    (
      nginx.request_uri contains "%{#context" or
      nginx.request_uri contains "%{#_memberAccess" or
      nginx.request_uri icontains "ognl.OgnlContext" or
      nginx.request_uri icontains "ognl.ClassResolver" or
      nginx.request_uri contains "#_memberAccess" or
      nginx.request_uri icontains "denyMethodExecution" or
      nginx.request_uri icontains "allowStaticMethodAccess" or
      nginx.request_uri contains "@java.lang.Runtime" or
      nginx.request_uri contains "@java.lang.ProcessBuilder" or
      nginx.request_uri contains ".getRuntime().exec" or
      nginx.request_uri contains "new java.lang.ProcessBuilder" or
      nginx.request_uri contains "%25%7B%23context" or
      nginx.request_uri contains "%25%7B%23_memberAccess" or
      nginx.request_uri contains "redirect:${" or
      nginx.request_uri contains "redirectAction:${" or
      nginx.request_uri contains "action:${" or
      nginx.request_uri contains "method:${}"
    )
  output: "[NGINX Emerging Threat] Apache Struts exploitation test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, emerging_threats, struts, phase3]
  source: nginx

# ====================================
# ADV_EMRG_004: Deserialization Attacks
# ====================================
# Pattern #A302: Java class/method names use icontains, Base64/URL-encoded patterns use contains
- rule: Deserialization Attack Detection
  desc: Detects attempts to exploit deserialization vulnerabilities
  condition: >-
    (
      nginx.request_uri contains "rO0ABX" or
      nginx.request_uri contains "rO0ABXNy" or
      nginx.request_uri contains "H4sIAAAAAAAA" or
      nginx.request_uri icontains "ObjectInputStream" or
      nginx.request_uri icontains "java.io.ObjectInputStream" or
      nginx.request_uri icontains "readObject" or
      nginx.request_uri icontains "writeObject" or
      nginx.request_uri icontains "ysoserial" or
      nginx.request_uri icontains "CommonsCollections" or
      nginx.request_uri icontains "InvokerTransformer" or
      nginx.request_uri icontains "ChainedTransformer" or
      nginx.request_uri icontains "ConstantTransformer" or
      nginx.request_uri icontains "InstantiateTransformer" or
      nginx.request_uri contains "%72%4F%30%41%42%58" or
      nginx.request_uri icontains "pickle.loads" or
      nginx.request_uri contains "__reduce__" or
      nginx.request_uri icontains "yaml.load" or
      nginx.request_uri contains "!!python" or
      nginx.request_uri contains "O:8:" or
      nginx.request_uri contains "O%3A8%3A" or
      nginx.request_uri contains "O:4:" or
      nginx.request_uri contains "O%3A4%3A" or
      nginx.request_uri contains "O:1:" or
      nginx.request_uri contains "O%3A1%3A" or
      nginx.request_uri contains "s:4:\"" or
      nginx.request_uri contains "s%3A4%3A%22"
    )
  output: "[NGINX Emerging Threat] Deserialization attack test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, emerging_threats, deserialization, phase3]
  source: nginx

# ====================================
# Combined Emerging Threats Detection
# ====================================
# Pattern #A302: CVE- consolidated to icontains, class names use icontains
- rule: Advanced Emerging Threat Attempt
  desc: Comprehensive detection of emerging threat patterns
  condition: >-
    (
      nginx.request_uri icontains "CVE-" or
      nginx.request_uri contains "${env:" or
      nginx.request_uri contains "${sys:" or
      nginx.request_uri contains "${java:" or
      nginx.request_uri contains "${file:" or
      nginx.request_uri contains "${dns:" or
      nginx.request_uri contains "${url:" or
      nginx.request_uri contains "Runtime.getRuntime" or
      nginx.request_uri icontains "ProcessBuilder" or
      nginx.request_uri icontains "ScriptEngineManager" or
      nginx.request_uri contains "%00" or
      nginx.request_uri contains "null byte"
    )
  output: "[NGINX Emerging Threat] Advanced emerging threat attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: WARNING
  tags: [security, emerging_threats, phase3]
  source: nginx

# ====================================
# ADV_EMRG_005: MongoDB NoSQL Injection
# ====================================
# Pattern #A306: Dedicated MongoDB detection rule
# Previously detected accidentally by CMDi "$" pattern (removed in PR #741)
# This rule provides explicit detection for MongoDB operators
# Test patterns: EMRG_MONGO_001, 002, 003, 004
- rule: MongoDB NoSQL Injection Detection
  desc: Detects MongoDB NoSQL injection and CouchDB API access attempts
  condition: >-
    (
      nginx.request_uri contains "$where" or
      nginx.request_uri contains "$ne" or
      nginx.request_uri contains "$gt" or
      nginx.request_uri contains "$lt" or
      nginx.request_uri contains "$gte" or
      nginx.request_uri contains "$lte" or
      nginx.request_uri contains "$regex" or
      nginx.request_uri contains "$exists" or
      nginx.request_uri contains "$or" or
      nginx.request_uri contains "$and" or
      nginx.request_uri contains "%24where" or
      nginx.request_uri contains "%24ne" or
      nginx.request_uri contains "%24gt" or
      nginx.request_uri contains "%24lt" or
      nginx.request_uri contains "%24regex" or
      nginx.request_uri contains "%24exists" or
      nginx.request_uri contains "%24or" or
      nginx.request_uri contains "%24and" or
      nginx.request_uri icontains "db.users.find" or
      nginx.request_uri icontains "db.collection.find" or
      nginx.request_uri icontains "this.password" or
      nginx.request_uri icontains "this.username" or
      nginx.request_uri icontains "_all_docs" or
      nginx.request_uri icontains "_design%2F" or
      nginx.request_uri icontains "_design/" or
      nginx.request_uri icontains "_changes"
    )
  output: "[NGINX Emerging Threat] MongoDB NoSQL injection test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, emerging_threats, mongodb, nosql, phase3]
  source: nginx

# ====================================
# ADV_EMRG_006: Template Injection (Phase 5, Issue #780)
# ====================================
# Test patterns: OTHER_JINJA_001
# Issue #782 Fix: Added exceptions for GraphQL patterns
- rule: Template Injection Detection
  desc: Detects server-side template injection attempts (SSTI) including Jinja2, Velocity, Freemarker
  condition: >-
    (
      nginx.request_uri contains "{{" or
      nginx.request_uri contains "%7B%7B" or
      nginx.request_uri contains "}}" or
      nginx.request_uri contains "%7D%7D" or
      nginx.request_uri contains "${" or
      nginx.request_uri contains "%24%7B" or
      nginx.request_uri contains "#{" or
      nginx.request_uri contains "%23%7B" or
      nginx.request_uri contains "<%" or
      nginx.request_uri contains "%3C%25" or
      nginx.request_uri icontains "%23set%28%24" or
      nginx.request_uri icontains "%24class.inspect" or
      nginx.request_uri icontains "%3C%23assign" or
      nginx.request_uri icontains "freemarker.template"
    )
  exceptions:
    # GraphQL patterns with template-like syntax - should be caught by GraphQL rules
    - name: graphql_template_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - GQL_INTRO_002
    # Issue #56 Fix: Exclude API Prototype Pollution patterns that match template syntax
    # API_PROTO_001: Contains %7B (%7B = {) matching template injection pattern; detected by API Security rule
    # Note: Also excluded from SSTI Attack Detected rule due to %7D%7D (}}) match
    - name: api_proto_001_exception
      fields: nginx.pattern_id
      comps: in
      values:
        - API_PROTO_001
    # Phase 7: Exclude Prototype Pollution JSON patterns
    - name: phase7_prototype_pollution_json
      fields: nginx.pattern_id
      comps: in
      values:
        - PP_JSON_001
    # Phase 8 Stage 2: API Prototype Pollution pattern
    # %7D%7D (}}) in JSON triggers template injection condition
    - name: phase8_api_proto_002
      fields: nginx.pattern_id
      comps: in
      values:
        - API_PROTO_002
  output: "[NGINX Emerging Threat] Template injection test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, emerging_threats, ssti, template_injection, phase5]
  source: nginx

# ====================================
# ADV_EMRG_007: Redis Command Injection (Phase 5, Issue #780)
# ====================================
# Test patterns: OTHER_REDIS_001, NOSQL_REDIS_001, NOSQL_REDIS_002
- rule: Redis Command Injection Detection
  desc: Detects Redis command injection attempts
  condition: >-
    (
      nginx.request_uri icontains "FLUSHALL" or
      nginx.request_uri icontains "FLUSHDB" or
      nginx.request_uri icontains "CONFIG SET" or
      nginx.request_uri icontains "CONFIG%20SET" or
      nginx.request_uri icontains "CONFIG GET" or
      nginx.request_uri icontains "CONFIG%20GET" or
      nginx.request_uri icontains "SLAVEOF" or
      nginx.request_uri icontains "DEBUG SEGFAULT" or
      nginx.request_uri icontains "DEBUG%20SEGFAULT" or
      nginx.request_uri icontains "EVAL " or
      nginx.request_uri icontains "EVAL%20"
    )
  exceptions:
    # Phase 8 Stage 2: XXE pattern with "eval" in entity name
    # "%20eval%20" matches icontains "EVAL%20"
    - name: phase8_xxe_eval_pattern
      fields: nginx.pattern_id
      comps: in
      values:
        - XXE_PARAM_001
  output: "[NGINX Emerging Threat] Redis command injection test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, emerging_threats, redis, injection, phase5]
  source: nginx

# ====================================
# ADV_EMRG_008: SSTI Detection (Phase 4, Issue #49)
# ====================================
# Test patterns: SSTI_SMARTY_001, SSTI_THYME_001, SSTI_PEBBLE_001, SSTI_TWIG_001, SSTI_MAKO_001
- rule: SSTI Attack Detected
  desc: Detects Server-Side Template Injection attempts
  condition: >-
    (
      nginx.request_uri contains "{php}" or
      nginx.request_uri contains "%7Bphp%7D" or
      nginx.request_uri contains "{/php}" or
      nginx.request_uri contains "%7B%2Fphp%7D" or
      nginx.request_uri contains "{{" or
      nginx.request_uri contains "%7B%7B" or
      nginx.request_uri contains "}}" or
      nginx.request_uri contains "%7D%7D" or
      nginx.request_uri contains "${" or
      nginx.request_uri contains "%24%7B" or
      nginx.request_uri contains "{%" or
      nginx.request_uri contains "%7B%25" or
      nginx.request_uri contains "%}" or
      nginx.request_uri contains "%25%7D" or
      nginx.request_uri icontains "file_excerpt" or
      nginx.request_uri icontains "self.module" or
      nginx.request_uri contains "__${T(" or
      nginx.request_uri contains "__%24%7BT(" or
      (nginx.request_uri icontains "system" and nginx.request_uri contains "(") or
      nginx.request_uri contains "<%=" or
      nginx.request_uri contains "%3C%25%3D" or
      nginx.request_uri contains "%3c%25%3d" or
      nginx.request_uri icontains "System.Diagnostics" or
      nginx.request_uri contains "@{var" or
      nginx.request_uri contains "@%7Bvar" or
      nginx.request_uri contains "%40%7Bvar"
    )
  output: "[NGINX SSTI] Server-Side Template Injection detected test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, emerging_threats, ssti, template_injection, phase4]
  exceptions:
    # Issue #56 Fix: Exclude API Prototype Pollution patterns that match SSTI syntax
    # API_PROTO_001: Contains %7D%7D (}}) matching SSTI closing braces; detected by API Security rule
    # Note: Also excluded from Template Injection Detection rule due to %7B ({) match
    - name: api_proto_001_exception
      fields: nginx.pattern_id
      comps: in
      values:
        - API_PROTO_001
    # Phase 7: Exclude Prototype Pollution JSON patterns
    - name: phase7_prototype_pollution_json
      fields: nginx.pattern_id
      comps: in
      values:
        - PP_JSON_001
    # Phase 8 Stage 2: API Prototype Pollution pattern
    # %7D%7D (}}) in JSON triggers SSTI closing braces condition
    - name: phase8_api_proto_002_ssti
      fields: nginx.pattern_id
      comps: in
      values:
        - API_PROTO_002
  source: nginx

# =========================================================================
# LDAP INJECTION DETECTION RULES (Issue #780 Phase 4)
# =========================================================================
# Pattern #A306: LDAP Injection Detection
# Detects LDAP filter injection patterns including:
# - Authentication bypass: *)( patterns
# - Blind injection: password enumeration, user enumeration
# - Attribute injection: cn, uid, objectClass, memberOf
# Test patterns: LDAP_BASIC_001-005, LDAP_BLIND_001-005

# ====================================
# LDAP_INJ_001: LDAP Authentication Bypass
# Issue #38 Fix: Added partial URL encoding pattern for LDAP_BASIC_003
# ====================================
- rule: LDAP Authentication Bypass Attempt
  desc: Detects LDAP authentication bypass injection attempts
  condition: >-
    (
      nginx.request_uri contains "*)(" or
      nginx.request_uri contains "%2A%29%28" or
      nginx.request_uri contains ")(uid=" or
      nginx.request_uri contains "%29%28uid%3D" or
      nginx.request_uri contains ")(|(uid=" or
      nginx.request_uri contains "%29%28%7C%28uid%3D" or
      nginx.request_uri contains "|(password=" or
      nginx.request_uri contains "%7C%28password%3D" or
      nginx.request_uri contains ")(&(password=" or
      nginx.request_uri contains "%29%28%26%28password%3D" or
      nginx.request_uri contains ")(%26(password%3D"
    )
  output: "[NGINX LDAP Injection] Authentication bypass attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, ldap_injection, authentication_bypass, phase4]
  source: nginx

# ====================================
# LDAP_INJ_002: LDAP Attribute Injection
# ====================================
- rule: LDAP Attribute Injection Attempt
  desc: Detects LDAP attribute injection for enumeration
  condition: >-
    (
      nginx.request_uri contains ")(cn=" or
      nginx.request_uri contains "%29%28cn%3D" or
      nginx.request_uri contains ")(objectClass=" or
      nginx.request_uri contains "%29%28objectClass%3D" or
      nginx.request_uri contains ")(memberOf=" or
      nginx.request_uri contains "%29%28memberOf%3D" or
      nginx.request_uri contains ")(mail=" or
      nginx.request_uri contains "%29%28mail%3D" or
      nginx.request_uri contains ")(description=" or
      nginx.request_uri contains "%29%28description%3D"
    )
  output: "[NGINX LDAP Injection] Attribute injection attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: WARNING
  tags: [security, ldap_injection, enumeration, phase4]
  source: nginx

# ====================================
# LDAP_INJ_003: LDAP Blind Injection
# ====================================
- rule: LDAP Blind Injection Attempt
  desc: Detects LDAP blind injection attempts for enumeration
  condition: >-
    (
      nginx.request_uri contains ")(uid=admin)(password=" or
      nginx.request_uri contains "%29%28uid%3Dadmin%29%28password%3D" or
      nginx.request_uri contains ")(|(uid=admin)(uid=administrator))" or
      nginx.request_uri contains "%29%28%7C%28uid%3Dadmin%29%28uid%3Dadministrator%29%29" or
      nginx.request_uri contains "cn=Administrators" or
      nginx.request_uri contains "cn%3DAdministrators"
    )
  output: "[NGINX LDAP Injection] Blind injection attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: WARNING
  tags: [security, ldap_injection, blind_injection, phase4]
  source: nginx

# =========================================================================
# XXE (XML EXTERNAL ENTITY) ATTACK DETECTION RULES (Issue #780 Phase 4)
# =========================================================================
# Pattern #A307: XXE Attack Detection
# Detects XXE injection patterns including:
# - DOCTYPE declarations with ENTITY
# - External entity references (file://, http://, php://, expect://)
# - Parameter entities
# Test patterns: XXE_ENTITY_001-005

# ====================================
# XXE_ATK_001: XXE DOCTYPE Entity Injection
# ====================================
- rule: XXE DOCTYPE Entity Injection Attempt
  desc: Detects XXE attacks via DOCTYPE with ENTITY declarations
  condition: >-
    (
      nginx.request_uri icontains "<!DOCTYPE" or
      nginx.request_uri contains "%3C!DOCTYPE" or
      nginx.request_uri contains "%3c!DOCTYPE" or
      nginx.request_uri icontains "<!ENTITY" or
      nginx.request_uri contains "%3C!ENTITY" or
      nginx.request_uri contains "%3c!ENTITY" or
      nginx.request_uri contains "%3C%21ENTITY" or
      nginx.request_uri contains "%3c%21ENTITY"
    )
  output: "[NGINX XXE Attack] DOCTYPE/ENTITY injection test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, xxe_attack, entity_injection, phase4]
  source: nginx

# ====================================
# XXE_ATK_002: XXE External Resource Access
# ====================================
- rule: XXE External Resource Access Attempt
  desc: Detects XXE attacks attempting to access external resources
  condition: >-
    (
      (nginx.request_uri icontains "SYSTEM" and nginx.request_uri icontains "file://") or
      (nginx.request_uri icontains "SYSTEM" and nginx.request_uri contains "file%3A%2F%2F") or
      nginx.request_uri icontains "expect://" or
      nginx.request_uri contains "expect%3A%2F%2F" or
      nginx.request_uri icontains "php://filter" or
      nginx.request_uri contains "php%3A%2F%2Ffilter" or
      nginx.request_uri icontains "php://input" or
      nginx.request_uri contains "php%3A%2F%2Finput" or
      nginx.request_uri icontains "jar%3Ahttp" or
      nginx.request_uri icontains "jar:http" or
      nginx.request_uri icontains "netdoc%3A%2F%2F" or
      nginx.request_uri icontains "netdoc://"
    )
  output: "[NGINX XXE Attack] External resource access attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, xxe_attack, external_resource, phase4]
  source: nginx

# ====================================
# XXE_ATK_003: XXE Data URI Scheme
# ====================================
- rule: XXE Data URI Scheme Injection
  desc: Detects XXE attacks using data URI scheme
  condition: >-
    (
      (nginx.request_uri icontains "SYSTEM" and nginx.request_uri contains "data:text/") or
      (nginx.request_uri icontains "SYSTEM" and nginx.request_uri contains "data%3Atext%2F") or
      (nginx.request_uri icontains "ENTITY" and nginx.request_uri contains "base64")
    )
  output: "[NGINX XXE Attack] Data URI scheme injection test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: WARNING
  tags: [security, xxe_attack, data_uri, phase4]
  source: nginx

# =========================================================================
# GRAPHQL INJECTION DETECTION RULES (Issue #780 Phase 4)
# =========================================================================
# Pattern #A308: GraphQL Injection Detection
# Detects GraphQL-specific attack patterns including:
# - Introspection queries (__schema, __type)
# - Mass data extraction attempts
# - SQL injection via GraphQL arguments
# Test patterns: GQL_INTRO_001-003, GQL_DATA_001, GQL_SQLI_001

# ====================================
# GQL_ATK_001: GraphQL Introspection Attack
# ====================================
- rule: GraphQL Introspection Attack Attempt
  desc: Detects GraphQL introspection queries for schema enumeration
  condition: >-
    (
      nginx.request_uri contains "__schema" or
      nginx.request_uri contains "__type" or
      nginx.request_uri contains "%5F%5Fschema" or
      nginx.request_uri contains "%5F%5Ftype" or
      nginx.request_uri contains "__typename" or
      nginx.request_uri contains "%5F%5Ftypename"
    )
  output: "[NGINX GraphQL Attack] Introspection query detected test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: WARNING
  tags: [security, graphql_injection, introspection, phase4]
  source: nginx

# ====================================
# GQL_ATK_002: GraphQL Mass Data Extraction
# ====================================
- rule: GraphQL Mass Data Extraction Attempt
  desc: Detects GraphQL queries attempting mass data extraction
  condition: >-
    (
      (nginx.request_uri icontains "first:" and nginx.request_uri contains "999") or
      (nginx.request_uri icontains "first%3A" and nginx.request_uri contains "999") or
      (nginx.request_uri icontains "limit:" and nginx.request_uri contains "999") or
      (nginx.request_uri icontains "limit%3A" and nginx.request_uri contains "999") or
      (nginx.request_uri contains "{users" and nginx.request_uri icontains "password") or
      (nginx.request_uri contains "%7Busers" and nginx.request_uri icontains "password")
    )
  output: "[NGINX GraphQL Attack] Mass data extraction attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: WARNING
  tags: [security, graphql_injection, data_extraction, phase4]
  source: nginx

# ====================================
# GQL_ATK_003: GraphQL SQL Injection
# ====================================
- rule: GraphQL SQL Injection Attempt
  desc: Detects SQL injection attempts within GraphQL queries
  condition: >-
    (
      (nginx.request_uri icontains "query{" and nginx.request_uri icontains "union select") or
      (nginx.request_uri icontains "query%7B" and nginx.request_uri icontains "union select") or
      (nginx.request_uri icontains "mutation{" and nginx.request_uri icontains "union select") or
      (nginx.request_uri icontains "mutation%7B" and nginx.request_uri icontains "union select") or
      (nginx.request_uri contains "query{" and nginx.request_uri contains "'--") or
      (nginx.request_uri contains "query%7B" and nginx.request_uri contains "'--")
    )
  output: "[NGINX GraphQL Attack] SQL injection in GraphQL test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, graphql_injection, sqli, phase4]
  source: nginx

# ==============================================================================
# Phase 3 New Rules: XPath, SSTI, NoSQL Extended (Issue #783)
# ==============================================================================

# ====================================
# XPATH_001-005: XPath Injection Detection
# ====================================
- rule: XPath Injection Attempt
  desc: Detects XPath injection attempts in HTTP requests
  condition: >-
    (
      nginx.request_uri icontains "%27%20or%20" or
      nginx.request_uri icontains "%27%20and%20" or
      nginx.request_uri icontains "%27%29%20or%20" or
      nginx.request_uri icontains "count%28%2F%2F" or
      nginx.request_uri icontains "substring%28%2F%2F" or
      nginx.request_uri icontains "string-length%28%2F%2F"
    )
  output: "[NGINX XPath Injection] XPath injection attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: WARNING
  tags: [security, xpath_injection, injection, phase3]
  source: nginx

# ==============================================================================
# Phase 4 New Rules: API Security (Issue #785)
# ==============================================================================

# ====================================
# API_ATK_001: API Security Attack Attempt
# ====================================
# Detects API security vulnerabilities including:
# - BOLA (Broken Object Level Authorization)
# - JWT Algorithm None attack
# - Mass Assignment
# - Prototype Pollution
# - IDOR (Insecure Direct Object Reference)

- rule: API Security Attack Attempt
  desc: Detects API security vulnerabilities including BOLA, JWT attacks, Mass Assignment, and Prototype Pollution
  condition: >-
    (
      nginx.request_uri contains "eyJhbGciOiJub25lIi" or
      nginx.request_uri contains "__proto__" or
      nginx.request_uri contains "%5F%5Fproto%5F%5F" or
      nginx.request_uri contains "isAdmin" or
      nginx.request_uri contains "%22isAdmin%22" or
      nginx.request_uri contains "\"role\":\"admin\"" or
      nginx.request_uri contains "%22role%22%3A%22admin%22" or
      (nginx.request_uri contains "/api/" and nginx.request_uri contains "/users/" and nginx.request_uri contains "/profile") or
      (nginx.request_uri contains "%2Fapi%2F" and nginx.request_uri contains "%2Fusers%2F" and nginx.request_uri contains "%2Fprofile") or
      (nginx.request_uri contains "/api/" and nginx.request_uri contains "/orders/" and nginx.request_uri contains "/invoice") or
      (nginx.request_uri contains "%2Fapi%2F" and nginx.request_uri contains "%2Forders%2F" and nginx.request_uri contains "%2Finvoice")
    )
  output: "[NGINX API Attack] API security vulnerability detected test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: WARNING
  tags: [security, api_security, bola, jwt, mass_assignment, prototype_pollution, phase4]
  source: nginx
  exceptions:
    - name: phase7_prototype_pollution_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - PP_BASIC_001
        - PP_BASIC_002
        - PP_BASIC_003
        - PP_CONSTR_002
        - PP_NESTED_001
        - PP_NESTED_002
        - PP_JSON_001
        - PP_BYPASS_001
        - PP_BYPASS_002
    # Phase 9: New PP patterns - should be caught by PP-specific rule
    - name: phase9_pp_patterns
      fields: nginx.pattern_id
      comps: in
      values:
        - PP_DOT_001
        - PP_BRACKET_001
        - PP_ENC_001
        - PP_NESTED_003
        - PP_PROTO_001

# ==============================================================================
# Phase 5 New Rules: Pickle Deserialization (Issue #64)
# ==============================================================================

# ====================================
# PICKLE_ATK_001: Pickle Deserialization Attack Attempt
# ====================================
# Detects Python pickle deserialization attacks including:
# - __reduce__ method exploitation
# - pickle.loads() and cPickle.loads() remote code execution
# - __class__.__mro__ traversal for sandbox escape

- rule: Pickle Deserialization Attack Attempt
  desc: Detects Python pickle deserialization attacks that can lead to Remote Code Execution
  condition: >-
    (
      nginx.request_uri icontains "__reduce__" or
      nginx.request_uri icontains "%5F%5Freduce%5F%5F" or
      nginx.request_uri icontains "pickle.loads" or
      nginx.request_uri icontains "pickle.loads%28" or
      nginx.request_uri icontains "cPickle.loads" or
      nginx.request_uri icontains "cPickle.loads%28" or
      nginx.request_uri icontains "__class__.__mro__" or
      nginx.request_uri icontains "%5F%5Fclass%5F%5F.%5F%5Fmro%5F%5F"
    )
  output: "[NGINX Pickle Attack] Pickle deserialization attack attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, pickle, deserialization, rce, python, phase5]
  source: nginx

# ==============================================================================
# Phase 7 New Rules: Prototype Pollution & HTTP Request Smuggling
# ==============================================================================

# ====================================
# PP_ATK_001: Prototype Pollution Attack Attempt
# ====================================
# Detects JavaScript/Node.js prototype pollution attacks including:
# - __proto__ property injection
# - constructor.prototype manipulation
# - Object.prototype pollution via query string/path
#
# Note: More specific detection than API Security rule for dedicated testing

- rule: Prototype Pollution Attack Attempt
  desc: Detects JavaScript/Node.js prototype pollution attacks targeting object prototype chain
  condition: >-
    (
      nginx.request_uri icontains "__proto__" or
      nginx.request_uri contains "%5F%5Fproto%5F%5F" or
      nginx.request_uri icontains "constructor.prototype" or
      nginx.request_uri contains "constructor%5Bprototype%5D" or
      nginx.request_uri contains "constructor%2Eprototype" or
      nginx.request_uri icontains "__proto__[" or
      nginx.request_uri contains "%5F%5Fproto%5F%5F%5B" or
      nginx.request_uri icontains "prototype][" or
      nginx.request_uri contains "prototype%5D%5B" or
      nginx.request_uri icontains "__proto__.polluted" or
      nginx.request_uri contains "%5F%5Fproto%5F%5F%2Epolluted"
    )
  output: "[NGINX PP] Prototype pollution attack attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: WARNING
  tags: [security, prototype_pollution, javascript, nodejs, phase7]
  source: nginx

# ====================================
# HRS_ATK_001: HTTP Request Smuggling Attempt
# ====================================
# Detects HTTP Request Smuggling attack signatures including:
# - CL.TE (Content-Length / Transfer-Encoding) conflicts
# - TE.CL conflicts
# - Chunked encoding abuse
# - Header injection for smuggling
#
# Note: nginx access log does not include HTTP headers, so detection is
# limited to smuggling signatures in query strings and request paths

- rule: HTTP Request Smuggling Attempt
  desc: Detects HTTP Request Smuggling attack signatures in request
  condition: >-
    (
      nginx.request_uri icontains "Transfer-Encoding" or
      nginx.request_uri contains "Transfer-Encoding%3A" or
      nginx.request_uri contains "Transfer%2DEncoding" or
      nginx.request_uri icontains "Content-Length:" or
      nginx.request_uri contains "Content-Length%3A" or
      nginx.request_uri contains "Content%2DLength" or
      nginx.request_uri contains "chunked" or
      nginx.request_uri contains "0%0D%0A%0D%0A" or
      nginx.request_uri contains "0%0d%0a%0d%0a" or
      nginx.request_uri contains "%0D%0ATransfer-Encoding" or
      nginx.request_uri contains "%0d%0aTransfer-Encoding" or
      nginx.request_uri contains "X-Forwarded-Host%3A" or
      nginx.request_uri contains "X%2DForwarded%2DHost"
    )
  output: "[NGINX HRS] HTTP Request Smuggling attempt test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, http_smuggling, clte, tecl, phase7]
  source: nginx


# ==============================================================================
# SSRF Detection Rules (Phase 8 Stage 1)
# ==============================================================================
#
# Server-Side Request Forgery detection
# Detects attempts to access internal services, cloud metadata,
# and use alternative protocols via URL parameters
#

- rule: SSRF Attack Attempt
  desc: Detects Server-Side Request Forgery attempts targeting cloud metadata, internal services, and alternative protocols
  condition: >-
    (
      nginx.request_uri icontains "169.254.169.254" or
      nginx.request_uri icontains "metadata.google.internal" or
      nginx.request_uri contains "file://" or
      nginx.request_uri contains "file%3A%2F%2F" or
      nginx.request_uri contains "file%3a%2f%2f" or
      nginx.request_uri contains "gopher://" or
      nginx.request_uri contains "gopher%3A%2F%2F" or
      nginx.request_uri contains "gopher%3a%2f%2f" or
      nginx.request_uri contains "dict://" or
      nginx.request_uri contains "dict%3A%2F%2F" or
      nginx.request_uri contains "dict%3a%2f%2f" or
      nginx.request_uri icontains "0x7f000001" or
      nginx.request_uri contains "2130706433" or
      nginx.request_uri contains "http://127.0.0.1" or
      nginx.request_uri contains "http%3A%2F%2F127.0.0.1" or
      nginx.request_uri contains "http%3a%2f%2f127.0.0.1" or
      nginx.request_uri contains "http://localhost" or
      nginx.request_uri contains "http%3A%2F%2Flocalhost" or
      nginx.request_uri contains "http%3a%2f%2flocalhost" or
      nginx.request_uri contains "http://0.0.0.0" or
      nginx.request_uri contains "http%3A%2F%2F0.0.0.0" or
      nginx.request_uri contains "http%3a%2f%2f0.0.0.0" or
      nginx.request_uri contains "[::1]" or
      nginx.request_uri contains "%5B%3A%3A1%5D" or
      nginx.request_uri contains "%5b%3a%3a1%5d" or
      nginx.request_uri contains "0177.0.0.1" or
      nginx.request_uri contains "127.1/" or
      nginx.request_uri contains "127.1%2F" or
      nginx.request_uri contains "127.1%2f" or
      nginx.request_uri contains "tftp://" or
      nginx.request_uri contains "tftp%3A%2F%2F" or
      nginx.request_uri contains "tftp%3a%2f%2f" or
      nginx.request_uri contains "ldap://" or
      nginx.request_uri contains "ldap%3A%2F%2F" or
      nginx.request_uri contains "ldap%3a%2f%2f"
    )
  output: "[NGINX SSRF] SSRF attack attempt detected test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: CRITICAL
  tags: [security, ssrf, owasp_top10, cloud_metadata, phase8]
  source: nginx


# ==============================================================================
# CRLF Injection Detection Rules (Phase 8 Stage 1)
# ==============================================================================
#
# CRLF (Carriage Return Line Feed) Injection detection
# Detects attempts to inject CRLF sequences for header injection,
# log injection, and HTTP response splitting
#

- rule: CRLF Injection Attempt
  desc: Detects CRLF Injection attempts via URL-encoded CR/LF sequences
  condition: >-
    (
      nginx.request_uri contains "%0d%0a" or
      nginx.request_uri contains "%0D%0A" or
      nginx.request_uri contains "%0a" or
      nginx.request_uri contains "%0A" or
      nginx.request_uri contains "%E5%98%8A%E5%98%8D" or
      nginx.request_uri contains "%e5%98%8a%e5%98%8d" or
      nginx.request_uri contains "%250d%250a" or
      nginx.request_uri contains "%250D%250A"
    )
  output: "[NGINX CRLF] CRLF Injection attempt detected test_id=%nginx.test_id pattern_id=%nginx.pattern_id uri=%nginx.request_uri client=%nginx.remote_addr"
  priority: WARNING
  tags: [security, crlf, header_injection, log_injection, phase8]
  source: nginx
